<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Книга-конспект матеріалів">

<title>Від нуля до Python Data Scientist - 18&nbsp; Аналіз продуктових метрик</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sql_analytic.html" rel="prev">
<link href="./cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Пошук не дав результату",
    "search-matching-documents-text": "Результати пошуку",
    "search-copy-link-title": "Скопіюйте посилання для пошуку",
    "search-hide-matches-text": "Приховати додаткові результати",
    "search-more-match-text": "Додатковий результат у цьому документі",
    "search-more-matches-text": "Додаткові результати у цьому документі",
    "search-clear-button-title": "Очистити",
    "search-detached-cancel-button-title": "Скасувати",
    "search-submit-button-title": "Надіслати",
    "search-label": "Пошук"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0C9TJBF3C5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0C9TJBF3C5', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-2.24.1.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>


  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключити бокову панель навігації" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sql.html">SQL</a></li><li class="breadcrumb-item"><a href="./sql_metrics.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Аналіз продуктових метрик</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключити бокову панель навігації" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./cover.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Від нуля до Python Data Scientist</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/Aranaur/py4ds" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Переключити темний режим"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Пошук"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Вступне слово</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Переключити розділ">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Змінні та типи даних</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_list_set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Списки та множини</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_dict.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Словники</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Рядки</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_if.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Умовні конструкції</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_loops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Цикли</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Функції</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Задачі</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_questions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Популярні питання</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Переключити розділ">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Базові запити</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_filter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Фільтрація даних</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_agg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Агрегація даних</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_groupby.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Групування даних</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_subquery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Підзапити</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_join.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Об’єднання таблиць</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_window.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Віконні функції</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_analytic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Практичні задачі</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sql_metrics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Аналіз продуктових метрик</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Quarto</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Зміст</h2>
   
  <ul>
  <li><a href="#виручка" id="toc-виручка" class="nav-link active" data-scroll-target="#виручка"><span class="header-section-number">18.1</span> Виручка</a></li>
  <li><a href="#arpu-arppu-та-aov" id="toc-arpu-arppu-та-aov" class="nav-link" data-scroll-target="#arpu-arppu-та-aov"><span class="header-section-number">18.2</span> ARPU, ARPPU та AOV</a></li>
  <li><a href="#виручка-нових-користувачів" id="toc-виручка-нових-користувачів" class="nav-link" data-scroll-target="#виручка-нових-користувачів"><span class="header-section-number">18.3</span> Виручка нових користувачів</a></li>
  <li><a href="#попит-на-товари" id="toc-попит-на-товари" class="nav-link" data-scroll-target="#попит-на-товари"><span class="header-section-number">18.4</span> Попит на товари</a></li>
  <li><a href="#валовий-прибуток" id="toc-валовий-прибуток" class="nav-link" data-scroll-target="#валовий-прибуток"><span class="header-section-number">18.5</span> Валовий прибуток</a></li>
  <li><a href="#customer-acquisition-cost-cac" id="toc-customer-acquisition-cost-cac" class="nav-link" data-scroll-target="#customer-acquisition-cost-cac"><span class="header-section-number">18.6</span> Customer Acquisition Cost (CAC)</a></li>
  <li><a href="#return-on-investment-roi" id="toc-return-on-investment-roi" class="nav-link" data-scroll-target="#return-on-investment-roi"><span class="header-section-number">18.7</span> Return on Investment (ROI)</a></li>
  <li><a href="#середній-чек" id="toc-середній-чек" class="nav-link" data-scroll-target="#середній-чек"><span class="header-section-number">18.8</span> Середній чек</a></li>
  <li><a href="#retention-rate" id="toc-retention-rate" class="nav-link" data-scroll-target="#retention-rate"><span class="header-section-number">18.9</span> Retention rate</a></li>
  <li><a href="#накопичувальний-arppu" id="toc-накопичувальний-arppu" class="nav-link" data-scroll-target="#накопичувальний-arppu"><span class="header-section-number">18.10</span> Накопичувальний ARPPU</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/Aranaur/py4ds/blob/main/sql_metrics.ipynb" class="toc-action">Редагувати сторінку</a></p><p><a href="https://github.com/Aranaur/py4ds/issues/new" class="toc-action">Повідомити про проблему</a></p><p><a href="https://github.com/Aranaur/py4ds/blob/main/sql_metrics.ipynb" class="toc-action">Переглянути код</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Аналіз продуктових метрик</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>
<p><a href="https://t.me/araprof"><img src="https://img.shields.io/badge/Telegram-2CA5E0?style=for-the-badge&amp;logo=telegram&amp;logoColor=white.png" class="img-fluid" alt="Data Miorsh"></a> <a href="https://www.linkedin.com/in/ihormiroshnychenko/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white.png" class="img-fluid" alt="Ihor Miroshnychenko"></a> <a href="https://www.youtube.com/@datamirosh"><img src="https://img.shields.io/badge/YouTube-FF0000?style=for-the-badge&amp;logo=youtube&amp;logoColor=white.png" class="img-fluid" alt="Youtube"></a> <a href="https://send.monobank.ua/jar/3rgj2uzZTs"><img src="https://img.shields.io/badge/sponsor-30363D?style=for-the-badge&amp;logo=GitHub-Sponsors&amp;logoColor=#white.png" class="img-fluid" alt="Monobank"></a></p>
<p>Минулого разу ми навчилися будувати повноцінні дашборди і представляти результати аналізу у зрозумілій бізнесі формі — це дуже важлива навичка, необхідна будь-якому аналітику.</p>
<p>Цього разу ми трохи докладніше поговоримо про аналіз найважливіших метрик, які дозволяють з різних боків оцінити те, наскільки добре працює наш продукт.</p>
<p>Насправді раніше ми вже рахували окремі показники — наприклад, метрики залучення користувачів <strong>DAU</strong>, <strong>WAU</strong> та <strong>MAU</strong>, кількість замовлень, частку скасованих замовлень тощо. Це дійсно важливі показники, але часто представники бізнесу в першу чергу звертають увагу на більш зрозумілі показники, виражені в грошовій формі. Це можуть бути виручка, витрати чи рентабельність, а також відносні показники на кшталт доходу на одного користувача та середнього чека – все це теж важливо вміти розраховувати, чим ми з вами й займемося.</p>
<p>Крім того, наприкінці ми обговоримо методику розрахунку ще одного важливого показника – <strong>Retention rate</strong>.</p>
<p>На цей раз вам знову буде запропоновано написати кілька SQL-запитів і візуалізувати їх результат за допомогою графіків.</p>
<section id="виручка" class="level2 page-columns page-full" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="виручка"><span class="header-section-number">18.1</span> Виручка</h2>
<p>Почнемо з виручки - найбільш загального показника, який покаже, який дохід приносить наш сервіс.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-01" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.1 </strong></span><br> Для кожного дня в таблиці <code>orders</code> розрахуйте такі показники:</p>
<ol type="1">
<li>Виручку, одержану в цей день.</li>
<li>Сумарний виторг на поточний день.</li>
<li>Приріст виручки, отриманої цього дня, щодо значення виручки за попередній день.</li>
</ol>
<p>Колонки з показниками назвіть відповідно <code>revenue</code>, <code>total_revenue</code>, <code>revenue_change</code>. Колонку з датами назвіть <code>date</code>.</p>
<p>Приріст виручки розрахуйте у відсотках та округліть значення <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зростанням дати.</p>
<p>Поля в результуючій таблиці: <code>date</code>, <code>revenue</code>, <code>total_revenue</code>, <code>revenue_change</code></p>
<p><strong>Пояснення:</strong></p>
<p>Вважатимемо, що оплата за замовлення надходить відразу після його оформлення, тобто випадки, коли замовлення було оформлено в один день, а оплата отримана наступного, виникнути не можуть.</p>
<p>Сумарна виручка на поточний день – це результат складання виручки, отриманої поточного дня, зі значеннями аналогічного показника всіх попередніх днів.</p>
<p>При розрахунку виручки пам’ятайте, що не всі замовлення були сплачені, деякі були скасовані користувачами.</p>
<p>Не забувайте при діленні заздалегідь переводити значення до потрібного типу даних. Пропущені значення приросту для першої дати не заповнюйте - просто залиште поля в цьому рядку порожніми.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання вам знадобиться інформація про замовлення з таблиці <code>orders</code> та ціни на товари з таблиці <code>products</code>. Щоб порахувати виторг для кожного дня, спочатку необхідно порахувати вартість кожного замовлення. Це можна зробити, склавши ціни товарів, що входять на замовлення. Щоб правильно приєднати дані про ціни на товари, списки із вмістом замовлень потрібно попередньо розширити за допомогою функції <code>unnest</code>. Після того як для кожного дня буде порахована сумарна вартість усіх замовлень (виручка), за допомогою віконних функцій можна порахувати суму наростаючим підсумком (загальну виручку) та приріст виручки (різницю між виручкою в поточний день та виручкою в попередній день, поділену на виручку в попередній день).</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="2">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">%%</span>sql</span>
<span id="cb1-2"><a href="#cb1-2"></a>SELECT date,</span>
<span id="cb1-3"><a href="#cb1-3"></a>       revenue,</span>
<span id="cb1-4"><a href="#cb1-4"></a>       <span class="bu">sum</span>(revenue) OVER (ORDER BY date) <span class="im">as</span> total_revenue,</span>
<span id="cb1-5"><a href="#cb1-5"></a>       <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> (revenue <span class="op">-</span> lag(revenue, <span class="dv">1</span>) OVER (ORDER BY date))::decimal <span class="op">/</span> lag(revenue, <span class="dv">1</span>) OVER (ORDER BY date),</span>
<span id="cb1-6"><a href="#cb1-6"></a>             <span class="dv">2</span>) <span class="im">as</span> revenue_change</span>
<span id="cb1-7"><a href="#cb1-7"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb1-8"><a href="#cb1-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb1-9"><a href="#cb1-9"></a>        FROM   (SELECT creation_time,</span>
<span id="cb1-10"><a href="#cb1-10"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb1-11"><a href="#cb1-11"></a>                FROM   orders</span>
<span id="cb1-12"><a href="#cb1-12"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb1-13"><a href="#cb1-13"></a>                                        FROM   user_actions</span>
<span id="cb1-14"><a href="#cb1-14"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb1-15"><a href="#cb1-15"></a>            LEFT JOIN products using (product_id)</span>
<span id="cb1-16"><a href="#cb1-16"></a>        GROUP BY date) t2</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">revenue</th>
<th data-quarto-table-cell-role="th">total_revenue</th>
<th data-quarto-table-cell-role="th">revenue_change</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-24</td>
<td>49924.0</td>
<td>49924.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-25</td>
<td>430860.0</td>
<td>480784.0</td>
<td>763.03</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-26</td>
<td>534766.0</td>
<td>1015550.0</td>
<td>24.12</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-27</td>
<td>817053.0</td>
<td>1832603.0</td>
<td>52.79</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-28</td>
<td>1133370.0</td>
<td>2965973.0</td>
<td>38.71</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2022-08-29</td>
<td>1279891.0</td>
<td>4245864.0</td>
<td>12.93</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2022-08-30</td>
<td>1279377.0</td>
<td>5525241.0</td>
<td>-0.04</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2022-08-31</td>
<td>1312720.0</td>
<td>6837961.0</td>
<td>2.61</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2022-09-01</td>
<td>1406101.0</td>
<td>8244062.0</td>
<td>7.11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2022-09-02</td>
<td>1907107.0</td>
<td>10151169.0</td>
<td>35.63</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2022-09-03</td>
<td>2210988.0</td>
<td>12362157.0</td>
<td>15.93</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2022-09-04</td>
<td>2294009.0</td>
<td>14656166.0</td>
<td>3.75</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2022-09-05</td>
<td>1784690.0</td>
<td>16440856.0</td>
<td>-22.20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2022-09-06</td>
<td>1330931.0</td>
<td>17771787.0</td>
<td>-25.43</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2022-09-07</td>
<td>1807800.0</td>
<td>19579587.0</td>
<td>35.83</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2022-09-08</td>
<td>2099508.0</td>
<td>21679095.0</td>
<td>16.14</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Запишемо результат запиту у змінну <code>results_1</code>.</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">%%</span>sql</span>
<span id="cb2-2"><a href="#cb2-2"></a>results_1 <span class="op">&lt;&lt;</span> SELECT date,</span>
<span id="cb2-3"><a href="#cb2-3"></a>       revenue,</span>
<span id="cb2-4"><a href="#cb2-4"></a>       <span class="bu">sum</span>(revenue) OVER (ORDER BY date) <span class="im">as</span> total_revenue,</span>
<span id="cb2-5"><a href="#cb2-5"></a>       <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> (revenue <span class="op">-</span> lag(revenue, <span class="dv">1</span>) OVER (ORDER BY date))::decimal <span class="op">/</span> lag(revenue, <span class="dv">1</span>) OVER (ORDER BY date),</span>
<span id="cb2-6"><a href="#cb2-6"></a>             <span class="dv">2</span>) <span class="im">as</span> revenue_change</span>
<span id="cb2-7"><a href="#cb2-7"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb2-8"><a href="#cb2-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb2-9"><a href="#cb2-9"></a>        FROM   (SELECT creation_time,</span>
<span id="cb2-10"><a href="#cb2-10"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb2-11"><a href="#cb2-11"></a>                FROM   orders</span>
<span id="cb2-12"><a href="#cb2-12"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb2-13"><a href="#cb2-13"></a>                                        FROM   user_actions</span>
<span id="cb2-14"><a href="#cb2-14"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb2-15"><a href="#cb2-15"></a>            LEFT JOIN products using (product_id)</span>
<span id="cb2-16"><a href="#cb2-16"></a>        GROUP BY date) t2</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Побудуємо візуалізацію за отриманими даними:</p>
<div class="page-columns page-full">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>fig <span class="op">=</span> make_subplots(specs<span class="op">=</span>[[{<span class="st">"secondary_y"</span>: <span class="va">True</span>}]])</span>
<span id="cb3-6"><a href="#cb3-6"></a>fig.add_trace(</span>
<span id="cb3-7"><a href="#cb3-7"></a>    go.Bar(</span>
<span id="cb3-8"><a href="#cb3-8"></a>        name<span class="op">=</span><span class="st">"revenue_change"</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>        x<span class="op">=</span>results_1.date,</span>
<span id="cb3-10"><a href="#cb3-10"></a>        y<span class="op">=</span>results_1.revenue_change,</span>
<span id="cb3-11"><a href="#cb3-11"></a>        offsetgroup<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>    ),</span>
<span id="cb3-13"><a href="#cb3-13"></a>    secondary_y<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb3-14"><a href="#cb3-14"></a>)</span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a>fig.add_trace(</span>
<span id="cb3-17"><a href="#cb3-17"></a>    go.Scatter(name<span class="op">=</span><span class="st">"revenue"</span>, x<span class="op">=</span>results_1.date, y<span class="op">=</span>results_1.revenue, offsetgroup<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb3-18"><a href="#cb3-18"></a>    secondary_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-19"><a href="#cb3-19"></a>)</span>
<span id="cb3-20"><a href="#cb3-20"></a>fig.update_yaxes(rangemode<span class="op">=</span><span class="st">"tozero"</span>, secondary_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-21"><a href="#cb3-21"></a>fig.update_layout(</span>
<span id="cb3-22"><a href="#cb3-22"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb3-23"><a href="#cb3-23"></a>)</span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a>fig.show()</span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb3-28"><a href="#cb3-28"></a>fig.add_trace(</span>
<span id="cb3-29"><a href="#cb3-29"></a>    go.Scatter(</span>
<span id="cb3-30"><a href="#cb3-30"></a>        x<span class="op">=</span>results_1.date,</span>
<span id="cb3-31"><a href="#cb3-31"></a>        y<span class="op">=</span>results_1.total_revenue,</span>
<span id="cb3-32"><a href="#cb3-32"></a>        mode<span class="op">=</span><span class="st">"lines+markers"</span>,</span>
<span id="cb3-33"><a href="#cb3-33"></a>        name<span class="op">=</span><span class="st">"total_revenue"</span>,</span>
<span id="cb3-34"><a href="#cb3-34"></a>    )</span>
<span id="cb3-35"><a href="#cb3-35"></a>)</span>
<span id="cb3-36"><a href="#cb3-36"></a>fig.update_layout(</span>
<span id="cb3-37"><a href="#cb3-37"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-38"><a href="#cb3-38"></a>)</span>
<span id="cb3-39"><a href="#cb3-39"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-01" class="cell column-screen-inset-shaded quarto-layout-panel" data-execution_count="4">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="fig-sql-metrics-01-1" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="098fc4cb-62ab-413f-9e31-80fed8cf3dfe" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("098fc4cb-62ab-413f-9e31-80fed8cf3dfe")) {                    Plotly.newPlot(                        "098fc4cb-62ab-413f-9e31-80fed8cf3dfe",                        [{"name":"revenue_change","offsetgroup":"1","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[null,763.03,24.12,52.79,38.71,12.93,-0.04,2.61,7.11,35.63,15.93,3.75,-22.2,-25.43,35.83,16.14],"type":"bar","xaxis":"x","yaxis":"y"},{"name":"revenue","offsetgroup":"2","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[49924.0,430860.0,534766.0,817053.0,1133370.0,1279891.0,1279377.0,1312720.0,1406101.0,1907107.0,2210988.0,2294009.0,1784690.0,1330931.0,1807800.0,2099508.0],"type":"scatter","xaxis":"x","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.94]},"yaxis":{"anchor":"x","domain":[0.0,1.0]},"yaxis2":{"anchor":"x","overlaying":"y","side":"right","rangemode":"tozero"},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('098fc4cb-62ab-413f-9e31-80fed8cf3dfe');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(a) Динаміка щоденної виручки</figcaption>
</figure>
</div>
<div id="fig-sql-metrics-01-2" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="9958e444-4ffe-4083-9f12-dfe3bd5782b4" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("9958e444-4ffe-4083-9f12-dfe3bd5782b4")) {                    Plotly.newPlot(                        "9958e444-4ffe-4083-9f12-dfe3bd5782b4",                        [{"mode":"lines+markers","name":"total_revenue","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[49924.0,480784.0,1015550.0,1832603.0,2965973.0,4245864.0,5525241.0,6837961.0,8244062.0,10151169.0,12362157.0,14656166.0,16440856.0,17771787.0,19579587.0,21679095.0],"type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('9958e444-4ffe-4083-9f12-dfe3bd5782b4');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(b) Динаміка загальної виручки</figcaption>
</figure>
</div>
</div>
<p></p><figcaption class="figure-caption">Рисунок&nbsp;18.1: Графік за результатами SQL-запиту</figcaption><p></p>
</figure>
</div>
</div>
<p>Проаналізуйте побудовані графіки та спробуйте відповісти на такі питання:</p>
<ol type="1">
<li>Які дні спостерігалося помітне зниження щоденної виручки?</li>
<li>Із чим це могло бути пов’язане?</li>
</ol>
</section>
<section id="arpu-arppu-та-aov" class="level2" data-number="18.2">
<h2 data-number="18.2" class="anchored" data-anchor-id="arpu-arppu-та-aov"><span class="header-section-number">18.2</span> ARPU, ARPPU та AOV</h2>
<p>Тепер на основі даних про виторг розрахуємо кілька відносних показників, які покажуть, скільки в середньому споживачі готові платити за послуги нашого сервісу доставки. Зупинимося на наступних метриках:</p>
<ol type="1">
<li><strong>ARPU (Average Revenue Per User)</strong> - середня виручка на одного користувача за певний період.</li>
<li><strong>ARPPU (Average Revenue Per Paying User)</strong> - середня виручка на одного користувача, що оплачує замовлення за певний період.</li>
<li><strong>AOV (Average Order Value)</strong> - середній чек або відношення виручки за певний період до загальної кількості замовлень за цей час.</li>
</ol>
<p>Якщо за період, що розглядається, сервіс заробив 100 000 грошових одиниць і при цьому ним користувалися 500 унікальних користувачів, з яких 400 зробили загалом 650 замовлень, тоді метрики будуть мати наступні значення:</p>
<p><span class="math display">\[ARPU = 100000/500 = 200\]</span></p>
<p><span class="math display">\[ARPPU = 100 000/400 = 250\]</span></p>
<p><span class="math display">\[AOV=100000/650≈153,85\]</span></p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-02" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.2 </strong></span><br> Для кожного дня в таблицях <code>orders</code> та <code>user_actions</code> розрахуйте такі показники:</p>
<ol type="1">
<li>Виручку користувача (<strong>ARPU</strong>) за поточний день.</li>
<li>Виручку на користувача, що платить (<strong>ARPPU</strong>) за поточний день.</li>
<li>Виручку із замовлення, або середній чек (<strong>AOV</strong>) за поточний день.</li>
</ol>
<p>Колонки з показниками назвіть відповідно <code>arpu</code>, <code>arppu</code>, <code>aov</code>. Колонку з датами назвіть <code>date</code>.</p>
<p>Під час розрахунку всіх показників округляйте значення <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зростанням дати.</p>
<p>Поля в результуючій таблиці: <code>date</code>, <code>arpu</code>, <code>arppu</code>, <code>aov</code></p>
<p><strong>Пояснення:</strong></p>
<p>Вважатимемо, що оплата за замовлення надходить відразу після його оформлення, тобто випадки, коли замовлення було оформлено в один день, а оплата отримана наступного, виникнути не можуть.</p>
<p>Користувачами, що оплатили замовлення будемо вважати тих, які в даний день оформили хоча б одне замовлення, яке надалі не було скасовано.</p>
<p>При розрахунку виручки пам’ятайте, що не всі замовлення були сплачені, деякі були скасовані користувачами.</p>
<p>Не забувайте при діленні заздалегідь приводити значення до потрібного типу даних.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання необхідно спочатку для кожного дня порахувати виручку, кількість всіх користувачів, кількість користувачів, що сплатили замовлення і кількість замовлень. Потім необхідно об’єднати отримані таблиці та розрахувати всі необхідні відносні показники. Виручку ми вже рахували у минулому завданні.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="op">%%</span>sql</span>
<span id="cb4-2"><a href="#cb4-2"></a>SELECT date,</span>
<span id="cb4-3"><a href="#cb4-3"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> users, <span class="dv">2</span>) <span class="im">as</span> arpu,</span>
<span id="cb4-4"><a href="#cb4-4"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> paying_users, <span class="dv">2</span>) <span class="im">as</span> arppu,</span>
<span id="cb4-5"><a href="#cb4-5"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> orders, <span class="dv">2</span>) <span class="im">as</span> aov</span>
<span id="cb4-6"><a href="#cb4-6"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb4-7"><a href="#cb4-7"></a>               count(distinct order_id) <span class="im">as</span> orders,</span>
<span id="cb4-8"><a href="#cb4-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb4-9"><a href="#cb4-9"></a>        FROM   (SELECT order_id,</span>
<span id="cb4-10"><a href="#cb4-10"></a>                       creation_time,</span>
<span id="cb4-11"><a href="#cb4-11"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb4-12"><a href="#cb4-12"></a>                FROM   orders</span>
<span id="cb4-13"><a href="#cb4-13"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb4-14"><a href="#cb4-14"></a>                                        FROM   user_actions</span>
<span id="cb4-15"><a href="#cb4-15"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb4-16"><a href="#cb4-16"></a>            LEFT JOIN products using(product_id)</span>
<span id="cb4-17"><a href="#cb4-17"></a>        GROUP BY date) t2</span>
<span id="cb4-18"><a href="#cb4-18"></a>    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb4-19"><a href="#cb4-19"></a>                      count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb4-20"><a href="#cb4-20"></a>               FROM   user_actions</span>
<span id="cb4-21"><a href="#cb4-21"></a>               GROUP BY date) t3 using (date)</span>
<span id="cb4-22"><a href="#cb4-22"></a>    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb4-23"><a href="#cb4-23"></a>                      count(distinct user_id) <span class="im">as</span> paying_users</span>
<span id="cb4-24"><a href="#cb4-24"></a>               FROM   user_actions</span>
<span id="cb4-25"><a href="#cb4-25"></a>               WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb4-26"><a href="#cb4-26"></a>                                       FROM   user_actions</span>
<span id="cb4-27"><a href="#cb4-27"></a>                                       WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb4-28"><a href="#cb4-28"></a>               GROUP BY date) t4 using (date)</span>
<span id="cb4-29"><a href="#cb4-29"></a>ORDER BY date</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">arpu</th>
<th data-quarto-table-cell-role="th">arppu</th>
<th data-quarto-table-cell-role="th">aov</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-24</td>
<td>372.57</td>
<td>393.10</td>
<td>361.77</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-25</td>
<td>508.09</td>
<td>525.44</td>
<td>406.86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-26</td>
<td>452.04</td>
<td>470.33</td>
<td>369.57</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-27</td>
<td>509.38</td>
<td>527.81</td>
<td>381.62</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-28</td>
<td>528.38</td>
<td>544.10</td>
<td>378.04</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2022-08-29</td>
<td>559.15</td>
<td>581.24</td>
<td>391.76</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2022-08-30</td>
<td>546.74</td>
<td>567.85</td>
<td>379.52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2022-08-31</td>
<td>517.63</td>
<td>540.21</td>
<td>384.96</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2022-09-01</td>
<td>499.33</td>
<td>518.86</td>
<td>381.26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2022-09-02</td>
<td>537.67</td>
<td>556.17</td>
<td>381.35</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2022-09-03</td>
<td>565.90</td>
<td>582.76</td>
<td>387.28</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2022-09-04</td>
<td>541.55</td>
<td>558.97</td>
<td>381.70</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2022-09-05</td>
<td>512.84</td>
<td>530.84</td>
<td>381.75</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2022-09-06</td>
<td>475.33</td>
<td>492.75</td>
<td>385.67</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2022-09-07</td>
<td>496.65</td>
<td>514.02</td>
<td>378.44</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2022-09-08</td>
<td>521.10</td>
<td>536.68</td>
<td>383.54</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_2</code>.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="op">%%</span>sql</span>
<span id="cb5-2"><a href="#cb5-2"></a>results_2 <span class="op">&lt;&lt;</span> SELECT date,</span>
<span id="cb5-3"><a href="#cb5-3"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> users, <span class="dv">2</span>) <span class="im">as</span> arpu,</span>
<span id="cb5-4"><a href="#cb5-4"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> paying_users, <span class="dv">2</span>) <span class="im">as</span> arppu,</span>
<span id="cb5-5"><a href="#cb5-5"></a>       <span class="bu">round</span>(revenue::decimal <span class="op">/</span> orders, <span class="dv">2</span>) <span class="im">as</span> aov</span>
<span id="cb5-6"><a href="#cb5-6"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb5-7"><a href="#cb5-7"></a>               count(distinct order_id) <span class="im">as</span> orders,</span>
<span id="cb5-8"><a href="#cb5-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb5-9"><a href="#cb5-9"></a>        FROM   (SELECT order_id,</span>
<span id="cb5-10"><a href="#cb5-10"></a>                       creation_time,</span>
<span id="cb5-11"><a href="#cb5-11"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb5-12"><a href="#cb5-12"></a>                FROM   orders</span>
<span id="cb5-13"><a href="#cb5-13"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb5-14"><a href="#cb5-14"></a>                                        FROM   user_actions</span>
<span id="cb5-15"><a href="#cb5-15"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb5-16"><a href="#cb5-16"></a>            LEFT JOIN products using(product_id)</span>
<span id="cb5-17"><a href="#cb5-17"></a>        GROUP BY date) t2</span>
<span id="cb5-18"><a href="#cb5-18"></a>    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb5-19"><a href="#cb5-19"></a>                      count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb5-20"><a href="#cb5-20"></a>               FROM   user_actions</span>
<span id="cb5-21"><a href="#cb5-21"></a>               GROUP BY date) t3 using (date)</span>
<span id="cb5-22"><a href="#cb5-22"></a>    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb5-23"><a href="#cb5-23"></a>                      count(distinct user_id) <span class="im">as</span> paying_users</span>
<span id="cb5-24"><a href="#cb5-24"></a>               FROM   user_actions</span>
<span id="cb5-25"><a href="#cb5-25"></a>               WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb5-26"><a href="#cb5-26"></a>                                       FROM   user_actions</span>
<span id="cb5-27"><a href="#cb5-27"></a>                                       WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb5-28"><a href="#cb5-28"></a>               GROUP BY date) t4 using (date)</span>
<span id="cb5-29"><a href="#cb5-29"></a>ORDER BY date</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>traces <span class="op">=</span> [(<span class="st">"arpu"</span>, results_2.arpu), (<span class="st">"arppu"</span>, results_2.arppu), (<span class="st">"aov"</span>, results_2.aov)]</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="cf">for</span> trace_name, trace_values <span class="kw">in</span> traces:</span>
<span id="cb6-8"><a href="#cb6-8"></a>    fig.add_trace(</span>
<span id="cb6-9"><a href="#cb6-9"></a>        go.Scatter(</span>
<span id="cb6-10"><a href="#cb6-10"></a>            x<span class="op">=</span>results_2.date, y<span class="op">=</span>trace_values, mode<span class="op">=</span><span class="st">"lines+markers"</span>, name<span class="op">=</span>trace_name</span>
<span id="cb6-11"><a href="#cb6-11"></a>        )</span>
<span id="cb6-12"><a href="#cb6-12"></a>    )</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a>fig.update_layout(</span>
<span id="cb6-15"><a href="#cb6-15"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-16"><a href="#cb6-16"></a>)</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-analytic-02" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="80f87afe-809a-4bd2-88d4-440165693b7a" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("80f87afe-809a-4bd2-88d4-440165693b7a")) {                    Plotly.newPlot(                        "80f87afe-809a-4bd2-88d4-440165693b7a",                        [{"mode":"lines+markers","name":"arpu","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[372.57,508.09,452.04,509.38,528.38,559.15,546.74,517.63,499.33,537.67,565.9,541.55,512.84,475.33,496.65,521.1],"type":"scatter"},{"mode":"lines+markers","name":"arppu","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[393.1,525.44,470.33,527.81,544.1,581.24,567.85,540.21,518.86,556.17,582.76,558.97,530.84,492.75,514.02,536.68],"type":"scatter"},{"mode":"lines+markers","name":"aov","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[361.77,406.86,369.57,381.62,378.04,391.76,379.52,384.96,381.26,381.35,387.28,381.7,381.75,385.67,378.44,383.54],"type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('80f87afe-809a-4bd2-88d4-440165693b7a');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.2: Динаміка ARPU, ARPPU та AOV</figcaption>
</figure>
</div>
</div>
<p>Проаналізуйте побудований графік та спробуйте відповісти на такі питання:</p>
<ol type="1">
<li>Які метрики мають більший розкид значень протягом періоду, що розглядається?</li>
<li>Чи можна сказати, що окремі метрики мають аномально високі чи аномально низькі значення окремими днями?</li>
<li>Який висновок можна зробити про співвідношення числа користувачів, що платять, і всіх користувачів сервісу в розглянуті дні?</li>
</ol>
<p>Доповнимо наш аналіз ще більш цікавими розрахунками — обчислимо ті самі метрики, але для кожного дня враховуватимемо накопичену виручку і всі наявні на даний момент дані про кількість користувачів і замовлень. Таким чином, отримаємо <strong>динамічний ARPU, ARPPU і AOV</strong> і зможемо простежити, як він змінювався протягом часу з урахуванням даних, що надходять нам.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-03" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.3 </strong></span><br> За таблицями <code>orders</code> та <code>user_actions</code> для кожного дня розрахуйте такі показники:</p>
<ol type="1">
<li>Накопичений виторг на користувача (<strong>Running ARPU</strong>).</li>
<li>Нагромаджений виторг на платить користувача (<strong>Running ARPPU</strong>).</li>
<li>Накопичений виторг із замовлення, або середній чек (<strong>Running AOV</strong>).</li>
</ol>
<p>Колонки з показниками назвіть <code>running_arpu</code>, <code>running_arppu</code>, <code>running_aov</code>. Колонку з датами назвіть <code>date</code>.</p>
<p>Під час розрахунку всіх показників округляйте значення <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зростанням дати.</p>
<p>Поля в результуючій таблиці: <code>date</code>, <code>running_arpu</code>, <code>running_arppu</code>, <code>running_aov</code></p>
<p><strong>Пояснення:</strong></p>
<p>При розрахунку числа користувачів та користувачів, що оплатили замовлення на поточну дату, враховуйте відповідних користувачів за всі попередні дні, включаючи поточний.</p>
<p>Користувачами, що оплатили замовлення вважатимемо тих, які на поточний день оформили хоча б одне замовлення, яке надалі не було скасовано.</p>
<p>Вважатимемо, що оплата за замовлення надходить відразу після його оформлення, тобто. Випадки, коли замовлення було оформлено в один день, а оплата отримана наступного, виникнути не можуть.</p>
<p>При розрахунку виручки пам’ятайте, що не всі замовлення були сплачені, деякі були скасовані користувачами.</p>
<p>Не забувайте при діленні заздалегідь приводити значення до потрібного типу даних.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення цього завдання необхідно доповнити запит з попереднього завдання та для кожного дня додатково розрахувати накопичений виторг, а також накопичену кількість усіх користувачів та оркмо користувачів, які оплатили замовлення. Для розрахунку кількості користувачів з накопиченням буде потрібна інформація про нових користувачів і нових користувачів, які оплатили замовлення у кожен із розглянутих днів.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="8">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">%%</span>sql</span>
<span id="cb7-2"><a href="#cb7-2"></a>SELECT date, </span>
<span id="cb7-3"><a href="#cb7-3"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(new_users) OVER (ORDER BY date), <span class="dv">2</span>) AS running_arpu, </span>
<span id="cb7-4"><a href="#cb7-4"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(new_paying_users) OVER (ORDER BY date), <span class="dv">2</span>) AS running_arppu, </span>
<span id="cb7-5"><a href="#cb7-5"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(orders) OVER (ORDER BY date), <span class="dv">2</span>) AS running_aov </span>
<span id="cb7-6"><a href="#cb7-6"></a>    FROM ( </span>
<span id="cb7-7"><a href="#cb7-7"></a>        SELECT creation_time::date AS date,  </span>
<span id="cb7-8"><a href="#cb7-8"></a>                COUNT(DISTINCT order_id) AS orders,  </span>
<span id="cb7-9"><a href="#cb7-9"></a>                SUM(price) AS revenue </span>
<span id="cb7-10"><a href="#cb7-10"></a>        FROM ( </span>
<span id="cb7-11"><a href="#cb7-11"></a>            SELECT order_id, </span>
<span id="cb7-12"><a href="#cb7-12"></a>                creation_time, </span>
<span id="cb7-13"><a href="#cb7-13"></a>                UNNEST(product_ids) AS product_id </span>
<span id="cb7-14"><a href="#cb7-14"></a>            FROM orders </span>
<span id="cb7-15"><a href="#cb7-15"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb7-16"><a href="#cb7-16"></a>            ) t1 </span>
<span id="cb7-17"><a href="#cb7-17"></a>        LEFT JOIN products  </span>
<span id="cb7-18"><a href="#cb7-18"></a>        USING(product_id) </span>
<span id="cb7-19"><a href="#cb7-19"></a>        GROUP BY date </span>
<span id="cb7-20"><a href="#cb7-20"></a>    ) t2 </span>
<span id="cb7-21"><a href="#cb7-21"></a>    LEFT JOIN ( </span>
<span id="cb7-22"><a href="#cb7-22"></a>        SELECT time::date AS date, COUNT(DISTINCT user_id) AS users </span>
<span id="cb7-23"><a href="#cb7-23"></a>        FROM user_actions </span>
<span id="cb7-24"><a href="#cb7-24"></a>        GROUP BY date </span>
<span id="cb7-25"><a href="#cb7-25"></a>    ) t3 </span>
<span id="cb7-26"><a href="#cb7-26"></a>    USING (date) </span>
<span id="cb7-27"><a href="#cb7-27"></a>    LEFT JOIN ( </span>
<span id="cb7-28"><a href="#cb7-28"></a>        SELECT time::date AS date, COUNT(DISTINCT user_id) AS paying_users </span>
<span id="cb7-29"><a href="#cb7-29"></a>        FROM user_actions </span>
<span id="cb7-30"><a href="#cb7-30"></a>        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb7-31"><a href="#cb7-31"></a>        GROUP BY date </span>
<span id="cb7-32"><a href="#cb7-32"></a>    ) t4 </span>
<span id="cb7-33"><a href="#cb7-33"></a>    USING (date) </span>
<span id="cb7-34"><a href="#cb7-34"></a>    LEFT JOIN ( </span>
<span id="cb7-35"><a href="#cb7-35"></a>        SELECT date, COUNT(user_id) AS new_users </span>
<span id="cb7-36"><a href="#cb7-36"></a>        FROM ( </span>
<span id="cb7-37"><a href="#cb7-37"></a>            SELECT user_id, MIN(time::date) AS date </span>
<span id="cb7-38"><a href="#cb7-38"></a>            FROM user_actions </span>
<span id="cb7-39"><a href="#cb7-39"></a>            GROUP BY user_id </span>
<span id="cb7-40"><a href="#cb7-40"></a>        ) t5 </span>
<span id="cb7-41"><a href="#cb7-41"></a>        GROUP BY date </span>
<span id="cb7-42"><a href="#cb7-42"></a>    ) t6 </span>
<span id="cb7-43"><a href="#cb7-43"></a>    USING (date) </span>
<span id="cb7-44"><a href="#cb7-44"></a>    LEFT JOIN ( </span>
<span id="cb7-45"><a href="#cb7-45"></a>        SELECT date, COUNT(user_id) AS new_paying_users </span>
<span id="cb7-46"><a href="#cb7-46"></a>        FROM ( </span>
<span id="cb7-47"><a href="#cb7-47"></a>            SELECT user_id, MIN(time::date) AS date </span>
<span id="cb7-48"><a href="#cb7-48"></a>            FROM user_actions </span>
<span id="cb7-49"><a href="#cb7-49"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb7-50"><a href="#cb7-50"></a>            GROUP BY user_id </span>
<span id="cb7-51"><a href="#cb7-51"></a>        ) t7 </span>
<span id="cb7-52"><a href="#cb7-52"></a>        GROUP BY date </span>
<span id="cb7-53"><a href="#cb7-53"></a>    ) t8 </span>
<span id="cb7-54"><a href="#cb7-54"></a>    USING (date)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">running_arpu</th>
<th data-quarto-table-cell-role="th">running_arppu</th>
<th data-quarto-table-cell-role="th">running_aov</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-24</td>
<td>372.57</td>
<td>393.10</td>
<td>361.77</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-25</td>
<td>499.26</td>
<td>517.53</td>
<td>401.66</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-26</td>
<td>512.90</td>
<td>530.87</td>
<td>384.10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-27</td>
<td>571.80</td>
<td>590.21</td>
<td>382.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-28</td>
<td>632.13</td>
<td>649.72</td>
<td>381.08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2022-08-29</td>
<td>707.53</td>
<td>726.29</td>
<td>384.24</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2022-08-30</td>
<td>766.86</td>
<td>786.40</td>
<td>383.14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2022-08-31</td>
<td>792.81</td>
<td>813.46</td>
<td>383.49</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2022-09-01</td>
<td>813.18</td>
<td>832.90</td>
<td>383.11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2022-09-02</td>
<td>844.17</td>
<td>863.05</td>
<td>382.77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2022-09-03</td>
<td>886.24</td>
<td>904.39</td>
<td>383.57</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2022-09-04</td>
<td>921.71</td>
<td>938.78</td>
<td>383.28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2022-09-05</td>
<td>950.45</td>
<td>967.17</td>
<td>383.11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2022-09-06</td>
<td>970.18</td>
<td>986.72</td>
<td>383.30</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2022-09-07</td>
<td>992.38</td>
<td>1007.85</td>
<td>382.85</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2022-09-08</td>
<td>1012.99</td>
<td>1028.03</td>
<td>382.91</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_3</code>:</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="op">%%</span>sql</span>
<span id="cb8-2"><a href="#cb8-2"></a>results_3 <span class="op">&lt;&lt;</span> SELECT date, </span>
<span id="cb8-3"><a href="#cb8-3"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(new_users) OVER (ORDER BY date), <span class="dv">2</span>) AS running_arpu, </span>
<span id="cb8-4"><a href="#cb8-4"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(new_paying_users) OVER (ORDER BY date), <span class="dv">2</span>) AS running_arppu, </span>
<span id="cb8-5"><a href="#cb8-5"></a>        ROUND(SUM(revenue) OVER (ORDER BY date)::decimal <span class="op">/</span> SUM(orders) OVER (ORDER BY date), <span class="dv">2</span>) AS running_aov </span>
<span id="cb8-6"><a href="#cb8-6"></a>    FROM ( </span>
<span id="cb8-7"><a href="#cb8-7"></a>        SELECT creation_time::date AS date,  </span>
<span id="cb8-8"><a href="#cb8-8"></a>                COUNT(DISTINCT order_id) AS orders,  </span>
<span id="cb8-9"><a href="#cb8-9"></a>                SUM(price) AS revenue </span>
<span id="cb8-10"><a href="#cb8-10"></a>        FROM ( </span>
<span id="cb8-11"><a href="#cb8-11"></a>            SELECT order_id, </span>
<span id="cb8-12"><a href="#cb8-12"></a>                creation_time, </span>
<span id="cb8-13"><a href="#cb8-13"></a>                UNNEST(product_ids) AS product_id </span>
<span id="cb8-14"><a href="#cb8-14"></a>            FROM orders </span>
<span id="cb8-15"><a href="#cb8-15"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb8-16"><a href="#cb8-16"></a>            ) t1 </span>
<span id="cb8-17"><a href="#cb8-17"></a>        LEFT JOIN products  </span>
<span id="cb8-18"><a href="#cb8-18"></a>        USING(product_id) </span>
<span id="cb8-19"><a href="#cb8-19"></a>        GROUP BY date </span>
<span id="cb8-20"><a href="#cb8-20"></a>    ) t2 </span>
<span id="cb8-21"><a href="#cb8-21"></a>    LEFT JOIN ( </span>
<span id="cb8-22"><a href="#cb8-22"></a>        SELECT time::date AS date, COUNT(DISTINCT user_id) AS users </span>
<span id="cb8-23"><a href="#cb8-23"></a>        FROM user_actions </span>
<span id="cb8-24"><a href="#cb8-24"></a>        GROUP BY date </span>
<span id="cb8-25"><a href="#cb8-25"></a>    ) t3 </span>
<span id="cb8-26"><a href="#cb8-26"></a>    USING (date) </span>
<span id="cb8-27"><a href="#cb8-27"></a>    LEFT JOIN ( </span>
<span id="cb8-28"><a href="#cb8-28"></a>        SELECT time::date AS date, COUNT(DISTINCT user_id) AS paying_users </span>
<span id="cb8-29"><a href="#cb8-29"></a>        FROM user_actions </span>
<span id="cb8-30"><a href="#cb8-30"></a>        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb8-31"><a href="#cb8-31"></a>        GROUP BY date </span>
<span id="cb8-32"><a href="#cb8-32"></a>    ) t4 </span>
<span id="cb8-33"><a href="#cb8-33"></a>    USING (date) </span>
<span id="cb8-34"><a href="#cb8-34"></a>    LEFT JOIN ( </span>
<span id="cb8-35"><a href="#cb8-35"></a>        SELECT date, COUNT(user_id) AS new_users </span>
<span id="cb8-36"><a href="#cb8-36"></a>        FROM ( </span>
<span id="cb8-37"><a href="#cb8-37"></a>            SELECT user_id, MIN(time::date) AS date </span>
<span id="cb8-38"><a href="#cb8-38"></a>            FROM user_actions </span>
<span id="cb8-39"><a href="#cb8-39"></a>            GROUP BY user_id </span>
<span id="cb8-40"><a href="#cb8-40"></a>        ) t5 </span>
<span id="cb8-41"><a href="#cb8-41"></a>        GROUP BY date </span>
<span id="cb8-42"><a href="#cb8-42"></a>    ) t6 </span>
<span id="cb8-43"><a href="#cb8-43"></a>    USING (date) </span>
<span id="cb8-44"><a href="#cb8-44"></a>    LEFT JOIN ( </span>
<span id="cb8-45"><a href="#cb8-45"></a>        SELECT date, COUNT(user_id) AS new_paying_users </span>
<span id="cb8-46"><a href="#cb8-46"></a>        FROM ( </span>
<span id="cb8-47"><a href="#cb8-47"></a>            SELECT user_id, MIN(time::date) AS date </span>
<span id="cb8-48"><a href="#cb8-48"></a>            FROM user_actions </span>
<span id="cb8-49"><a href="#cb8-49"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb8-50"><a href="#cb8-50"></a>            GROUP BY user_id </span>
<span id="cb8-51"><a href="#cb8-51"></a>        ) t7 </span>
<span id="cb8-52"><a href="#cb8-52"></a>        GROUP BY date </span>
<span id="cb8-53"><a href="#cb8-53"></a>    ) t8 </span>
<span id="cb8-54"><a href="#cb8-54"></a>    USING (date)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>traces <span class="op">=</span> [</span>
<span id="cb9-6"><a href="#cb9-6"></a>    (<span class="st">"running_arpu"</span>, results_3.running_arpu),</span>
<span id="cb9-7"><a href="#cb9-7"></a>    (<span class="st">"running_arppu"</span>, results_3.running_arppu),</span>
<span id="cb9-8"><a href="#cb9-8"></a>    (<span class="st">"running_aov"</span>, results_3.running_aov),</span>
<span id="cb9-9"><a href="#cb9-9"></a>]</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="cf">for</span> trace_name, trace_values <span class="kw">in</span> traces:</span>
<span id="cb9-12"><a href="#cb9-12"></a>    fig.add_trace(</span>
<span id="cb9-13"><a href="#cb9-13"></a>        go.Scatter(</span>
<span id="cb9-14"><a href="#cb9-14"></a>            x<span class="op">=</span>results_3.date, y<span class="op">=</span>trace_values, mode<span class="op">=</span><span class="st">"lines+markers"</span>, name<span class="op">=</span>trace_name</span>
<span id="cb9-15"><a href="#cb9-15"></a>        )</span>
<span id="cb9-16"><a href="#cb9-16"></a>    )</span>
<span id="cb9-17"><a href="#cb9-17"></a></span>
<span id="cb9-18"><a href="#cb9-18"></a>fig.update_layout(</span>
<span id="cb9-19"><a href="#cb9-19"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-20"><a href="#cb9-20"></a>)</span>
<span id="cb9-21"><a href="#cb9-21"></a></span>
<span id="cb9-22"><a href="#cb9-22"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-analytic-03" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="657a9188-08ca-4870-8723-fcf9a6dad5f3" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("657a9188-08ca-4870-8723-fcf9a6dad5f3")) {                    Plotly.newPlot(                        "657a9188-08ca-4870-8723-fcf9a6dad5f3",                        [{"mode":"lines+markers","name":"running_arpu","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[372.57,499.26,512.9,571.8,632.13,707.53,766.86,792.81,813.18,844.17,886.24,921.71,950.45,970.18,992.38,1012.99],"type":"scatter"},{"mode":"lines+markers","name":"running_arppu","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[393.1,517.53,530.87,590.21,649.72,726.29,786.4,813.46,832.9,863.05,904.39,938.78,967.17,986.72,1007.85,1028.03],"type":"scatter"},{"mode":"lines+markers","name":"running_aov","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[361.77,401.66,384.1,382.99,381.08,384.24,383.14,383.49,383.11,382.77,383.57,383.28,383.11,383.3,382.85,382.91],"type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('657a9188-08ca-4870-8723-fcf9a6dad5f3');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.3: Динаміка Running ARPU, Running ARPPU, Running AOV</figcaption>
</figure>
</div>
</div>
<p>Проаналізуйте побудований графік та спробуйте відповісти на такі питання:</p>
<ol type="1">
<li>Яка загалом динаміка у розрахованих метрик? Вони ростуть, падають чи мають приблизно однакове значення у кожен із днів?</li>
<li>Чи можна з огляду на динаміку розрахованих метрик припустити, що з часом зростає кількість замовлень на одного користувача?</li>
</ol>
<p>Давайте порахуємо ті ж показники, але в іншому розрізі — не просто щодня, а щодня тижня.</p>
<p>Для виділення порядкового номера тижня можна використовувати функцію <code>DATE_PART</code> з параметром <code>'isodow'</code>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-04" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.4 </strong></span><br> Для кожного дня тижня в таблицях <code>orders</code> та <code>user_actions</code> розрахуйте такі показники:</p>
<ol type="1">
<li>Виручку користувача (ARPU).</li>
<li>Виручку на користувача, що платить (ARPPU).</li>
<li>Виторг на замовлення (AOV).</li>
</ol>
<p>При розрахунках враховуйте дані лише за період <strong>з 26 серпня 2022 року до 8 вересня 2022 року включно</strong> — так, щоб до аналізу потрапила однакова кількість усіх днів тижня (рівно по два дні).</p>
<p>У результуючу таблицю включіть як найменування днів тижня (наприклад, Monday), так і порядковий номер дня тижня (від 1 до 7, де 1 Monday, 7 Sunday).</p>
<p>Колонки з показниками назвіть відповідно <code>arpu</code>, <code>arppu</code>, <code>aov</code>. Назвіть колонку з найменуванням дня тижня <code>weekday</code>, а колонку з порядковим номером дня тижня <code>weekday_number</code>.</p>
<p>Під час розрахунку всіх показників округляйте значення до двох знаків після коми.</p>
<p>Результат має бути відсортований за зростанням порядкового номера дня тижня.</p>
<p>Поля в результуючій таблиці: <code>weekday</code>, <code>weekday_number</code>, <code>arpu</code>, <code>arppu</code>, <code>aov</code></p>
<p><strong>Пояснення:</strong></p>
<p>У цій задачі порядковий номер дня тижня необхідний для того, щоб дні тижня були розташовані на графіці зліва направо в правильному порядку — не за найменуванням, а за зростанням порядкового номера.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для розв’язання задачі необхідно виконати ті самі операції, що й у попередньому завданні, тільки цього разу для днів тижня. Додатково необхідно правильно задати фільтрацію за датою, щоб у аналіз потрапило рівно два однакові дні тижня.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="11">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="op">%%</span>sql</span>
<span id="cb10-2"><a href="#cb10-2"></a>SELECT weekday, t1.weekday_number AS weekday_number, </span>
<span id="cb10-3"><a href="#cb10-3"></a>        ROUND(revenue::decimal <span class="op">/</span> users, <span class="dv">2</span>) AS arpu, </span>
<span id="cb10-4"><a href="#cb10-4"></a>        ROUND(revenue::decimal <span class="op">/</span> paying_users, <span class="dv">2</span>) AS arppu, </span>
<span id="cb10-5"><a href="#cb10-5"></a>        ROUND(revenue::decimal <span class="op">/</span> orders, <span class="dv">2</span>) AS aov </span>
<span id="cb10-6"><a href="#cb10-6"></a>    FROM ( </span>
<span id="cb10-7"><a href="#cb10-7"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, creation_time) AS weekday, </span>
<span id="cb10-8"><a href="#cb10-8"></a>                MAX(DATE_PART(<span class="st">'isodow'</span>, creation_time)) AS weekday_number, </span>
<span id="cb10-9"><a href="#cb10-9"></a>                COUNT(DISTINCT order_id) AS orders,  </span>
<span id="cb10-10"><a href="#cb10-10"></a>                SUM(price) AS revenue </span>
<span id="cb10-11"><a href="#cb10-11"></a>        FROM ( </span>
<span id="cb10-12"><a href="#cb10-12"></a>            SELECT order_id, </span>
<span id="cb10-13"><a href="#cb10-13"></a>                creation_time, </span>
<span id="cb10-14"><a href="#cb10-14"></a>                UNNEST(product_ids) AS product_id </span>
<span id="cb10-15"><a href="#cb10-15"></a>            FROM orders </span>
<span id="cb10-16"><a href="#cb10-16"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb10-17"><a href="#cb10-17"></a>                AND creation_time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND creation_time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb10-18"><a href="#cb10-18"></a>            ) t4 </span>
<span id="cb10-19"><a href="#cb10-19"></a>        LEFT JOIN products  </span>
<span id="cb10-20"><a href="#cb10-20"></a>        USING(product_id) </span>
<span id="cb10-21"><a href="#cb10-21"></a>        GROUP BY weekday </span>
<span id="cb10-22"><a href="#cb10-22"></a>    ) t1 </span>
<span id="cb10-23"><a href="#cb10-23"></a>    LEFT JOIN ( </span>
<span id="cb10-24"><a href="#cb10-24"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, time) AS weekday, </span>
<span id="cb10-25"><a href="#cb10-25"></a>            MAX(DATE_PART(<span class="st">'isodow'</span>, time)) AS weekday_number, </span>
<span id="cb10-26"><a href="#cb10-26"></a>            COUNT(DISTINCT user_id) AS users </span>
<span id="cb10-27"><a href="#cb10-27"></a>        FROM user_actions </span>
<span id="cb10-28"><a href="#cb10-28"></a>        WHERE time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb10-29"><a href="#cb10-29"></a>        GROUP BY weekday </span>
<span id="cb10-30"><a href="#cb10-30"></a>    ) t2 </span>
<span id="cb10-31"><a href="#cb10-31"></a>    USING (weekday) </span>
<span id="cb10-32"><a href="#cb10-32"></a>    LEFT JOIN ( </span>
<span id="cb10-33"><a href="#cb10-33"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, time) AS weekday,  </span>
<span id="cb10-34"><a href="#cb10-34"></a>            MAX(DATE_PART(<span class="st">'isodow'</span>, time)) AS weekday_number, </span>
<span id="cb10-35"><a href="#cb10-35"></a>            COUNT(DISTINCT user_id) AS paying_users </span>
<span id="cb10-36"><a href="#cb10-36"></a>        FROM user_actions </span>
<span id="cb10-37"><a href="#cb10-37"></a>        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb10-38"><a href="#cb10-38"></a>            AND time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb10-39"><a href="#cb10-39"></a>        GROUP BY weekday </span>
<span id="cb10-40"><a href="#cb10-40"></a>    ) t3 </span>
<span id="cb10-41"><a href="#cb10-41"></a>    USING (weekday) </span>
<span id="cb10-42"><a href="#cb10-42"></a>    ORDER BY weekday_number</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">weekday</th>
<th data-quarto-table-cell-role="th">weekday_number</th>
<th data-quarto-table-cell-role="th">arpu</th>
<th data-quarto-table-cell-role="th">arppu</th>
<th data-quarto-table-cell-role="th">aov</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>555.98</td>
<td>575.18</td>
<td>385.87</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>2</td>
<td>528.94</td>
<td>548.04</td>
<td>382.63</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>3</td>
<td>528.90</td>
<td>548.33</td>
<td>381.16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>4</td>
<td>533.98</td>
<td>551.37</td>
<td>382.62</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>5</td>
<td>534.79</td>
<td>553.21</td>
<td>378.70</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>6</td>
<td>578.53</td>
<td>595.48</td>
<td>385.74</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>7</td>
<td>566.23</td>
<td>583.38</td>
<td>380.48</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_4</code>:</p>
<div class="cell" data-execution_count="12">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="op">%%</span>sql</span>
<span id="cb11-2"><a href="#cb11-2"></a>results_4 <span class="op">&lt;&lt;</span> SELECT weekday, t1.weekday_number AS weekday_number, </span>
<span id="cb11-3"><a href="#cb11-3"></a>        ROUND(revenue::decimal <span class="op">/</span> users, <span class="dv">2</span>) AS arpu, </span>
<span id="cb11-4"><a href="#cb11-4"></a>        ROUND(revenue::decimal <span class="op">/</span> paying_users, <span class="dv">2</span>) AS arppu, </span>
<span id="cb11-5"><a href="#cb11-5"></a>        ROUND(revenue::decimal <span class="op">/</span> orders, <span class="dv">2</span>) AS aov </span>
<span id="cb11-6"><a href="#cb11-6"></a>    FROM ( </span>
<span id="cb11-7"><a href="#cb11-7"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, creation_time) AS weekday, </span>
<span id="cb11-8"><a href="#cb11-8"></a>                MAX(DATE_PART(<span class="st">'isodow'</span>, creation_time)) AS weekday_number, </span>
<span id="cb11-9"><a href="#cb11-9"></a>                COUNT(DISTINCT order_id) AS orders,  </span>
<span id="cb11-10"><a href="#cb11-10"></a>                SUM(price) AS revenue </span>
<span id="cb11-11"><a href="#cb11-11"></a>        FROM ( </span>
<span id="cb11-12"><a href="#cb11-12"></a>            SELECT order_id, </span>
<span id="cb11-13"><a href="#cb11-13"></a>                creation_time, </span>
<span id="cb11-14"><a href="#cb11-14"></a>                UNNEST(product_ids) AS product_id </span>
<span id="cb11-15"><a href="#cb11-15"></a>            FROM orders </span>
<span id="cb11-16"><a href="#cb11-16"></a>            WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb11-17"><a href="#cb11-17"></a>                AND creation_time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND creation_time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb11-18"><a href="#cb11-18"></a>            ) t4 </span>
<span id="cb11-19"><a href="#cb11-19"></a>        LEFT JOIN products  </span>
<span id="cb11-20"><a href="#cb11-20"></a>        USING(product_id) </span>
<span id="cb11-21"><a href="#cb11-21"></a>        GROUP BY weekday </span>
<span id="cb11-22"><a href="#cb11-22"></a>    ) t1 </span>
<span id="cb11-23"><a href="#cb11-23"></a>    LEFT JOIN ( </span>
<span id="cb11-24"><a href="#cb11-24"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, time) AS weekday, </span>
<span id="cb11-25"><a href="#cb11-25"></a>            MAX(DATE_PART(<span class="st">'isodow'</span>, time)) AS weekday_number, </span>
<span id="cb11-26"><a href="#cb11-26"></a>            COUNT(DISTINCT user_id) AS users </span>
<span id="cb11-27"><a href="#cb11-27"></a>        FROM user_actions </span>
<span id="cb11-28"><a href="#cb11-28"></a>        WHERE time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb11-29"><a href="#cb11-29"></a>        GROUP BY weekday </span>
<span id="cb11-30"><a href="#cb11-30"></a>    ) t2 </span>
<span id="cb11-31"><a href="#cb11-31"></a>    USING (weekday) </span>
<span id="cb11-32"><a href="#cb11-32"></a>    LEFT JOIN ( </span>
<span id="cb11-33"><a href="#cb11-33"></a>        SELECT DATE_PART(<span class="st">'isodow'</span>, time) AS weekday,  </span>
<span id="cb11-34"><a href="#cb11-34"></a>            MAX(DATE_PART(<span class="st">'isodow'</span>, time)) AS weekday_number, </span>
<span id="cb11-35"><a href="#cb11-35"></a>            COUNT(DISTINCT user_id) AS paying_users </span>
<span id="cb11-36"><a href="#cb11-36"></a>        FROM user_actions </span>
<span id="cb11-37"><a href="#cb11-37"></a>        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action<span class="op">=</span><span class="st">'cancel_order'</span>) </span>
<span id="cb11-38"><a href="#cb11-38"></a>            AND time <span class="op">&gt;=</span> <span class="st">'2022-08-26'</span> AND time <span class="op">&lt;</span> <span class="st">'2022-09-09'</span> </span>
<span id="cb11-39"><a href="#cb11-39"></a>        GROUP BY weekday </span>
<span id="cb11-40"><a href="#cb11-40"></a>    ) t3 </span>
<span id="cb11-41"><a href="#cb11-41"></a>    USING (weekday) </span>
<span id="cb11-42"><a href="#cb11-42"></a>    ORDER BY weekday_number</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>days <span class="op">=</span> [</span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="st">"Monday"</span>,</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="st">"Tuesday"</span>,</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="st">"Wednesday"</span>,</span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="st">"Thursday"</span>,</span>
<span id="cb12-8"><a href="#cb12-8"></a>    <span class="st">"Friday"</span>,</span>
<span id="cb12-9"><a href="#cb12-9"></a>    <span class="st">"Saturday"</span>,</span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="st">"Sunday"</span>,</span>
<span id="cb12-11"><a href="#cb12-11"></a>]</span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb12-14"><a href="#cb12-14"></a></span>
<span id="cb12-15"><a href="#cb12-15"></a>traces <span class="op">=</span> [(<span class="st">"arpu"</span>, results_4.arpu), (<span class="st">"arppu"</span>, results_4.arppu), (<span class="st">"aov"</span>, results_4.aov)]</span>
<span id="cb12-16"><a href="#cb12-16"></a></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="cf">for</span> trace_name, trace_values <span class="kw">in</span> traces:</span>
<span id="cb12-18"><a href="#cb12-18"></a>    fig.add_trace(</span>
<span id="cb12-19"><a href="#cb12-19"></a>        go.Scatter(x<span class="op">=</span>days, y<span class="op">=</span>trace_values, mode<span class="op">=</span><span class="st">"lines+markers"</span>, name<span class="op">=</span>trace_name)</span>
<span id="cb12-20"><a href="#cb12-20"></a>    )</span>
<span id="cb12-21"><a href="#cb12-21"></a></span>
<span id="cb12-22"><a href="#cb12-22"></a>fig.update_layout(</span>
<span id="cb12-23"><a href="#cb12-23"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-24"><a href="#cb12-24"></a>)</span>
<span id="cb12-25"><a href="#cb12-25"></a></span>
<span id="cb12-26"><a href="#cb12-26"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-analytic-04" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="0f4916df-035f-4193-b58e-041bf907501b" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("0f4916df-035f-4193-b58e-041bf907501b")) {                    Plotly.newPlot(                        "0f4916df-035f-4193-b58e-041bf907501b",                        [{"mode":"lines+markers","name":"arpu","x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":[555.98,528.94,528.9,533.98,534.79,578.53,566.23],"type":"scatter"},{"mode":"lines+markers","name":"arppu","x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":[575.18,548.04,548.33,551.37,553.21,595.48,583.38],"type":"scatter"},{"mode":"lines+markers","name":"aov","x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":[385.87,382.63,381.16,382.62,378.7,385.74,380.48],"type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('0f4916df-035f-4193-b58e-041bf907501b');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.4: Динаміка ARPU, ARPPU та AOV за днями тижня</figcaption>
</figure>
</div>
</div>
<p>Проаналізуйте побудований графік та спробуйте відповісти на такі питання:</p>
<ol type="1">
<li>У які дні тижня метрики ARPU та ARPPU набували найбільших значень? Як ви вважаєте, чи це узгоджується в цілому зі стандартною поведінкою користувачів сервісу доставки їжі?</li>
<li>Як ви вважаєте, чому в ті дні, коли метрики ARPU та ARPPU набували найбільших значень, метрика AOV залишалася приблизно на тому ж рівні? За якого сценарію таке можливе?</li>
</ol>
</section>
<section id="виручка-нових-користувачів" class="level2" data-number="18.3">
<h2 data-number="18.3" class="anchored" data-anchor-id="виручка-нових-користувачів"><span class="header-section-number">18.3</span> Виручка нових користувачів</h2>
<p>Трохи ускладнимо наш початковий запит і окремо порахуємо щоденну виручку із замовлень нових користувачів нашого сервісу. Подивимося, яку частку вона становить у загальному виторгу із замовлень всіх користувачів — і нових, і старих.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-05" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.5 </strong></span><br> Для кожного дня в таблицях <code>orders</code> та <code>user_actions</code> розрахуйте такі показники:</p>
<ol type="1">
<li>Виручку, одержану в цей день.</li>
<li>Виручку із замовлень нових користувачів, отриману цього дня.</li>
<li>Частку виручки із замовлень нових користувачів у загальній виручці, отриманої за цей день.</li>
<li>Частку виручки із замовлень інших користувачів у загальній виручці, отриманої за цей день.</li>
</ol>
<p>Колонки з показниками назвіть відповідно <code>revenue</code>, <code>new_users_revenue</code>, <code>new_users_revenue_share</code>, <code>old_users_revenue_share</code>. Колонку з датами назвіть <code>date</code>.</p>
<p>Усі показники часток необхідно виразити <strong>у відсотках</strong>. Під час їх розрахунку округляйте значення д<strong>о двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зростанням дати.</p>
<p>Поля в результуючій таблиці: <code>date</code>, <code>revenue</code>, <code>new_users_revenue</code>, <code>new_users_revenue_share</code>, <code>old_users_revenue_share</code></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання необхідно для кожного дня порахувати виручку з нових користувачів. Щоб це зробити, спочатку необхідно для кожного користувача визначити мінімальну дату, тобто дату першої дії в нашому сервісі, а також порахувати вартість кожного замовлення в таблиці <code>orders</code>. Потім, об’єднавши дані про вартість замовлень з даними про дії користувачів у таблиці <code>user_actions</code>, можна для кожного користувача порахувати сумарну вартість його замовлень на кожну дату (групування за двома полями) та об’єднати ці дані з таблицею з датами початку використання додатку у кожного користувача (порахованою раніше). Таким чином, можна отримати таблицю з виручкою, одержаною з кожного користувача у його перший день. Далі залишається зробити групування за датою та порахувати сумарний виторг з нових користувачів за кожен день.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="14">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">%%</span>sql</span>
<span id="cb13-2"><a href="#cb13-2"></a>SELECT date,</span>
<span id="cb13-3"><a href="#cb13-3"></a>       revenue,</span>
<span id="cb13-4"><a href="#cb13-4"></a>       new_users_revenue,</span>
<span id="cb13-5"><a href="#cb13-5"></a>       <span class="bu">round</span>(new_users_revenue <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> new_users_revenue_share,</span>
<span id="cb13-6"><a href="#cb13-6"></a>       <span class="dv">100</span> <span class="op">-</span> <span class="bu">round</span>(new_users_revenue <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> old_users_revenue_share</span>
<span id="cb13-7"><a href="#cb13-7"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb13-8"><a href="#cb13-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb13-9"><a href="#cb13-9"></a>        FROM   (SELECT order_id,</span>
<span id="cb13-10"><a href="#cb13-10"></a>                       creation_time,</span>
<span id="cb13-11"><a href="#cb13-11"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb13-12"><a href="#cb13-12"></a>                FROM   orders</span>
<span id="cb13-13"><a href="#cb13-13"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb13-14"><a href="#cb13-14"></a>                                        FROM   user_actions</span>
<span id="cb13-15"><a href="#cb13-15"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t3</span>
<span id="cb13-16"><a href="#cb13-16"></a>            LEFT JOIN products using (product_id)</span>
<span id="cb13-17"><a href="#cb13-17"></a>        GROUP BY date) t1</span>
<span id="cb13-18"><a href="#cb13-18"></a>    LEFT JOIN (SELECT start_date <span class="im">as</span> date,</span>
<span id="cb13-19"><a href="#cb13-19"></a>                      <span class="bu">sum</span>(revenue) <span class="im">as</span> new_users_revenue</span>
<span id="cb13-20"><a href="#cb13-20"></a>               FROM   (SELECT t5.user_id,</span>
<span id="cb13-21"><a href="#cb13-21"></a>                              t5.start_date,</span>
<span id="cb13-22"><a href="#cb13-22"></a>                              coalesce(t6.revenue, <span class="dv">0</span>) <span class="im">as</span> revenue</span>
<span id="cb13-23"><a href="#cb13-23"></a>                       FROM   (SELECT user_id,</span>
<span id="cb13-24"><a href="#cb13-24"></a>                                      <span class="bu">min</span>(time::date) <span class="im">as</span> start_date</span>
<span id="cb13-25"><a href="#cb13-25"></a>                               FROM   user_actions</span>
<span id="cb13-26"><a href="#cb13-26"></a>                               GROUP BY user_id) t5</span>
<span id="cb13-27"><a href="#cb13-27"></a>                           LEFT JOIN (SELECT user_id,</span>
<span id="cb13-28"><a href="#cb13-28"></a>                                             date,</span>
<span id="cb13-29"><a href="#cb13-29"></a>                                             <span class="bu">sum</span>(order_price) <span class="im">as</span> revenue</span>
<span id="cb13-30"><a href="#cb13-30"></a>                                      FROM   (SELECT user_id,</span>
<span id="cb13-31"><a href="#cb13-31"></a>                                                     time::date <span class="im">as</span> date,</span>
<span id="cb13-32"><a href="#cb13-32"></a>                                                     order_id</span>
<span id="cb13-33"><a href="#cb13-33"></a>                                              FROM   user_actions</span>
<span id="cb13-34"><a href="#cb13-34"></a>                                              WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb13-35"><a href="#cb13-35"></a>                                                                      FROM   user_actions</span>
<span id="cb13-36"><a href="#cb13-36"></a>                                                                      WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t7</span>
<span id="cb13-37"><a href="#cb13-37"></a>                                          LEFT JOIN (SELECT order_id,</span>
<span id="cb13-38"><a href="#cb13-38"></a>                                                            <span class="bu">sum</span>(price) <span class="im">as</span> order_price</span>
<span id="cb13-39"><a href="#cb13-39"></a>                                                     FROM   (SELECT order_id,</span>
<span id="cb13-40"><a href="#cb13-40"></a>                                                                    unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb13-41"><a href="#cb13-41"></a>                                                             FROM   orders</span>
<span id="cb13-42"><a href="#cb13-42"></a>                                                             WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb13-43"><a href="#cb13-43"></a>                                                                                     FROM   user_actions</span>
<span id="cb13-44"><a href="#cb13-44"></a>                                                                                     WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t9</span>
<span id="cb13-45"><a href="#cb13-45"></a>                                                         LEFT JOIN products using (product_id)</span>
<span id="cb13-46"><a href="#cb13-46"></a>                                                     GROUP BY order_id) t8 using (order_id)</span>
<span id="cb13-47"><a href="#cb13-47"></a>                                      GROUP BY user_id, date) t6</span>
<span id="cb13-48"><a href="#cb13-48"></a>                               ON t5.user_id <span class="op">=</span> t6.user_id <span class="kw">and</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>                                  t5.start_date <span class="op">=</span> t6.date) t4</span>
<span id="cb13-50"><a href="#cb13-50"></a>               GROUP BY start_date) t2 using (date)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">revenue</th>
<th data-quarto-table-cell-role="th">new_users_revenue</th>
<th data-quarto-table-cell-role="th">new_users_revenue_share</th>
<th data-quarto-table-cell-role="th">old_users_revenue_share</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-24</td>
<td>49924.0</td>
<td>49924.0</td>
<td>100.00</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-25</td>
<td>430860.0</td>
<td>417333.0</td>
<td>96.86</td>
<td>3.14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-26</td>
<td>534766.0</td>
<td>463326.0</td>
<td>86.64</td>
<td>13.36</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-27</td>
<td>817053.0</td>
<td>619318.0</td>
<td>75.80</td>
<td>24.20</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-28</td>
<td>1133370.0</td>
<td>801162.0</td>
<td>70.69</td>
<td>29.31</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2022-08-29</td>
<td>1279891.0</td>
<td>717374.0</td>
<td>56.05</td>
<td>43.95</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2022-08-30</td>
<td>1279377.0</td>
<td>656429.0</td>
<td>51.31</td>
<td>48.69</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2022-08-31</td>
<td>1312720.0</td>
<td>720381.0</td>
<td>54.88</td>
<td>45.12</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2022-09-01</td>
<td>1406101.0</td>
<td>757287.0</td>
<td>53.86</td>
<td>46.14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2022-09-02</td>
<td>1907107.0</td>
<td>1017824.0</td>
<td>53.37</td>
<td>46.63</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2022-09-03</td>
<td>2210988.0</td>
<td>1079256.0</td>
<td>48.81</td>
<td>51.19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2022-09-04</td>
<td>2294009.0</td>
<td>1063997.0</td>
<td>46.38</td>
<td>53.62</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2022-09-05</td>
<td>1784690.0</td>
<td>714459.0</td>
<td>40.03</td>
<td>59.97</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2022-09-06</td>
<td>1330931.0</td>
<td>495058.0</td>
<td>37.20</td>
<td>62.80</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2022-09-07</td>
<td>1807800.0</td>
<td>710154.0</td>
<td>39.28</td>
<td>60.72</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2022-09-08</td>
<td>2099508.0</td>
<td>887959.0</td>
<td>42.29</td>
<td>57.71</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_5</code>:</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="op">%%</span>sql</span>
<span id="cb14-2"><a href="#cb14-2"></a>results_5 <span class="op">&lt;&lt;</span> SELECT date,</span>
<span id="cb14-3"><a href="#cb14-3"></a>       revenue,</span>
<span id="cb14-4"><a href="#cb14-4"></a>       new_users_revenue,</span>
<span id="cb14-5"><a href="#cb14-5"></a>       <span class="bu">round</span>(new_users_revenue <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> new_users_revenue_share,</span>
<span id="cb14-6"><a href="#cb14-6"></a>       <span class="dv">100</span> <span class="op">-</span> <span class="bu">round</span>(new_users_revenue <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> old_users_revenue_share</span>
<span id="cb14-7"><a href="#cb14-7"></a>FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb14-8"><a href="#cb14-8"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb14-9"><a href="#cb14-9"></a>        FROM   (SELECT order_id,</span>
<span id="cb14-10"><a href="#cb14-10"></a>                       creation_time,</span>
<span id="cb14-11"><a href="#cb14-11"></a>                       unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb14-12"><a href="#cb14-12"></a>                FROM   orders</span>
<span id="cb14-13"><a href="#cb14-13"></a>                WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb14-14"><a href="#cb14-14"></a>                                        FROM   user_actions</span>
<span id="cb14-15"><a href="#cb14-15"></a>                                        WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t3</span>
<span id="cb14-16"><a href="#cb14-16"></a>            LEFT JOIN products using (product_id)</span>
<span id="cb14-17"><a href="#cb14-17"></a>        GROUP BY date) t1</span>
<span id="cb14-18"><a href="#cb14-18"></a>    LEFT JOIN (SELECT start_date <span class="im">as</span> date,</span>
<span id="cb14-19"><a href="#cb14-19"></a>                      <span class="bu">sum</span>(revenue) <span class="im">as</span> new_users_revenue</span>
<span id="cb14-20"><a href="#cb14-20"></a>               FROM   (SELECT t5.user_id,</span>
<span id="cb14-21"><a href="#cb14-21"></a>                              t5.start_date,</span>
<span id="cb14-22"><a href="#cb14-22"></a>                              coalesce(t6.revenue, <span class="dv">0</span>) <span class="im">as</span> revenue</span>
<span id="cb14-23"><a href="#cb14-23"></a>                       FROM   (SELECT user_id,</span>
<span id="cb14-24"><a href="#cb14-24"></a>                                      <span class="bu">min</span>(time::date) <span class="im">as</span> start_date</span>
<span id="cb14-25"><a href="#cb14-25"></a>                               FROM   user_actions</span>
<span id="cb14-26"><a href="#cb14-26"></a>                               GROUP BY user_id) t5</span>
<span id="cb14-27"><a href="#cb14-27"></a>                           LEFT JOIN (SELECT user_id,</span>
<span id="cb14-28"><a href="#cb14-28"></a>                                             date,</span>
<span id="cb14-29"><a href="#cb14-29"></a>                                             <span class="bu">sum</span>(order_price) <span class="im">as</span> revenue</span>
<span id="cb14-30"><a href="#cb14-30"></a>                                      FROM   (SELECT user_id,</span>
<span id="cb14-31"><a href="#cb14-31"></a>                                                     time::date <span class="im">as</span> date,</span>
<span id="cb14-32"><a href="#cb14-32"></a>                                                     order_id</span>
<span id="cb14-33"><a href="#cb14-33"></a>                                              FROM   user_actions</span>
<span id="cb14-34"><a href="#cb14-34"></a>                                              WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb14-35"><a href="#cb14-35"></a>                                                                      FROM   user_actions</span>
<span id="cb14-36"><a href="#cb14-36"></a>                                                                      WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t7</span>
<span id="cb14-37"><a href="#cb14-37"></a>                                          LEFT JOIN (SELECT order_id,</span>
<span id="cb14-38"><a href="#cb14-38"></a>                                                            <span class="bu">sum</span>(price) <span class="im">as</span> order_price</span>
<span id="cb14-39"><a href="#cb14-39"></a>                                                     FROM   (SELECT order_id,</span>
<span id="cb14-40"><a href="#cb14-40"></a>                                                                    unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb14-41"><a href="#cb14-41"></a>                                                             FROM   orders</span>
<span id="cb14-42"><a href="#cb14-42"></a>                                                             WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb14-43"><a href="#cb14-43"></a>                                                                                     FROM   user_actions</span>
<span id="cb14-44"><a href="#cb14-44"></a>                                                                                     WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t9</span>
<span id="cb14-45"><a href="#cb14-45"></a>                                                         LEFT JOIN products using (product_id)</span>
<span id="cb14-46"><a href="#cb14-46"></a>                                                     GROUP BY order_id) t8 using (order_id)</span>
<span id="cb14-47"><a href="#cb14-47"></a>                                      GROUP BY user_id, date) t6</span>
<span id="cb14-48"><a href="#cb14-48"></a>                               ON t5.user_id <span class="op">=</span> t6.user_id <span class="kw">and</span></span>
<span id="cb14-49"><a href="#cb14-49"></a>                                  t5.start_date <span class="op">=</span> t6.date) t4</span>
<span id="cb14-50"><a href="#cb14-50"></a>               GROUP BY start_date) t2 using (date)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>fig <span class="op">=</span> go.Figure(</span>
<span id="cb15-2"><a href="#cb15-2"></a>    data<span class="op">=</span>[</span>
<span id="cb15-3"><a href="#cb15-3"></a>        go.Bar(</span>
<span id="cb15-4"><a href="#cb15-4"></a>            name<span class="op">=</span><span class="st">"new_users_revenue_share"</span>,</span>
<span id="cb15-5"><a href="#cb15-5"></a>            x<span class="op">=</span>results_5.date,</span>
<span id="cb15-6"><a href="#cb15-6"></a>            y<span class="op">=</span>results_5.new_users_revenue_share,</span>
<span id="cb15-7"><a href="#cb15-7"></a>        ),</span>
<span id="cb15-8"><a href="#cb15-8"></a>        go.Bar(</span>
<span id="cb15-9"><a href="#cb15-9"></a>            name<span class="op">=</span><span class="st">"old_users_revenue_share"</span>,</span>
<span id="cb15-10"><a href="#cb15-10"></a>            x<span class="op">=</span>results_5.date,</span>
<span id="cb15-11"><a href="#cb15-11"></a>            y<span class="op">=</span>results_5.old_users_revenue_share,</span>
<span id="cb15-12"><a href="#cb15-12"></a>        ),</span>
<span id="cb15-13"><a href="#cb15-13"></a>    ]</span>
<span id="cb15-14"><a href="#cb15-14"></a>)</span>
<span id="cb15-15"><a href="#cb15-15"></a>fig.update_layout(</span>
<span id="cb15-16"><a href="#cb15-16"></a>    barmode<span class="op">=</span><span class="st">"stack"</span>,</span>
<span id="cb15-17"><a href="#cb15-17"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb15-18"><a href="#cb15-18"></a>)</span>
<span id="cb15-19"><a href="#cb15-19"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-05" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="1c45505e-8e6f-44a7-b051-c7202e476ebf" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("1c45505e-8e6f-44a7-b051-c7202e476ebf")) {                    Plotly.newPlot(                        "1c45505e-8e6f-44a7-b051-c7202e476ebf",                        [{"name":"new_users_revenue_share","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[100.0,96.86,86.64,75.8,70.69,56.05,51.31,54.88,53.86,53.37,48.81,46.38,40.03,37.2,39.28,42.29],"type":"bar"},{"name":"old_users_revenue_share","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[0.0,3.1400000000000006,13.36,24.200000000000003,29.310000000000002,43.95,48.69,45.12,46.14,46.63,51.19,53.62,59.97,62.8,60.72,57.71],"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1},"barmode":"stack"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('1c45505e-8e6f-44a7-b051-c7202e476ebf');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.5: Динаміка виручки нових та старих користувачів</figcaption>
</figure>
</div>
</div>
<p>Чи можна сказати, що через два тижні після запуску нашого сервісу показник виручки від нових користувачів, як і раніше, на досить високому рівні?</p>
</section>
<section id="попит-на-товари" class="level2" data-number="18.4">
<h2 data-number="18.4" class="anchored" data-anchor-id="попит-на-товари"><span class="header-section-number">18.4</span> Попит на товари</h2>
<p>Також було б цікаво подивитися, які товари мають найбільший попит і приносять нам основний дохід.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-06" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.6 </strong></span><br> Для кожного товару, представленого в таблиці <code>products</code>, за весь період часу в таблиці <code>orders</code> розрахуйте наступні показники:</p>
<ol type="1">
<li>Сумарний виторг, отриманий від продажу цього товару за весь період.</li>
<li>Частку виручки від цього товару у загальної виручці, отриманої протягом період.</li>
</ol>
<p>Колонки з показниками назвіть відповідно <code>revenue</code> та <code>share_in_revenue</code>. Колонку із найменуваннями товарів назвіть <code>product_name</code>.</p>
<p>Частку виручки з кожного товару необхідно <strong>виразити у відсотка</strong>х. При її розрахунку округляйте значення <strong>до двох знаків після коми</strong>.</p>
<p>Товари, заокруглена частка яких у виручці становить менше <strong>0.5%</strong>, об’єднайте в загальну групу під назвою <strong>“OTHER”</strong> (без лапок), підсумувавши заокруглені частки цих товарів.</p>
<p>Результат має бути відсортований за зменшенням виручки від продажу товару.</p>
<p>Поля в результуючій таблиці: <code>product_name</code>, <code>revenue</code>, <code>share_in_revenue</code></p>
<p><strong>Пояснення:</strong></p>
<p>Товари з невеликою часткою у виручці необхідно об’єднати в одну групу, щоб не виводити на графіку всі товари з таблиці <code>products</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання необхідно згадати, як працює конструкція <code>CASE</code>, і порахувати виторг у розрізі найменувань товарів, представлених у таблиці <code>products</code>. Загальний алгоритм розрахунку виручки той самий, що у попередніх завданнях.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="17">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="op">%%</span>sql</span>
<span id="cb16-2"><a href="#cb16-2"></a>SELECT product_name,</span>
<span id="cb16-3"><a href="#cb16-3"></a>       <span class="bu">sum</span>(revenue) <span class="im">as</span> revenue,</span>
<span id="cb16-4"><a href="#cb16-4"></a>       <span class="bu">sum</span>(share_in_revenue) <span class="im">as</span> share_in_revenue</span>
<span id="cb16-5"><a href="#cb16-5"></a>FROM   (SELECT case when <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> revenue <span class="op">/</span> <span class="bu">sum</span>(revenue) OVER (), <span class="dv">2</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span> then name</span>
<span id="cb16-6"><a href="#cb16-6"></a>                    <span class="cf">else</span> <span class="st">'OTHER'</span> end <span class="im">as</span> product_name,</span>
<span id="cb16-7"><a href="#cb16-7"></a>               revenue,</span>
<span id="cb16-8"><a href="#cb16-8"></a>               <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> revenue <span class="op">/</span> <span class="bu">sum</span>(revenue) OVER (), <span class="dv">2</span>) <span class="im">as</span> share_in_revenue</span>
<span id="cb16-9"><a href="#cb16-9"></a>        FROM   (SELECT name,</span>
<span id="cb16-10"><a href="#cb16-10"></a>                       <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb16-11"><a href="#cb16-11"></a>                FROM   (SELECT order_id,</span>
<span id="cb16-12"><a href="#cb16-12"></a>                               unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb16-13"><a href="#cb16-13"></a>                        FROM   orders</span>
<span id="cb16-14"><a href="#cb16-14"></a>                        WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb16-15"><a href="#cb16-15"></a>                                                FROM   user_actions</span>
<span id="cb16-16"><a href="#cb16-16"></a>                                                WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb16-17"><a href="#cb16-17"></a>                    LEFT JOIN products using(product_id)</span>
<span id="cb16-18"><a href="#cb16-18"></a>                GROUP BY name) t2) t3</span>
<span id="cb16-19"><a href="#cb16-19"></a>GROUP BY product_name</span>
<span id="cb16-20"><a href="#cb16-20"></a>ORDER BY revenue desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_name</th>
<th data-quarto-table-cell-role="th">revenue</th>
<th data-quarto-table-cell-role="th">share_in_revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>pork</td>
<td>1353600.0</td>
<td>6.24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>OTHER</td>
<td>1225387.0</td>
<td>5.64</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chicken</td>
<td>1171140.0</td>
<td>5.40</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>olive oil</td>
<td>1163250.0</td>
<td>5.37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>beef</td>
<td>977170.0</td>
<td>4.51</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">63</td>
<td>rice</td>
<td>118930.0</td>
<td>0.55</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">64</td>
<td>herbal tea bags</td>
<td>112580.0</td>
<td>0.52</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">65</td>
<td>tea mushroom</td>
<td>112448.0</td>
<td>0.52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">66</td>
<td>sesame oil</td>
<td>109750.0</td>
<td>0.51</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">67</td>
<td>chewing gum</td>
<td>109650.0</td>
<td>0.51</td>
</tr>
</tbody>
</table>

<p>68 rows × 3 columns</p>
</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_6</code>:</p>
<div class="cell" data-execution_count="18">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="op">%%</span>sql</span>
<span id="cb17-2"><a href="#cb17-2"></a>results_6 <span class="op">&lt;&lt;</span> SELECT product_name,</span>
<span id="cb17-3"><a href="#cb17-3"></a>       <span class="bu">sum</span>(revenue) <span class="im">as</span> revenue,</span>
<span id="cb17-4"><a href="#cb17-4"></a>       <span class="bu">sum</span>(share_in_revenue) <span class="im">as</span> share_in_revenue</span>
<span id="cb17-5"><a href="#cb17-5"></a>FROM   (SELECT case when <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> revenue <span class="op">/</span> <span class="bu">sum</span>(revenue) OVER (), <span class="dv">2</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span> then name</span>
<span id="cb17-6"><a href="#cb17-6"></a>                    <span class="cf">else</span> <span class="st">'OTHER'</span> end <span class="im">as</span> product_name,</span>
<span id="cb17-7"><a href="#cb17-7"></a>               revenue,</span>
<span id="cb17-8"><a href="#cb17-8"></a>               <span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> revenue <span class="op">/</span> <span class="bu">sum</span>(revenue) OVER (), <span class="dv">2</span>) <span class="im">as</span> share_in_revenue</span>
<span id="cb17-9"><a href="#cb17-9"></a>        FROM   (SELECT name,</span>
<span id="cb17-10"><a href="#cb17-10"></a>                       <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb17-11"><a href="#cb17-11"></a>                FROM   (SELECT order_id,</span>
<span id="cb17-12"><a href="#cb17-12"></a>                               unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb17-13"><a href="#cb17-13"></a>                        FROM   orders</span>
<span id="cb17-14"><a href="#cb17-14"></a>                        WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb17-15"><a href="#cb17-15"></a>                                                FROM   user_actions</span>
<span id="cb17-16"><a href="#cb17-16"></a>                                                WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb17-17"><a href="#cb17-17"></a>                    LEFT JOIN products using(product_id)</span>
<span id="cb17-18"><a href="#cb17-18"></a>                GROUP BY name) t2) t3</span>
<span id="cb17-19"><a href="#cb17-19"></a>GROUP BY product_name</span>
<span id="cb17-20"><a href="#cb17-20"></a>ORDER BY revenue desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb18-2"><a href="#cb18-2"></a>fig.add_trace(</span>
<span id="cb18-3"><a href="#cb18-3"></a>    go.Bar(</span>
<span id="cb18-4"><a href="#cb18-4"></a>        x<span class="op">=</span>results_6.product_name, y<span class="op">=</span>results_6.share_in_revenue, name<span class="op">=</span><span class="st">"share_in_revenue"</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>    )</span>
<span id="cb18-6"><a href="#cb18-6"></a>)</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>fig.update_layout(</span>
<span id="cb18-9"><a href="#cb18-9"></a>    xaxis_tickangle<span class="op">=-</span><span class="dv">45</span>,</span>
<span id="cb18-10"><a href="#cb18-10"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb18-11"><a href="#cb18-11"></a>)</span>
<span id="cb18-12"><a href="#cb18-12"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-analytic-06" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="3034a261-1490-4c68-aca4-83e0d61cc7c9" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("3034a261-1490-4c68-aca4-83e0d61cc7c9")) {                    Plotly.newPlot(                        "3034a261-1490-4c68-aca4-83e0d61cc7c9",                        [{"name":"share_in_revenue","x":["pork","OTHER","chicken","olive oil","beef","mutton","grain coffee","sugar","instant coffee","sausages","energy drink","apple juice","\u0441owberry juice","caviar","bananas","pasta","ground coffee","grape","decaffeinated coffee","pineapple","veal","lemonade","orange juice","cranberry juice","fruit drink blueberry","still water","tangerines","sunflower oil","apples","milk","black tea bags","chips","pineapple juice","oranges","cream","long loaf","black leaf tea","black chocolate","sour cream","jam","honey","buckwheat","flour","waffles","oatmeal","smoked fish","kvass","herbal leaf tea","watermelon","salted fish","cookie","bread","white chocolate","mayonnaise","multifruit juice","green tea bags","pears","carbonated water","leaf green tea","condensed milk","sprats","ketchup","cupcakes","rice","herbal tea bags","tea mushroom","sesame oil","chewing gum"],"y":[6.24,5.640000000000001,5.4,5.37,4.51,3.27,2.92,2.71,2.49,2.45,2.03,1.95,1.92,1.82,1.8,1.75,1.71,1.68,1.64,1.61,1.55,1.47,1.38,1.37,1.36,1.28,1.25,1.23,1.21,1.05,1.0,1.0,0.95,0.93,0.92,0.9,0.83,0.82,0.81,0.81,0.79,0.78,0.78,0.78,0.78,0.77,0.76,0.75,0.74,0.73,0.73,0.73,0.73,0.72,0.71,0.71,0.67,0.66,0.64,0.63,0.63,0.6,0.56,0.55,0.52,0.52,0.51,0.51],"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"tickangle":-45},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('3034a261-1490-4c68-aca4-83e0d61cc7c9');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.6: Частка виручки за продуктами</figcaption>
</figure>
</div>
</div>
<p>Подивіться на побудований графік та визначте товари з найбільшою часткою у виручці. Якби ми об’єднали товари в ширші групи, то яка, на вашу думку, опинилася б на першому місці за часткою у виручці?</p>
</section>
<section id="валовий-прибуток" class="level2 page-columns page-full" data-number="18.5">
<h2 data-number="18.5" class="anchored" data-anchor-id="валовий-прибуток"><span class="header-section-number">18.5</span> Валовий прибуток</h2>
<p>Тепер спробуємо врахувати в наших розрахунках витрати з податками і порахуємо валовий прибуток, тобто ту суму, яку ми фактично отримали в результаті реалізації товарів за розглянутий період.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-07" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.7 </strong></span><br> Для кожного дня в таблицях <code>orders</code> та <code>courier_actions</code> розрахуйте такі показники:</p>
<ol type="1">
<li>Виручку, одержану в цей день.</li>
<li>Витрати цього дня.</li>
<li>Суму ПДВ із продажу товарів у цей день.</li>
<li>Валовий прибуток у цей день (виручка за вирахуванням витрат та ПДВ).</li>
<li>Сумарний виторг на поточний день.</li>
<li>Сумарні витрати на цей день.</li>
<li>Сумарний ПДВ на сьогодні.</li>
<li>Сумарний валовий прибуток на поточний день.</li>
<li>Частку валового прибутку у виручці цей день (частку п.4 в п.1).</li>
<li>Частку сумарного валового прибутку в сумарній виручці на поточний день (частку п.8 п.5).</li>
</ol>
<p>Колонки з показниками назвіть відповідно <code>revenue</code>, <code>costs</code>, <code>tax</code>, <code>gross_profit</code>, <code>total_revenue</code>, <code>total_costs</code>, <code>total_tax</code>, <code>total_gross_profit</code>, <code>gross_profit_ratio</code>, <code>total_gross_profit_ratio</code></p>
<p>Колонку з датами назвіть <code>date</code>.</p>
<p>Частку валового прибутку у виручці необхідно <strong>виразити у відсотках</strong>, округливши значення <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зростанням дати.</p>
<p>Поля в результуючій таблиці: <code>date</code>, <code>revenue</code>, <code>costs</code>, <code>tax</code>, <code>gross_profit</code>, <code>total_revenue</code>, <code>total_costs</code>, <code>total_tax</code>, <code>total_gross_profit</code>, <code>gross_profit_ratio</code>, <code>total_gross_profit_ratio</code></p>
<p><strong>Щоб порахувати витрати, в цій задачі введемо додаткові умови.</strong></p>
<p>У спрощеному вигляді <strong>витрати</strong> нашого сервісу рахуватимемо як <strong>суму постійних і змінних витрат</strong>. До постійних витрат віднесемо оренду складських приміщень, а до змінних - вартість збирання та доставки замовлення. Таким чином, змінні витрати безпосередньо залежатимуть від кількості замовлень.</p>
<p>З даних, які нам надав фінансовий відділ, відомо, що у <strong>серпні 2022 року</strong> постійні витрати становили <strong>120 000 грошових одиниць на день</strong>. Проте вже у <strong>вересні</strong> нашому сервісу були потрібні додаткові приміщення, і тому постійні витрати зросли до <strong>150 000 грошових одиниць на день</strong>.</p>
<p>Також відомо, що в <strong>серпні 2022 року</strong> складання одного замовлення обходилася нам в <strong>140 грошових одиниць</strong>, при цьому кур’єрам ми платили по <strong>150 грошових одиниць</strong> за одне доставлене замовлення і ще <strong>400 грошових одиниць щодня як бонус</strong>, якщо кур’єр доставляв <strong>не менше 5 замовлень на день</strong>. У <strong>вересні</strong> продакт-менеджерам вдалося знизити витрати на складання замовлення до <strong>115 грошових одиниць</strong>, але при цьому довелося підвищити бонусну виплату за доставку 5 і більше замовлень до <strong>500 грошових одиниць</strong>, щоб забезпечити конкурентоспроможніші умови праці. При цьому у вересні виплата кур’єрам за одне доставлене замовлення залишилася незмінною.</p>
<p><strong>Пояснення:</strong></p>
<p>При розрахунку змінних витрат враховуйте такі умови:</p>
<ol type="1">
<li>Витрати на складання враховуються в тому ж дні, коли було оформлено замовлення. Складання скасованих замовлень не проводиться.</li>
<li>Виплата кур’єрам за доставлене замовлення нараховується відразу після його доставки, тому якщо кур’єр доставить замовлення наступного дня, то й виплата буде врахована наступного дня.</li>
<li>Для отримання бонусної виплати кур’єрам необхідно доставити не менше ніж 5 замовлень протягом одного дня, тому якщо кур’єр прийме 5 замовлень протягом дня, але останній з них доставить після опівночі, бонусну виплату він не отримає.</li>
</ol>
<p>При розрахунку <strong>ПДВ</strong> враховуйте, що з <strong>деяких</strong> товарів податок становить <strong>не 10%, а 20%</strong>. Список товарів зі зниженим ПДВ:</p>
<pre><code>'sugar', 'crackers', 'drying', 'seeds',
'linseed oil', 'grapes', 'olive oil',
'watermelon', 'baton', 'yogurt', 'cream', 'buckwheat',
'oatmeal', 'pasta', 'mutton', 'oranges',
'bagels', 'bread', 'peas', 'sour cream', 'smoked fish',
'flour', 'sprats', 'sausages', 'pork', 'rice',
'sesame oil', 'condensed milk', 'pineapple', 'beef',
'salt', 'dried fish', 'sunflower oil', 'apples',
'pears', 'flatbread', 'milk', 'chicken', 'lavash', 'waffles', 'tangerines'</code></pre>
<p>Також при розрахунку величини ПДВ за кожним товаром округляйте значення <strong>до двох знаків після коми</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання необхідно для кожного дня окремо порахувати виручку, витрати та величину ПДВ, а потім об’єднати отримані таблиці для подальших розрахунків за допомогою віконних функцій. Виручку ми рахували в минулих завданнях, величину ПДВ ми також рахували на перших уроках - тепер це необхідно зробити для всіх товарів, куплених протягом кожного дня. Найскладніше у цьому - правильно обчислити витрати. Для цього необхідно для кожного дня порахувати кількість оформлених замовлень, кількість доставлених замовлень та кількість кур’єрів, що доставили 5 та більше замовлень. Потім необхідно кожного дня порахувати загальні витрати. Це можна зробити за допомогою конструкції <code>CASE</code>, підставивши постійні та змінні витрати на нескладну формулу, описану в умові.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-execution_count="20">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="op">%%</span>sql</span>
<span id="cb20-2"><a href="#cb20-2"></a>SELECT date,</span>
<span id="cb20-3"><a href="#cb20-3"></a>       revenue,</span>
<span id="cb20-4"><a href="#cb20-4"></a>       costs,</span>
<span id="cb20-5"><a href="#cb20-5"></a>       tax,</span>
<span id="cb20-6"><a href="#cb20-6"></a>       gross_profit,</span>
<span id="cb20-7"><a href="#cb20-7"></a>       total_revenue,</span>
<span id="cb20-8"><a href="#cb20-8"></a>       total_costs,</span>
<span id="cb20-9"><a href="#cb20-9"></a>       total_tax,</span>
<span id="cb20-10"><a href="#cb20-10"></a>       total_gross_profit,</span>
<span id="cb20-11"><a href="#cb20-11"></a>       <span class="bu">round</span>(gross_profit <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> gross_profit_ratio,</span>
<span id="cb20-12"><a href="#cb20-12"></a>       <span class="bu">round</span>(total_gross_profit <span class="op">/</span> total_revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> total_gross_profit_ratio</span>
<span id="cb20-13"><a href="#cb20-13"></a>FROM   (SELECT date,</span>
<span id="cb20-14"><a href="#cb20-14"></a>               revenue,</span>
<span id="cb20-15"><a href="#cb20-15"></a>               costs,</span>
<span id="cb20-16"><a href="#cb20-16"></a>               tax,</span>
<span id="cb20-17"><a href="#cb20-17"></a>               revenue <span class="op">-</span> costs <span class="op">-</span> tax <span class="im">as</span> gross_profit,</span>
<span id="cb20-18"><a href="#cb20-18"></a>               <span class="bu">sum</span>(revenue) OVER (ORDER BY date) <span class="im">as</span> total_revenue,</span>
<span id="cb20-19"><a href="#cb20-19"></a>               <span class="bu">sum</span>(costs) OVER (ORDER BY date) <span class="im">as</span> total_costs,</span>
<span id="cb20-20"><a href="#cb20-20"></a>               <span class="bu">sum</span>(tax) OVER (ORDER BY date) <span class="im">as</span> total_tax,</span>
<span id="cb20-21"><a href="#cb20-21"></a>               <span class="bu">sum</span>(revenue <span class="op">-</span> costs <span class="op">-</span> tax) OVER (ORDER BY date) <span class="im">as</span> total_gross_profit</span>
<span id="cb20-22"><a href="#cb20-22"></a>        FROM   (SELECT date,</span>
<span id="cb20-23"><a href="#cb20-23"></a>                       orders_packed,</span>
<span id="cb20-24"><a href="#cb20-24"></a>                       orders_delivered,</span>
<span id="cb20-25"><a href="#cb20-25"></a>                       couriers_count,</span>
<span id="cb20-26"><a href="#cb20-26"></a>                       revenue,</span>
<span id="cb20-27"><a href="#cb20-27"></a>                       <span class="cf">case</span> when date_part(<span class="st">'month'</span>,</span>
<span id="cb20-28"><a href="#cb20-28"></a>                                                                                                                                                                      date) <span class="op">=</span> <span class="dv">8</span> then <span class="fl">120000.0</span> <span class="op">+</span> <span class="dv">140</span> <span class="op">*</span> coalesce(orders_packed, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">150</span> <span class="op">*</span> coalesce(orders_delivered, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">400</span> <span class="op">*</span> coalesce(couriers_count, <span class="dv">0</span>)</span>
<span id="cb20-29"><a href="#cb20-29"></a>                            when date_part(<span class="st">'month'</span>,</span>
<span id="cb20-30"><a href="#cb20-30"></a>                                                                                                                                                                      date) <span class="op">=</span> <span class="dv">9</span> then <span class="fl">150000.0</span> <span class="op">+</span> <span class="dv">115</span> <span class="op">*</span> coalesce(orders_packed, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">150</span> <span class="op">*</span> coalesce(orders_delivered, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">500</span> <span class="op">*</span> coalesce(couriers_count, <span class="dv">0</span>) end <span class="im">as</span> costs,</span>
<span id="cb20-31"><a href="#cb20-31"></a>                       tax</span>
<span id="cb20-32"><a href="#cb20-32"></a>                FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb20-33"><a href="#cb20-33"></a>                               count(distinct order_id) <span class="im">as</span> orders_packed,</span>
<span id="cb20-34"><a href="#cb20-34"></a>                               <span class="bu">sum</span>(price) <span class="im">as</span> revenue,</span>
<span id="cb20-35"><a href="#cb20-35"></a>                               <span class="bu">sum</span>(tax) <span class="im">as</span> tax</span>
<span id="cb20-36"><a href="#cb20-36"></a>                        FROM   (SELECT order_id,</span>
<span id="cb20-37"><a href="#cb20-37"></a>                                       creation_time,</span>
<span id="cb20-38"><a href="#cb20-38"></a>                                       product_id,</span>
<span id="cb20-39"><a href="#cb20-39"></a>                                       name,</span>
<span id="cb20-40"><a href="#cb20-40"></a>                                       price,</span>
<span id="cb20-41"><a href="#cb20-41"></a>                                       <span class="cf">case</span> when name <span class="kw">in</span> (<span class="st">'sugar'</span>, <span class="st">'crackers'</span>, <span class="st">'drying'</span>, <span class="st">'seeds'</span>,</span>
<span id="cb20-42"><a href="#cb20-42"></a>                                                          <span class="st">'linseed oil'</span>, <span class="st">'grapes'</span>, <span class="st">'olive oil'</span>,</span>
<span id="cb20-43"><a href="#cb20-43"></a>                                                          <span class="st">'watermelon'</span>, <span class="st">'baton'</span>, <span class="st">'yogurt'</span>, <span class="st">'cream'</span>, <span class="st">'buckwheat'</span>,</span>
<span id="cb20-44"><a href="#cb20-44"></a>                                                          <span class="st">'oatmeal'</span>, <span class="st">'pasta'</span>, <span class="st">'mutton'</span>, <span class="st">'oranges'</span>,</span>
<span id="cb20-45"><a href="#cb20-45"></a>                                                          <span class="st">'bagels'</span>, <span class="st">'bread'</span>, <span class="st">'peas'</span>, <span class="st">'sour cream'</span>, <span class="st">'smoked fish'</span>,</span>
<span id="cb20-46"><a href="#cb20-46"></a>                                                          <span class="st">'flour'</span>, <span class="st">'sprats'</span>, <span class="st">'sausages'</span>, <span class="st">'pork'</span>, <span class="st">'rice'</span>,</span>
<span id="cb20-47"><a href="#cb20-47"></a>                                                          <span class="st">'sesame oil'</span>, <span class="st">'condensed milk'</span>, <span class="st">'pineapple'</span>, <span class="st">'beef'</span>,</span>
<span id="cb20-48"><a href="#cb20-48"></a>                                                          <span class="st">'salt'</span>, <span class="st">'dried fish'</span>, <span class="st">'sunflower oil'</span>, <span class="st">'apples'</span>,</span>
<span id="cb20-49"><a href="#cb20-49"></a>                                                          <span class="st">'pears'</span>, <span class="st">'flatbread'</span>, <span class="st">'milk'</span>, <span class="st">'chicken'</span>, <span class="st">'lavash'</span>, <span class="st">'waffles'</span>, <span class="st">'tangerines'</span>) then <span class="bu">round</span>(price<span class="op">/</span><span class="dv">110</span><span class="op">*</span><span class="dv">10</span>,</span>
<span id="cb20-50"><a href="#cb20-50"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span class="dv">2</span>)</span>
<span id="cb20-51"><a href="#cb20-51"></a>                                            <span class="cf">else</span> <span class="bu">round</span>(price<span class="op">/</span><span class="dv">120</span><span class="op">*</span><span class="dv">20</span>, <span class="dv">2</span>) end <span class="im">as</span> tax</span>
<span id="cb20-52"><a href="#cb20-52"></a>                                FROM   (SELECT order_id,</span>
<span id="cb20-53"><a href="#cb20-53"></a>                                               creation_time,</span>
<span id="cb20-54"><a href="#cb20-54"></a>                                               unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb20-55"><a href="#cb20-55"></a>                                        FROM   orders</span>
<span id="cb20-56"><a href="#cb20-56"></a>                                        WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb20-57"><a href="#cb20-57"></a>                                                                FROM   user_actions</span>
<span id="cb20-58"><a href="#cb20-58"></a>                                                                WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb20-59"><a href="#cb20-59"></a>                                    LEFT JOIN products using (product_id)) t2</span>
<span id="cb20-60"><a href="#cb20-60"></a>                        GROUP BY date) t3</span>
<span id="cb20-61"><a href="#cb20-61"></a>                    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb20-62"><a href="#cb20-62"></a>                                      count(distinct order_id) <span class="im">as</span> orders_delivered</span>
<span id="cb20-63"><a href="#cb20-63"></a>                               FROM   courier_actions</span>
<span id="cb20-64"><a href="#cb20-64"></a>                               WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb20-65"><a href="#cb20-65"></a>                                                       FROM   user_actions</span>
<span id="cb20-66"><a href="#cb20-66"></a>                                                       WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb20-67"><a href="#cb20-67"></a>                                  <span class="kw">and</span> action <span class="op">=</span> <span class="st">'deliver_order'</span></span>
<span id="cb20-68"><a href="#cb20-68"></a>                               GROUP BY date) t4 using (date)</span>
<span id="cb20-69"><a href="#cb20-69"></a>                    LEFT JOIN (SELECT date,</span>
<span id="cb20-70"><a href="#cb20-70"></a>                                      count(courier_id) <span class="im">as</span> couriers_count</span>
<span id="cb20-71"><a href="#cb20-71"></a>                               FROM   (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb20-72"><a href="#cb20-72"></a>                                              courier_id,</span>
<span id="cb20-73"><a href="#cb20-73"></a>                                              count(distinct order_id) <span class="im">as</span> orders_delivered</span>
<span id="cb20-74"><a href="#cb20-74"></a>                                       FROM   courier_actions</span>
<span id="cb20-75"><a href="#cb20-75"></a>                                       WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb20-76"><a href="#cb20-76"></a>                                                               FROM   user_actions</span>
<span id="cb20-77"><a href="#cb20-77"></a>                                                               WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb20-78"><a href="#cb20-78"></a>                                          <span class="kw">and</span> action <span class="op">=</span> <span class="st">'deliver_order'</span></span>
<span id="cb20-79"><a href="#cb20-79"></a>                                       GROUP BY date, courier_id having count(distinct order_id) <span class="op">&gt;=</span> <span class="dv">5</span>) t5</span>
<span id="cb20-80"><a href="#cb20-80"></a>                               GROUP BY date) t6 using (date)) t7) t8</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display column-page-inset" data-execution_count="20">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">revenue</th>
<th data-quarto-table-cell-role="th">costs</th>
<th data-quarto-table-cell-role="th">tax</th>
<th data-quarto-table-cell-role="th">gross_profit</th>
<th data-quarto-table-cell-role="th">total_revenue</th>
<th data-quarto-table-cell-role="th">total_costs</th>
<th data-quarto-table-cell-role="th">total_tax</th>
<th data-quarto-table-cell-role="th">total_gross_profit</th>
<th data-quarto-table-cell-role="th">gross_profit_ratio</th>
<th data-quarto-table-cell-role="th">total_gross_profit_ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-24</td>
<td>49924.0</td>
<td>159120.0</td>
<td>6459.77</td>
<td>-115655.77</td>
<td>49924.0</td>
<td>159120.0</td>
<td>6459.77</td>
<td>-115655.77</td>
<td>-231.66</td>
<td>-231.66</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-25</td>
<td>430860.0</td>
<td>447560.0</td>
<td>54458.71</td>
<td>-71158.71</td>
<td>480784.0</td>
<td>606680.0</td>
<td>60918.48</td>
<td>-186814.48</td>
<td>-16.52</td>
<td>-38.86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-26</td>
<td>534766.0</td>
<td>565680.0</td>
<td>67272.24</td>
<td>-98186.24</td>
<td>1015550.0</td>
<td>1172360.0</td>
<td>128190.72</td>
<td>-285000.72</td>
<td>-18.36</td>
<td>-28.06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-27</td>
<td>817053.0</td>
<td>781040.0</td>
<td>104010.94</td>
<td>-67997.94</td>
<td>1832603.0</td>
<td>1953400.0</td>
<td>232201.66</td>
<td>-352998.66</td>
<td>-8.32</td>
<td>-19.26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-28</td>
<td>1133370.0</td>
<td>1055870.0</td>
<td>143194.74</td>
<td>-65694.74</td>
<td>2965973.0</td>
<td>3009270.0</td>
<td>375396.40</td>
<td>-418693.40</td>
<td>-5.80</td>
<td>-14.12</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2022-08-29</td>
<td>1279891.0</td>
<td>1144280.0</td>
<td>163192.37</td>
<td>-27581.37</td>
<td>4245864.0</td>
<td>4153550.0</td>
<td>538588.77</td>
<td>-446274.77</td>
<td>-2.15</td>
<td>-10.51</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2022-08-30</td>
<td>1279377.0</td>
<td>1169140.0</td>
<td>161750.92</td>
<td>-51513.92</td>
<td>5525241.0</td>
<td>5322690.0</td>
<td>700339.69</td>
<td>-497788.69</td>
<td>-4.03</td>
<td>-9.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2022-08-31</td>
<td>1312720.0</td>
<td>1159250.0</td>
<td>165617.03</td>
<td>-12147.03</td>
<td>6837961.0</td>
<td>6481940.0</td>
<td>865956.72</td>
<td>-509935.72</td>
<td>-0.93</td>
<td>-7.46</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2022-09-01</td>
<td>1406101.0</td>
<td>1180320.0</td>
<td>178047.87</td>
<td>47733.13</td>
<td>8244062.0</td>
<td>7662260.0</td>
<td>1044004.59</td>
<td>-462202.59</td>
<td>3.39</td>
<td>-5.61</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2022-09-02</td>
<td>1907107.0</td>
<td>1590965.0</td>
<td>241912.13</td>
<td>74229.87</td>
<td>10151169.0</td>
<td>9253225.0</td>
<td>1285916.72</td>
<td>-387972.72</td>
<td>3.89</td>
<td>-3.82</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2022-09-03</td>
<td>2210988.0</td>
<td>1813235.0</td>
<td>280998.88</td>
<td>116754.12</td>
<td>12362157.0</td>
<td>11066460.0</td>
<td>1566915.60</td>
<td>-271218.60</td>
<td>5.28</td>
<td>-2.19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2022-09-04</td>
<td>2294009.0</td>
<td>1885300.0</td>
<td>293110.13</td>
<td>115598.87</td>
<td>14656166.0</td>
<td>12951760.0</td>
<td>1860025.73</td>
<td>-155619.73</td>
<td>5.04</td>
<td>-1.06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2022-09-05</td>
<td>1784690.0</td>
<td>1456825.0</td>
<td>226580.62</td>
<td>101284.38</td>
<td>16440856.0</td>
<td>14408585.0</td>
<td>2086606.35</td>
<td>-54335.35</td>
<td>5.68</td>
<td>-0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2022-09-06</td>
<td>1330931.0</td>
<td>1077765.0</td>
<td>168922.71</td>
<td>84243.29</td>
<td>17771787.0</td>
<td>15486350.0</td>
<td>2255529.06</td>
<td>29907.94</td>
<td>6.33</td>
<td>0.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2022-09-07</td>
<td>1807800.0</td>
<td>1452755.0</td>
<td>230027.23</td>
<td>125017.77</td>
<td>19579587.0</td>
<td>16939105.0</td>
<td>2485556.29</td>
<td>154925.71</td>
<td>6.92</td>
<td>0.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2022-09-08</td>
<td>2099508.0</td>
<td>1669410.0</td>
<td>268110.26</td>
<td>161987.74</td>
<td>21679095.0</td>
<td>18608515.0</td>
<td>2753666.55</td>
<td>316913.45</td>
<td>7.72</td>
<td>1.46</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_7</code>:</p>
<div class="cell" data-execution_count="21">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="op">%%</span>sql</span>
<span id="cb21-2"><a href="#cb21-2"></a>results_7 <span class="op">&lt;&lt;</span> SELECT date,</span>
<span id="cb21-3"><a href="#cb21-3"></a>       revenue,</span>
<span id="cb21-4"><a href="#cb21-4"></a>       costs,</span>
<span id="cb21-5"><a href="#cb21-5"></a>       tax,</span>
<span id="cb21-6"><a href="#cb21-6"></a>       gross_profit,</span>
<span id="cb21-7"><a href="#cb21-7"></a>       total_revenue,</span>
<span id="cb21-8"><a href="#cb21-8"></a>       total_costs,</span>
<span id="cb21-9"><a href="#cb21-9"></a>       total_tax,</span>
<span id="cb21-10"><a href="#cb21-10"></a>       total_gross_profit,</span>
<span id="cb21-11"><a href="#cb21-11"></a>       <span class="bu">round</span>(gross_profit <span class="op">/</span> revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> gross_profit_ratio,</span>
<span id="cb21-12"><a href="#cb21-12"></a>       <span class="bu">round</span>(total_gross_profit <span class="op">/</span> total_revenue <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> total_gross_profit_ratio</span>
<span id="cb21-13"><a href="#cb21-13"></a>FROM   (SELECT date,</span>
<span id="cb21-14"><a href="#cb21-14"></a>               revenue,</span>
<span id="cb21-15"><a href="#cb21-15"></a>               costs,</span>
<span id="cb21-16"><a href="#cb21-16"></a>               tax,</span>
<span id="cb21-17"><a href="#cb21-17"></a>               revenue <span class="op">-</span> costs <span class="op">-</span> tax <span class="im">as</span> gross_profit,</span>
<span id="cb21-18"><a href="#cb21-18"></a>               <span class="bu">sum</span>(revenue) OVER (ORDER BY date) <span class="im">as</span> total_revenue,</span>
<span id="cb21-19"><a href="#cb21-19"></a>               <span class="bu">sum</span>(costs) OVER (ORDER BY date) <span class="im">as</span> total_costs,</span>
<span id="cb21-20"><a href="#cb21-20"></a>               <span class="bu">sum</span>(tax) OVER (ORDER BY date) <span class="im">as</span> total_tax,</span>
<span id="cb21-21"><a href="#cb21-21"></a>               <span class="bu">sum</span>(revenue <span class="op">-</span> costs <span class="op">-</span> tax) OVER (ORDER BY date) <span class="im">as</span> total_gross_profit</span>
<span id="cb21-22"><a href="#cb21-22"></a>        FROM   (SELECT date,</span>
<span id="cb21-23"><a href="#cb21-23"></a>                       orders_packed,</span>
<span id="cb21-24"><a href="#cb21-24"></a>                       orders_delivered,</span>
<span id="cb21-25"><a href="#cb21-25"></a>                       couriers_count,</span>
<span id="cb21-26"><a href="#cb21-26"></a>                       revenue,</span>
<span id="cb21-27"><a href="#cb21-27"></a>                       <span class="cf">case</span> when date_part(<span class="st">'month'</span>, date) <span class="op">=</span> <span class="dv">8</span> then <span class="fl">120000.0</span> <span class="op">+</span> <span class="dv">140</span> <span class="op">*</span> coalesce(orders_packed, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">150</span> <span class="op">*</span> coalesce(orders_delivered, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">400</span> <span class="op">*</span> coalesce(couriers_count, <span class="dv">0</span>)</span>
<span id="cb21-28"><a href="#cb21-28"></a>                            when date_part(<span class="st">'month'</span>, date) <span class="op">=</span> <span class="dv">9</span> then <span class="fl">150000.0</span> <span class="op">+</span> <span class="dv">115</span> <span class="op">*</span> coalesce(orders_packed, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">150</span> <span class="op">*</span> coalesce(orders_delivered, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">500</span> <span class="op">*</span> coalesce(couriers_count, <span class="dv">0</span>) end <span class="im">as</span> costs,</span>
<span id="cb21-29"><a href="#cb21-29"></a>                       tax</span>
<span id="cb21-30"><a href="#cb21-30"></a>                FROM   (SELECT creation_time::date <span class="im">as</span> date,</span>
<span id="cb21-31"><a href="#cb21-31"></a>                               count(distinct order_id) <span class="im">as</span> orders_packed,</span>
<span id="cb21-32"><a href="#cb21-32"></a>                               <span class="bu">sum</span>(price) <span class="im">as</span> revenue,</span>
<span id="cb21-33"><a href="#cb21-33"></a>                               <span class="bu">sum</span>(tax) <span class="im">as</span> tax</span>
<span id="cb21-34"><a href="#cb21-34"></a>                        FROM   (SELECT order_id,</span>
<span id="cb21-35"><a href="#cb21-35"></a>                                       creation_time,</span>
<span id="cb21-36"><a href="#cb21-36"></a>                                       product_id,</span>
<span id="cb21-37"><a href="#cb21-37"></a>                                       name,</span>
<span id="cb21-38"><a href="#cb21-38"></a>                                       price,</span>
<span id="cb21-39"><a href="#cb21-39"></a>                                       <span class="cf">case</span> when name <span class="kw">in</span> (<span class="st">'sugar'</span>, <span class="st">'crackers'</span>, <span class="st">'drying'</span>, <span class="st">'seeds'</span>,</span>
<span id="cb21-40"><a href="#cb21-40"></a>                                                          <span class="st">'linseed oil'</span>, <span class="st">'grapes'</span>, <span class="st">'olive oil'</span>,</span>
<span id="cb21-41"><a href="#cb21-41"></a>                                                          <span class="st">'watermelon'</span>, <span class="st">'baton'</span>, <span class="st">'yogurt'</span>, <span class="st">'cream'</span>, <span class="st">'buckwheat'</span>,</span>
<span id="cb21-42"><a href="#cb21-42"></a>                                                          <span class="st">'oatmeal'</span>, <span class="st">'pasta'</span>, <span class="st">'mutton'</span>, <span class="st">'oranges'</span>,</span>
<span id="cb21-43"><a href="#cb21-43"></a>                                                          <span class="st">'bagels'</span>, <span class="st">'bread'</span>, <span class="st">'peas'</span>, <span class="st">'sour cream'</span>, <span class="st">'smoked fish'</span>,</span>
<span id="cb21-44"><a href="#cb21-44"></a>                                                          <span class="st">'flour'</span>, <span class="st">'sprats'</span>, <span class="st">'sausages'</span>, <span class="st">'pork'</span>, <span class="st">'rice'</span>,</span>
<span id="cb21-45"><a href="#cb21-45"></a>                                                          <span class="st">'sesame oil'</span>, <span class="st">'condensed milk'</span>, <span class="st">'pineapple'</span>, <span class="st">'beef'</span>,</span>
<span id="cb21-46"><a href="#cb21-46"></a>                                                          <span class="st">'salt'</span>, <span class="st">'dried fish'</span>, <span class="st">'sunflower oil'</span>, <span class="st">'apples'</span>,</span>
<span id="cb21-47"><a href="#cb21-47"></a>                                                          <span class="st">'pears'</span>, <span class="st">'flatbread'</span>, <span class="st">'milk'</span>, <span class="st">'chicken'</span>, <span class="st">'lavash'</span>, <span class="st">'waffles'</span>, <span class="st">'tangerines'</span>) then <span class="bu">round</span>(price<span class="op">/</span><span class="dv">110</span><span class="op">*</span><span class="dv">10</span>,</span>
<span id="cb21-48"><a href="#cb21-48"></a>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span class="dv">2</span>)</span>
<span id="cb21-49"><a href="#cb21-49"></a>                                            <span class="cf">else</span> <span class="bu">round</span>(price<span class="op">/</span><span class="dv">120</span><span class="op">*</span><span class="dv">20</span>, <span class="dv">2</span>) end <span class="im">as</span> tax</span>
<span id="cb21-50"><a href="#cb21-50"></a>                                FROM   (SELECT order_id,</span>
<span id="cb21-51"><a href="#cb21-51"></a>                                               creation_time,</span>
<span id="cb21-52"><a href="#cb21-52"></a>                                               unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb21-53"><a href="#cb21-53"></a>                                        FROM   orders</span>
<span id="cb21-54"><a href="#cb21-54"></a>                                        WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb21-55"><a href="#cb21-55"></a>                                                                FROM   user_actions</span>
<span id="cb21-56"><a href="#cb21-56"></a>                                                                WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)) t1</span>
<span id="cb21-57"><a href="#cb21-57"></a>                                    LEFT JOIN products using (product_id)) t2</span>
<span id="cb21-58"><a href="#cb21-58"></a>                        GROUP BY date) t3</span>
<span id="cb21-59"><a href="#cb21-59"></a>                    LEFT JOIN (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb21-60"><a href="#cb21-60"></a>                                      count(distinct order_id) <span class="im">as</span> orders_delivered</span>
<span id="cb21-61"><a href="#cb21-61"></a>                               FROM   courier_actions</span>
<span id="cb21-62"><a href="#cb21-62"></a>                               WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb21-63"><a href="#cb21-63"></a>                                                       FROM   user_actions</span>
<span id="cb21-64"><a href="#cb21-64"></a>                                                       WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb21-65"><a href="#cb21-65"></a>                                  <span class="kw">and</span> action <span class="op">=</span> <span class="st">'deliver_order'</span></span>
<span id="cb21-66"><a href="#cb21-66"></a>                               GROUP BY date) t4 using (date)</span>
<span id="cb21-67"><a href="#cb21-67"></a>                    LEFT JOIN (SELECT date,</span>
<span id="cb21-68"><a href="#cb21-68"></a>                                      count(courier_id) <span class="im">as</span> couriers_count</span>
<span id="cb21-69"><a href="#cb21-69"></a>                               FROM   (SELECT time::date <span class="im">as</span> date,</span>
<span id="cb21-70"><a href="#cb21-70"></a>                                              courier_id,</span>
<span id="cb21-71"><a href="#cb21-71"></a>                                              count(distinct order_id) <span class="im">as</span> orders_delivered</span>
<span id="cb21-72"><a href="#cb21-72"></a>                                       FROM   courier_actions</span>
<span id="cb21-73"><a href="#cb21-73"></a>                                       WHERE  order_id <span class="kw">not</span> <span class="kw">in</span> (SELECT order_id</span>
<span id="cb21-74"><a href="#cb21-74"></a>                                                               FROM   user_actions</span>
<span id="cb21-75"><a href="#cb21-75"></a>                                                               WHERE  action <span class="op">=</span> <span class="st">'cancel_order'</span>)</span>
<span id="cb21-76"><a href="#cb21-76"></a>                                          <span class="kw">and</span> action <span class="op">=</span> <span class="st">'deliver_order'</span></span>
<span id="cb21-77"><a href="#cb21-77"></a>                                       GROUP BY date, courier_id having count(distinct order_id) <span class="op">&gt;=</span> <span class="dv">5</span>) t5</span>
<span id="cb21-78"><a href="#cb21-78"></a>                               GROUP BY date) t6 using (date)) t7) t8</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="page-columns page-full">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a>fig <span class="op">=</span> make_subplots(specs<span class="op">=</span>[[{<span class="st">"secondary_y"</span>: <span class="va">True</span>}]])</span>
<span id="cb22-4"><a href="#cb22-4"></a>fig.add_trace(</span>
<span id="cb22-5"><a href="#cb22-5"></a>    go.Bar(</span>
<span id="cb22-6"><a href="#cb22-6"></a>        name<span class="op">=</span><span class="st">"gross_profit_ratio"</span>,</span>
<span id="cb22-7"><a href="#cb22-7"></a>        x<span class="op">=</span>results_7.date,</span>
<span id="cb22-8"><a href="#cb22-8"></a>        y<span class="op">=</span>results_7.gross_profit_ratio,</span>
<span id="cb22-9"><a href="#cb22-9"></a>        offsetgroup<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-10"><a href="#cb22-10"></a>    ),</span>
<span id="cb22-11"><a href="#cb22-11"></a>    secondary_y<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-12"><a href="#cb22-12"></a>)</span>
<span id="cb22-13"><a href="#cb22-13"></a>fig.add_trace(</span>
<span id="cb22-14"><a href="#cb22-14"></a>    go.Scatter(</span>
<span id="cb22-15"><a href="#cb22-15"></a>        name<span class="op">=</span><span class="st">"gross_profit"</span>, x<span class="op">=</span>results_7.date, y<span class="op">=</span>results_7.gross_profit, offsetgroup<span class="op">=</span><span class="dv">2</span></span>
<span id="cb22-16"><a href="#cb22-16"></a>    ),</span>
<span id="cb22-17"><a href="#cb22-17"></a>    secondary_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-18"><a href="#cb22-18"></a>)</span>
<span id="cb22-19"><a href="#cb22-19"></a>fig.update_yaxes(<span class="bu">range</span><span class="op">=</span>[<span class="op">-</span><span class="dv">150000</span>, <span class="dv">150000</span>], secondary_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-20"><a href="#cb22-20"></a>fig.update_yaxes(<span class="bu">range</span><span class="op">=</span>[<span class="op">-</span><span class="dv">250</span>, <span class="dv">250</span>], secondary_y<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-21"><a href="#cb22-21"></a>fig.update_layout(</span>
<span id="cb22-22"><a href="#cb22-22"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb22-23"><a href="#cb22-23"></a>)</span>
<span id="cb22-24"><a href="#cb22-24"></a></span>
<span id="cb22-25"><a href="#cb22-25"></a>fig.show()</span>
<span id="cb22-26"><a href="#cb22-26"></a></span>
<span id="cb22-27"><a href="#cb22-27"></a>fig <span class="op">=</span> make_subplots(specs<span class="op">=</span>[[{<span class="st">"secondary_y"</span>: <span class="va">True</span>}]])</span>
<span id="cb22-28"><a href="#cb22-28"></a>fig.add_trace(</span>
<span id="cb22-29"><a href="#cb22-29"></a>    go.Bar(</span>
<span id="cb22-30"><a href="#cb22-30"></a>        name<span class="op">=</span><span class="st">"total_gross_profit_ratio"</span>,</span>
<span id="cb22-31"><a href="#cb22-31"></a>        x<span class="op">=</span>results_7.date,</span>
<span id="cb22-32"><a href="#cb22-32"></a>        y<span class="op">=</span>results_7.total_gross_profit_ratio,</span>
<span id="cb22-33"><a href="#cb22-33"></a>        offsetgroup<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-34"><a href="#cb22-34"></a>    ),</span>
<span id="cb22-35"><a href="#cb22-35"></a>    secondary_y<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-36"><a href="#cb22-36"></a>)</span>
<span id="cb22-37"><a href="#cb22-37"></a>fig.add_trace(</span>
<span id="cb22-38"><a href="#cb22-38"></a>    go.Scatter(</span>
<span id="cb22-39"><a href="#cb22-39"></a>        name<span class="op">=</span><span class="st">"total_gross_profit"</span>,</span>
<span id="cb22-40"><a href="#cb22-40"></a>        x<span class="op">=</span>results_7.date,</span>
<span id="cb22-41"><a href="#cb22-41"></a>        y<span class="op">=</span>results_7.total_gross_profit,</span>
<span id="cb22-42"><a href="#cb22-42"></a>        offsetgroup<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb22-43"><a href="#cb22-43"></a>    ),</span>
<span id="cb22-44"><a href="#cb22-44"></a>    secondary_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-45"><a href="#cb22-45"></a>)</span>
<span id="cb22-46"><a href="#cb22-46"></a>fig.update_yaxes(<span class="bu">range</span><span class="op">=</span>[<span class="op">-</span><span class="dv">1200000</span>, <span class="dv">400000</span>], secondary_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-47"><a href="#cb22-47"></a>fig.update_yaxes(<span class="bu">range</span><span class="op">=</span>[<span class="op">-</span><span class="dv">300</span>, <span class="dv">100</span>], secondary_y<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-48"><a href="#cb22-48"></a>fig.update_layout(</span>
<span id="cb22-49"><a href="#cb22-49"></a>    legend<span class="op">=</span><span class="bu">dict</span>(orientation<span class="op">=</span><span class="st">"h"</span>, yanchor<span class="op">=</span><span class="st">"bottom"</span>, y<span class="op">=</span><span class="fl">1.02</span>, xanchor<span class="op">=</span><span class="st">"right"</span>, x<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb22-50"><a href="#cb22-50"></a>)</span>
<span id="cb22-51"><a href="#cb22-51"></a></span>
<span id="cb22-52"><a href="#cb22-52"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-07" class="cell column-screen-inset-shaded quarto-layout-panel" data-execution_count="22">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="fig-sql-metrics-07-1" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="ea076f5d-c3cd-41a5-b731-d3c6e258cf8a" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("ea076f5d-c3cd-41a5-b731-d3c6e258cf8a")) {                    Plotly.newPlot(                        "ea076f5d-c3cd-41a5-b731-d3c6e258cf8a",                        [{"name":"gross_profit_ratio","offsetgroup":"1","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[-231.66,-16.52,-18.36,-8.32,-5.8,-2.15,-4.03,-0.93,3.39,3.89,5.28,5.04,5.68,6.33,6.92,7.72],"type":"bar","xaxis":"x","yaxis":"y"},{"name":"gross_profit","offsetgroup":"2","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[-115655.77,-71158.71000000005,-98186.23999999996,-67997.94000000086,-65694.74000000124,-27581.370000002877,-51513.92000000336,-12147.0300000032,47733.12999999573,74229.86999999094,116754.11999999057,115598.869999988,101284.37999999209,84243.28999999788,125017.76999999335,161987.73999999155],"type":"scatter","xaxis":"x","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.94]},"yaxis":{"anchor":"x","domain":[0.0,1.0],"range":[-250,250]},"yaxis2":{"anchor":"x","overlaying":"y","side":"right","range":[-150000,150000]},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('ea076f5d-c3cd-41a5-b731-d3c6e258cf8a');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(a) Динаміка валового прибутку та частки валового прибутку у виручці на поточний день</figcaption>
</figure>
</div>
<div id="fig-sql-metrics-07-2" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="7e8cfef5-dcd6-4e71-b623-64fa87f3ff31" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("7e8cfef5-dcd6-4e71-b623-64fa87f3ff31")) {                    Plotly.newPlot(                        "7e8cfef5-dcd6-4e71-b623-64fa87f3ff31",                        [{"name":"total_gross_profit_ratio","offsetgroup":"1","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[-231.66,-38.86,-28.06,-19.26,-14.12,-10.51,-9.01,-7.46,-5.61,-3.82,-2.19,-1.06,-0.33,0.17,0.79,1.46],"type":"bar","xaxis":"x","yaxis":"y"},{"name":"total_gross_profit","offsetgroup":"2","x":["2022-08-24","2022-08-25","2022-08-26","2022-08-27","2022-08-28","2022-08-29","2022-08-30","2022-08-31","2022-09-01","2022-09-02","2022-09-03","2022-09-04","2022-09-05","2022-09-06","2022-09-07","2022-09-08"],"y":[-115655.77,-186814.48000000004,-285000.72,-352998.66000000085,-418693.4000000021,-446274.770000005,-497788.6900000084,-509935.7200000116,-462202.5900000159,-387972.720000025,-271218.60000003444,-155619.73000004643,-54335.35000005434,29907.93999994354,154925.7099999369,316913.4499999285],"type":"scatter","xaxis":"x","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.94]},"yaxis":{"anchor":"x","domain":[0.0,1.0],"range":[-300,100]},"yaxis2":{"anchor":"x","overlaying":"y","side":"right","range":[-1200000,400000]},"legend":{"orientation":"h","yanchor":"bottom","y":1.02,"xanchor":"right","x":1}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('7e8cfef5-dcd6-4e71-b623-64fa87f3ff31');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(b) Динаміка сумарного виторгу та частки сумарного валового прибутку в сумарному виторгу на поточний день.</figcaption>
</figure>
</div>
</div>
<p></p><figcaption class="figure-caption">Рисунок&nbsp;18.7: Графік за результатами SQL-запиту</figcaption><p></p>
</figure>
</div>
</div>
<p>Проаналізуйте побудовані графіки та спробуйте відповісти на такі питання:</p>
<ol type="1">
<li>Починаючи з якого дня щоденний валовий прибуток нашого сервісу став позитивним?</li>
<li>У який день сумарний валовий прибуток перевищив нульову позначку та сервіс уперше «вийшов у плюс» за цим показником?</li>
<li>Чи можна сказати, що оптимізація вартості складання замовлення у вересні дозволила побачити цього місяця позитивний валовий прибуток?</li>
</ol>
</section>
<section id="customer-acquisition-cost-cac" class="level2" data-number="18.6">
<h2 data-number="18.6" class="anchored" data-anchor-id="customer-acquisition-cost-cac"><span class="header-section-number">18.6</span> Customer Acquisition Cost (CAC)</h2>
<p>Познайомимося з метриками, які допомагають оцінити ефективність нашого маркетингу — наскільки ефективно ми залучаємо користувачів до нашого додатку.</p>
<p>Спочатку розглянемо метрику <strong>CAC (Customer Acquisition Cost)</strong>, яка відображає <strong>витрати на залучення одного покупця</strong>.</p>
<p>Уявімо ситуацію: до нас звернулися маркетологи з проханням порівняти дві рекламні кампанії.</p>
<p>У рекламній <strong>кампанії №1</strong> про наш додаток розповів відомий блогер на Youtube-каналі про кулінарії. На цю інтеграцію сумарно витратили <strong>250 000 грошових одиниць</strong>. Внаслідок цієї кампанії <strong>1 вересня</strong> у додатку зареєструвалася <strong>171 особа</strong>.</p>
<p>У рамках рекламної <strong>кампанії №2</strong> користувачам показували таргетовану рекламу у соціальних мережах. На це теж сумарно витратили <strong>250 000 грошових одиниць</strong>, і в результаті <strong>1 вересня</strong> у нас з’явилося <strong>236 нових користувачів</strong>.</p>
<p>Як нам оцінити, який із каналів залучення спрацював краще? На перший погляд, друга кампанія показала себе краще, оскільки нам удалося залучити більше людей за ті самі гроші. Але не поспішатимемо з висновками — давайте спочатку проведемо докладніший аналіз і розрахуємо <strong>CAC</strong> для двох рекламних кампаній.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-08" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.8 </strong></span><br> На основі таблиці <code>user_actions</code> розрахуйте метрику <strong>CAC</strong> для двох рекламних кампаній.</p>
<p>Список id користувачів, що прийшли після <strong>рекламної кампанії №1</strong>:</p>
<pre><code>8631, 8632, 8638, 8643, 8657, 8673, 8706, 8707, 8715, 8723, 8732, 8739, 8741, 
8750, 8751, 8752, 8770, 8774, 8788, 8791, 8804, 8810, 8815, 8828, 8830, 8845, 
8853, 8859, 8867, 8869, 8876, 8879, 8883, 8896, 8909, 8911, 8933, 8940, 8972, 
8976, 8988, 8990, 9002, 9004, 9009, 9019, 9020, 9035, 9036, 9061, 9069, 9071, 
9075, 9081, 9085, 9089, 9108, 9113, 9144, 9145, 9146, 9162, 9165, 9167, 9175, 
9180, 9182, 9197, 9198, 9210, 9223, 9251, 9257, 9278, 9287, 9291, 9313, 9317, 
9321, 9334, 9351, 9391, 9398, 9414, 9420, 9422, 9431, 9450, 9451, 9454, 9472, 
9476, 9478, 9491, 9494, 9505, 9512, 9518, 9524, 9526, 9528, 9531, 9535, 9550, 
9559, 9561, 9562, 9599, 9603, 9605, 9611, 9612, 9615, 9625, 9633, 9652, 9654, 
9655, 9660, 9662, 9667, 9677, 9679, 9689, 9695, 9720, 9726, 9739, 9740, 9762, 
9778, 9786, 9794, 9804, 9810, 9813, 9818, 9828, 9831, 9836, 9838, 9845, 9871, 
9887, 9891, 9896, 9897, 9916, 9945, 9960, 9963, 9965, 9968, 9971, 9993, 9998, 
9999, 10001, 10013, 10016, 10023, 10030, 10051, 10057, 10064, 10082, 10103, 
10105, 10122, 10134, 10135</code></pre>
<p>Список id користувачів, що прийшли після <strong>рекламної кампанії №2</strong>:</p>
<pre><code>8629, 8630, 8644, 8646, 8650, 8655, 8659, 8660, 8663, 8665, 8670, 8675, 8680, 8681, 
8682, 8683, 8694, 8697, 8700, 8704, 8712, 8713, 8719, 8729, 8733, 8742, 8748, 8754, 
8771, 8794, 8795, 8798, 8803, 8805, 8806, 8812, 8814, 8825, 8827, 8838, 8849, 8851, 
8854, 8855, 8870, 8878, 8882, 8886, 8890, 8893, 8900, 8902, 8913, 8916, 8923, 8929, 
8935, 8942, 8943, 8949, 8953, 8955, 8966, 8968, 8971, 8973, 8980, 8995, 8999, 9000, 
9007, 9013, 9041, 9042, 9047, 9064, 9068, 9077, 9082, 9083, 9095, 9103, 9109, 9117, 
9123, 9127, 9131, 9137, 9140, 9149, 9161, 9179, 9181, 9183, 9185, 9190, 9196, 9203, 
9207, 9226, 9227, 9229, 9230, 9231, 9250, 9255, 9259, 9267, 9273, 9281, 9282, 9289, 
9292, 9303, 9310, 9312, 9315, 9327, 9333, 9335, 9337, 9343, 9356, 9368, 9370, 9383, 
9392, 9404, 9410, 9421, 9428, 9432, 9437, 9468, 9479, 9483, 9485, 9492, 9495, 9497, 
9498, 9500, 9510, 9527, 9529, 9530, 9538, 9539, 9545, 9557, 9558, 9560, 9564, 9567, 
9570, 9591, 9596, 9598, 9616, 9631, 9634, 9635, 9636, 9658, 9666, 9672, 9684, 9692, 
9700, 9704, 9706, 9711, 9719, 9727, 9735, 9741, 9744, 9749, 9752, 9753, 9755, 9757, 
9764, 9783, 9784, 9788, 9790, 9808, 9820, 9839, 9841, 9843, 9853, 9855, 9859, 9863, 
9877, 9879, 9880, 9882, 9883, 9885, 9901, 9904, 9908, 9910, 9912, 9920, 9929, 9930, 
9935, 9939, 9958, 9959, 9961, 9983, 10027, 10033, 10038, 10045, 10047, 10048, 10058, 
10059, 10067, 10069, 10073, 10075, 10078, 10079, 10081, 10092, 10106, 10110, 10113, 10131</code></pre>
<p>Назвіть колонку з найменуваннями кампаній <code>ads_campaign</code>, а колонку зі значенням метрики — <code>cac</code>.</p>
<p>Назви кампаній виведіть у такому вигляді:</p>
<pre><code>Company № 1
Company № 2</code></pre>
<p>Отримані значення метрики заокругліть <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зменшенням значення метрики.</p>
<p>Поля у результуючій таблиці: <code>ads_campaign</code>, <code>cac</code></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Для вирішення завдання спочатку необхідно відібрати користувачів, що прийшли після проведення рекламних кампаній, а потім серед них відібрати тих, хто став покупцем, тобто зробив хоча б одне замовлення. Далі кожної групи за нескладною формулою можна розрахувати метрику CAC.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="23">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="op">%%</span>sql</span>
<span id="cb26-2"><a href="#cb26-2"></a>SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb26-3"><a href="#cb26-3"></a>       <span class="bu">round</span>(<span class="fl">250000.0</span> <span class="op">/</span> count(distinct user_id), <span class="dv">2</span>) <span class="im">as</span> cac</span>
<span id="cb26-4"><a href="#cb26-4"></a>FROM   (SELECT user_id,</span>
<span id="cb26-5"><a href="#cb26-5"></a>               order_id,</span>
<span id="cb26-6"><a href="#cb26-6"></a>               action,</span>
<span id="cb26-7"><a href="#cb26-7"></a>               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb26-8"><a href="#cb26-8"></a>                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb26-9"><a href="#cb26-9"></a>                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb26-10"><a href="#cb26-10"></a>                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb26-11"><a href="#cb26-11"></a>                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb26-12"><a href="#cb26-12"></a>                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb26-13"><a href="#cb26-13"></a>                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb26-14"><a href="#cb26-14"></a>                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb26-15"><a href="#cb26-15"></a>                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb26-16"><a href="#cb26-16"></a>                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb26-17"><a href="#cb26-17"></a>                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb26-18"><a href="#cb26-18"></a>                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb26-19"><a href="#cb26-19"></a>                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb26-20"><a href="#cb26-20"></a>                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb26-21"><a href="#cb26-21"></a>                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb26-22"><a href="#cb26-22"></a>                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb26-23"><a href="#cb26-23"></a>                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb26-24"><a href="#cb26-24"></a>                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb26-25"><a href="#cb26-25"></a>                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb26-26"><a href="#cb26-26"></a>                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb26-27"><a href="#cb26-27"></a>                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb26-28"><a href="#cb26-28"></a>                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb26-29"><a href="#cb26-29"></a>                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb26-30"><a href="#cb26-30"></a>                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb26-31"><a href="#cb26-31"></a>                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb26-32"><a href="#cb26-32"></a>                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb26-33"><a href="#cb26-33"></a>                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb26-34"><a href="#cb26-34"></a>                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb26-35"><a href="#cb26-35"></a>                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb26-36"><a href="#cb26-36"></a>                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb26-37"><a href="#cb26-37"></a>                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb26-38"><a href="#cb26-38"></a>                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb26-39"><a href="#cb26-39"></a>                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb26-40"><a href="#cb26-40"></a>                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb26-41"><a href="#cb26-41"></a>                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb26-42"><a href="#cb26-42"></a>                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb26-43"><a href="#cb26-43"></a>                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb26-44"><a href="#cb26-44"></a>                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb26-45"><a href="#cb26-45"></a>                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb26-46"><a href="#cb26-46"></a>                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb26-47"><a href="#cb26-47"></a>                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb26-48"><a href="#cb26-48"></a>                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb26-49"><a href="#cb26-49"></a>                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb26-50"><a href="#cb26-50"></a>                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb26-51"><a href="#cb26-51"></a>                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb26-52"><a href="#cb26-52"></a>                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb26-53"><a href="#cb26-53"></a>                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb26-54"><a href="#cb26-54"></a>               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb26-55"><a href="#cb26-55"></a>        FROM   user_actions) t1</span>
<span id="cb26-56"><a href="#cb26-56"></a>WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb26-57"><a href="#cb26-57"></a>   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb26-58"><a href="#cb26-58"></a>GROUP BY ads_campaign</span>
<span id="cb26-59"><a href="#cb26-59"></a>ORDER BY cac desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ads_campaign</th>
<th data-quarto-table-cell-role="th">cac</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Company № 1</td>
<td>1461.99</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Company № 2</td>
<td>1068.38</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_8</code>:</p>
<div class="cell" data-execution_count="24">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="op">%%</span>sql</span>
<span id="cb27-2"><a href="#cb27-2"></a>results_8 <span class="op">&lt;&lt;</span> SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb27-3"><a href="#cb27-3"></a>       <span class="bu">round</span>(<span class="fl">250000.0</span> <span class="op">/</span> count(distinct user_id), <span class="dv">2</span>) <span class="im">as</span> cac</span>
<span id="cb27-4"><a href="#cb27-4"></a>FROM   (SELECT user_id,</span>
<span id="cb27-5"><a href="#cb27-5"></a>               order_id,</span>
<span id="cb27-6"><a href="#cb27-6"></a>               action,</span>
<span id="cb27-7"><a href="#cb27-7"></a>               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb27-8"><a href="#cb27-8"></a>                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb27-9"><a href="#cb27-9"></a>                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb27-10"><a href="#cb27-10"></a>                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb27-11"><a href="#cb27-11"></a>                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb27-12"><a href="#cb27-12"></a>                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb27-13"><a href="#cb27-13"></a>                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb27-14"><a href="#cb27-14"></a>                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb27-15"><a href="#cb27-15"></a>                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb27-16"><a href="#cb27-16"></a>                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb27-17"><a href="#cb27-17"></a>                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb27-18"><a href="#cb27-18"></a>                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb27-19"><a href="#cb27-19"></a>                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb27-20"><a href="#cb27-20"></a>                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb27-21"><a href="#cb27-21"></a>                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb27-22"><a href="#cb27-22"></a>                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb27-23"><a href="#cb27-23"></a>                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb27-24"><a href="#cb27-24"></a>                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb27-25"><a href="#cb27-25"></a>                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb27-26"><a href="#cb27-26"></a>                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb27-27"><a href="#cb27-27"></a>                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb27-28"><a href="#cb27-28"></a>                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb27-29"><a href="#cb27-29"></a>                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb27-30"><a href="#cb27-30"></a>                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb27-31"><a href="#cb27-31"></a>                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb27-32"><a href="#cb27-32"></a>                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb27-33"><a href="#cb27-33"></a>                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb27-34"><a href="#cb27-34"></a>                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb27-35"><a href="#cb27-35"></a>                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb27-36"><a href="#cb27-36"></a>                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb27-37"><a href="#cb27-37"></a>                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb27-38"><a href="#cb27-38"></a>                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb27-39"><a href="#cb27-39"></a>                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb27-40"><a href="#cb27-40"></a>                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb27-41"><a href="#cb27-41"></a>                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb27-42"><a href="#cb27-42"></a>                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb27-43"><a href="#cb27-43"></a>                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb27-44"><a href="#cb27-44"></a>                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb27-45"><a href="#cb27-45"></a>                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb27-46"><a href="#cb27-46"></a>                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb27-47"><a href="#cb27-47"></a>                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb27-48"><a href="#cb27-48"></a>                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb27-49"><a href="#cb27-49"></a>                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb27-50"><a href="#cb27-50"></a>                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb27-51"><a href="#cb27-51"></a>                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb27-52"><a href="#cb27-52"></a>                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb27-53"><a href="#cb27-53"></a>                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb27-54"><a href="#cb27-54"></a>               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb27-55"><a href="#cb27-55"></a>        FROM   user_actions) t1</span>
<span id="cb27-56"><a href="#cb27-56"></a>WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb27-57"><a href="#cb27-57"></a>   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-58"><a href="#cb27-58"></a>GROUP BY ads_campaign</span>
<span id="cb27-59"><a href="#cb27-59"></a>ORDER BY cac desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>fig <span class="op">=</span> px.bar(results_8, x<span class="op">=</span><span class="st">"ads_campaign"</span>, y<span class="op">=</span><span class="st">"cac"</span>, text_auto<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-08" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="34fd42ed-1a3f-4736-96e6-16fe429f5680" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("34fd42ed-1a3f-4736-96e6-16fe429f5680")) {                    Plotly.newPlot(                        "34fd42ed-1a3f-4736-96e6-16fe429f5680",                        [{"alignmentgroup":"True","hovertemplate":"ads_campaign=%{x}\u003cbr\u003ecac=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","offsetgroup":"","orientation":"v","showlegend":false,"textposition":"auto","texttemplate":"%{y}","x":["Company \u2116 1","Company \u2116 2"],"xaxis":"x","y":[1461.99,1068.38],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"ads_campaign"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"cac"}},"legend":{"tracegroupgap":0},"margin":{"t":60},"barmode":"relative"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('34fd42ed-1a3f-4736-96e6-16fe429f5680');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.8: Customer Acquisition Cost (CAC) за кампаніями</figcaption>
</figure>
</div>
</div>
<p>У якої рекламної кампанії витрати на залучення одного покупця виявилися нижчими?</p>
</section>
<section id="return-on-investment-roi" class="level2" data-number="18.7">
<h2 data-number="18.7" class="anchored" data-anchor-id="return-on-investment-roi"><span class="header-section-number">18.7</span> Return on Investment (ROI)</h2>
<p>Відмінно, <strong>CAC</strong> ми розрахували, але чи можемо ми тепер стверджувати, що друга рекламна кампанія краща лише тому, що дозволяє залучати активних користувачів за менші гроші?</p>
<p>Ні, робити такі висновки рано — давайте оцінимо ще один показник, який відображає рентабельність інвестицій і показує, наскільки вигідним є той чи інший проект чи продукт. Ця метрика називається <strong>ROI (Return on Investment)</strong>, у маркетингу її часто застосовують для підрахунку окупності рекламних кампаній.</p>
<p>Наведемо приклад. Допустимо, ми вклали в рекламу <strong>100 грошових одиниць</strong> і в результаті продали товарів на <strong>220 грошових одиниць</strong>. Тоді <strong>ROI</strong> буде розрахований так:</p>
<p><span class="math display">\[ROI=\frac{(220−100)}{100}∗100\%=120\%\]</span></p>
<p>Таким чином, на кожну вкладену одиницю грошей у рекламу ми отримали 1,2 грошових одиниць прибутку.</p>
<p>Порівняємо дві рекламні кампанії за значеннями метрики <strong>ROI</strong> і зробимо висновок про те, який з рекламних каналів більшою мірою окупає витрати на залучення нових користувачів.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-09" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.9 </strong></span><br> Розрахуйте <strong>ROI</strong> для кожного рекламного каналу.</p>
<p>Назвіть колонку з найменуваннями кампаній <code>ads_campaign</code>, а колонку зі значенням метрики — <code>roi</code>.</p>
<p>Назви кампаній виведіть у такому вигляді:</p>
<pre><code>Company № 1
Company № 2</code></pre>
<p>Отримані значення метрики необхідно виразити у відсотках та округлити <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зменшенням значення метрики.</p>
<p>Поля у результуючій таблиці: <code>ads_campaign</code>, <code>roi</code></p>
<p><strong>Пояснення:</strong></p>
<p>Списки користувачів, що зареєструвалися, ті ж, що і на попередньому кроці.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Візьміть усіх користувачів, які залучені через рекламний канал. Потім порахуйте сумарну вартість усіх нескасованих замовлень цих користувачів за весь час. Далі відніміть від отриманої суми рекламні витрати та розділіть отриману різницю на рекламні витрати.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="26">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a><span class="op">%%</span>sql</span>
<span id="cb30-2"><a href="#cb30-2"></a>SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb30-3"><a href="#cb30-3"></a>       <span class="bu">round</span>((<span class="bu">sum</span>(price) <span class="op">-</span> <span class="fl">250000.0</span>) <span class="op">/</span> <span class="fl">250000.0</span> <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> roi</span>
<span id="cb30-4"><a href="#cb30-4"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb30-5"><a href="#cb30-5"></a>               user_id,</span>
<span id="cb30-6"><a href="#cb30-6"></a>               order_id,</span>
<span id="cb30-7"><a href="#cb30-7"></a>               product_id,</span>
<span id="cb30-8"><a href="#cb30-8"></a>               price</span>
<span id="cb30-9"><a href="#cb30-9"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb30-10"><a href="#cb30-10"></a>                       user_id,</span>
<span id="cb30-11"><a href="#cb30-11"></a>                       order_id</span>
<span id="cb30-12"><a href="#cb30-12"></a>                FROM   (SELECT user_id,</span>
<span id="cb30-13"><a href="#cb30-13"></a>                               order_id,</span>
<span id="cb30-14"><a href="#cb30-14"></a>                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb30-15"><a href="#cb30-15"></a>                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb30-16"><a href="#cb30-16"></a>                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb30-17"><a href="#cb30-17"></a>                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb30-18"><a href="#cb30-18"></a>                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb30-19"><a href="#cb30-19"></a>                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb30-20"><a href="#cb30-20"></a>                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb30-21"><a href="#cb30-21"></a>                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb30-22"><a href="#cb30-22"></a>                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb30-23"><a href="#cb30-23"></a>                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb30-24"><a href="#cb30-24"></a>                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb30-25"><a href="#cb30-25"></a>                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb30-26"><a href="#cb30-26"></a>                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb30-27"><a href="#cb30-27"></a>                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb30-28"><a href="#cb30-28"></a>                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb30-29"><a href="#cb30-29"></a>                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb30-30"><a href="#cb30-30"></a>                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb30-31"><a href="#cb30-31"></a>                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb30-32"><a href="#cb30-32"></a>                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb30-33"><a href="#cb30-33"></a>                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb30-34"><a href="#cb30-34"></a>                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb30-35"><a href="#cb30-35"></a>                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb30-36"><a href="#cb30-36"></a>                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb30-37"><a href="#cb30-37"></a>                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb30-38"><a href="#cb30-38"></a>                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb30-39"><a href="#cb30-39"></a>                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb30-40"><a href="#cb30-40"></a>                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb30-41"><a href="#cb30-41"></a>                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb30-42"><a href="#cb30-42"></a>                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb30-43"><a href="#cb30-43"></a>                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb30-44"><a href="#cb30-44"></a>                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb30-45"><a href="#cb30-45"></a>                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb30-46"><a href="#cb30-46"></a>                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb30-47"><a href="#cb30-47"></a>                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb30-48"><a href="#cb30-48"></a>                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb30-49"><a href="#cb30-49"></a>                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb30-50"><a href="#cb30-50"></a>                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb30-51"><a href="#cb30-51"></a>                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb30-52"><a href="#cb30-52"></a>                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb30-53"><a href="#cb30-53"></a>                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb30-54"><a href="#cb30-54"></a>                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb30-55"><a href="#cb30-55"></a>                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb30-56"><a href="#cb30-56"></a>                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb30-57"><a href="#cb30-57"></a>                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb30-58"><a href="#cb30-58"></a>                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb30-59"><a href="#cb30-59"></a>                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb30-60"><a href="#cb30-60"></a>                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb30-61"><a href="#cb30-61"></a>                               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb30-62"><a href="#cb30-62"></a>                        FROM   user_actions) t1</span>
<span id="cb30-63"><a href="#cb30-63"></a>                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb30-64"><a href="#cb30-64"></a>                   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span>) t2</span>
<span id="cb30-65"><a href="#cb30-65"></a>            LEFT JOIN (SELECT order_id,</span>
<span id="cb30-66"><a href="#cb30-66"></a>                              unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb30-67"><a href="#cb30-67"></a>                       FROM   orders) t3 using(order_id)</span>
<span id="cb30-68"><a href="#cb30-68"></a>            LEFT JOIN products using(product_id)) t4</span>
<span id="cb30-69"><a href="#cb30-69"></a>GROUP BY ads_campaign</span>
<span id="cb30-70"><a href="#cb30-70"></a>ORDER BY roi desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ads_campaign</th>
<th data-quarto-table-cell-role="th">roi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Company № 1</td>
<td>14.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Company № 2</td>
<td>-1.61</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_9</code>:</p>
<div class="cell" data-execution_count="27">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="op">%%</span>sql</span>
<span id="cb31-2"><a href="#cb31-2"></a>results_9 <span class="op">&lt;&lt;</span> SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb31-3"><a href="#cb31-3"></a>       <span class="bu">round</span>((<span class="bu">sum</span>(price) <span class="op">-</span> <span class="fl">250000.0</span>) <span class="op">/</span> <span class="fl">250000.0</span> <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="im">as</span> roi</span>
<span id="cb31-4"><a href="#cb31-4"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb31-5"><a href="#cb31-5"></a>               user_id,</span>
<span id="cb31-6"><a href="#cb31-6"></a>               order_id,</span>
<span id="cb31-7"><a href="#cb31-7"></a>               product_id,</span>
<span id="cb31-8"><a href="#cb31-8"></a>               price</span>
<span id="cb31-9"><a href="#cb31-9"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb31-10"><a href="#cb31-10"></a>                       user_id,</span>
<span id="cb31-11"><a href="#cb31-11"></a>                       order_id</span>
<span id="cb31-12"><a href="#cb31-12"></a>                FROM   (SELECT user_id,</span>
<span id="cb31-13"><a href="#cb31-13"></a>                               order_id,</span>
<span id="cb31-14"><a href="#cb31-14"></a>                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb31-15"><a href="#cb31-15"></a>                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb31-16"><a href="#cb31-16"></a>                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb31-17"><a href="#cb31-17"></a>                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb31-18"><a href="#cb31-18"></a>                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb31-19"><a href="#cb31-19"></a>                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb31-20"><a href="#cb31-20"></a>                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb31-21"><a href="#cb31-21"></a>                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb31-22"><a href="#cb31-22"></a>                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb31-23"><a href="#cb31-23"></a>                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb31-24"><a href="#cb31-24"></a>                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb31-25"><a href="#cb31-25"></a>                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb31-26"><a href="#cb31-26"></a>                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb31-27"><a href="#cb31-27"></a>                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb31-28"><a href="#cb31-28"></a>                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb31-29"><a href="#cb31-29"></a>                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb31-30"><a href="#cb31-30"></a>                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb31-31"><a href="#cb31-31"></a>                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb31-32"><a href="#cb31-32"></a>                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb31-33"><a href="#cb31-33"></a>                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb31-34"><a href="#cb31-34"></a>                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb31-35"><a href="#cb31-35"></a>                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb31-36"><a href="#cb31-36"></a>                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb31-37"><a href="#cb31-37"></a>                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb31-38"><a href="#cb31-38"></a>                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb31-39"><a href="#cb31-39"></a>                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb31-40"><a href="#cb31-40"></a>                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb31-41"><a href="#cb31-41"></a>                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb31-42"><a href="#cb31-42"></a>                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb31-43"><a href="#cb31-43"></a>                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb31-44"><a href="#cb31-44"></a>                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb31-45"><a href="#cb31-45"></a>                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb31-46"><a href="#cb31-46"></a>                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb31-47"><a href="#cb31-47"></a>                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb31-48"><a href="#cb31-48"></a>                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb31-49"><a href="#cb31-49"></a>                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb31-50"><a href="#cb31-50"></a>                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb31-51"><a href="#cb31-51"></a>                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb31-52"><a href="#cb31-52"></a>                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb31-53"><a href="#cb31-53"></a>                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb31-54"><a href="#cb31-54"></a>                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb31-55"><a href="#cb31-55"></a>                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb31-56"><a href="#cb31-56"></a>                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb31-57"><a href="#cb31-57"></a>                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb31-58"><a href="#cb31-58"></a>                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb31-59"><a href="#cb31-59"></a>                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb31-60"><a href="#cb31-60"></a>                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb31-61"><a href="#cb31-61"></a>                               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb31-62"><a href="#cb31-62"></a>                        FROM   user_actions) t1</span>
<span id="cb31-63"><a href="#cb31-63"></a>                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb31-64"><a href="#cb31-64"></a>                   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span>) t2</span>
<span id="cb31-65"><a href="#cb31-65"></a>            LEFT JOIN (SELECT order_id,</span>
<span id="cb31-66"><a href="#cb31-66"></a>                              unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb31-67"><a href="#cb31-67"></a>                       FROM   orders) t3 using(order_id)</span>
<span id="cb31-68"><a href="#cb31-68"></a>            LEFT JOIN products using(product_id)) t4</span>
<span id="cb31-69"><a href="#cb31-69"></a>GROUP BY ads_campaign</span>
<span id="cb31-70"><a href="#cb31-70"></a>ORDER BY roi desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a>fig <span class="op">=</span> px.bar(results_9, x<span class="op">=</span><span class="st">"ads_campaign"</span>, y<span class="op">=</span><span class="st">"roi"</span>, text_auto<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-09" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="2f901f3f-32d6-4af5-abf4-d7df345e8359" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("2f901f3f-32d6-4af5-abf4-d7df345e8359")) {                    Plotly.newPlot(                        "2f901f3f-32d6-4af5-abf4-d7df345e8359",                        [{"alignmentgroup":"True","hovertemplate":"ads_campaign=%{x}\u003cbr\u003eroi=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","offsetgroup":"","orientation":"v","showlegend":false,"textposition":"auto","texttemplate":"%{y}","x":["Company \u2116 1","Company \u2116 2"],"xaxis":"x","y":[14.5,-1.61],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"ads_campaign"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"roi"}},"legend":{"tracegroupgap":0},"margin":{"t":60},"barmode":"relative"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('2f901f3f-32d6-4af5-abf4-d7df345e8359');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.9: Return on Investment (ROI) за кампаніями</figcaption>
</figure>
</div>
</div>
<p>Який висновок щодо ефективності рекламних кампаній можна зробити? У який канал залучення є сенс вкладати більше бюджету?</p>
</section>
<section id="середній-чек" class="level2" data-number="18.8">
<h2 data-number="18.8" class="anchored" data-anchor-id="середній-чек"><span class="header-section-number">18.8</span> Середній чек</h2>
<p>Отже, ми з’ясували, що перша рекламна кампанія дозволяє залучати якісніших лідів. Але причина цих відмінностей поки що не зрозуміла. Чому користувачі першого рекламного каналу приносять нам більше грошей? Можливо, у них вищий середній чек?</p>
<p>Давайте проведемо більш детальний аналіз, щоб з’ясувати, чим відрізняються два рекламні канали з точки зору метрик користувача.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-10" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.10 </strong></span><br> Для кожної рекламної кампанії порахуйте середню вартість замовлення залучених користувачів за перший тиждень використання програми <strong>з 1 по 7 вересня 2022 року</strong>.</p>
<p>Назвіть колонку з найменуваннями кампаній <code>ads_campaign</code>, а колонку зі значенням метрики — <code>avg_check</code>.</p>
<p>Назви кампаній виведіть у такому вигляді:</p>
<pre><code>Company № 1
Company № 2</code></pre>
<p>Отримані значення метрики необхідно заокруглити <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований за зменшенням значення метрики.</p>
<p>Поля у результуючій таблиці: <code>ads_campaign</code>, <code>avg_check</code></p>
<p><strong>Пояснення:</strong></p>
<p>Покупцями будемо вважати тих користувачів, які зробили хоча б одне замовлення, яке надалі не було скасовано. Наприклад, якщо людина зробила лише одне замовлення, а потім скасувала його, то покупцем ми його не рахуємо.</p>
<p>Списки користувачів, що зареєструвалися, ті ж, що і на попередніх кроках.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Візьміть усіх користувачів, залучених через кожний рекламний канал. Потім для кожного користувача порахуйте середню вартість усіх замовлень. Потім ще раз усередніть отримані значення рекламних каналів.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="29">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a><span class="op">%%</span>sql</span>
<span id="cb34-2"><a href="#cb34-2"></a>SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb34-3"><a href="#cb34-3"></a>       <span class="bu">round</span>(avg(user_avg_check), <span class="dv">2</span>) <span class="im">as</span> avg_check</span>
<span id="cb34-4"><a href="#cb34-4"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb34-5"><a href="#cb34-5"></a>               user_id,</span>
<span id="cb34-6"><a href="#cb34-6"></a>               <span class="bu">round</span>(avg(order_price), <span class="dv">2</span>) <span class="im">as</span> user_avg_check</span>
<span id="cb34-7"><a href="#cb34-7"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb34-8"><a href="#cb34-8"></a>                       user_id,</span>
<span id="cb34-9"><a href="#cb34-9"></a>                       order_id,</span>
<span id="cb34-10"><a href="#cb34-10"></a>                       <span class="bu">sum</span>(price) <span class="im">as</span> order_price</span>
<span id="cb34-11"><a href="#cb34-11"></a>                FROM   (SELECT ads_campaign,</span>
<span id="cb34-12"><a href="#cb34-12"></a>                               user_id,</span>
<span id="cb34-13"><a href="#cb34-13"></a>                               order_id,</span>
<span id="cb34-14"><a href="#cb34-14"></a>                               product_id,</span>
<span id="cb34-15"><a href="#cb34-15"></a>                               price</span>
<span id="cb34-16"><a href="#cb34-16"></a>                        FROM   (SELECT ads_campaign,</span>
<span id="cb34-17"><a href="#cb34-17"></a>                                       user_id,</span>
<span id="cb34-18"><a href="#cb34-18"></a>                                       order_id</span>
<span id="cb34-19"><a href="#cb34-19"></a>                                FROM   (SELECT user_id,</span>
<span id="cb34-20"><a href="#cb34-20"></a>                                               order_id,</span>
<span id="cb34-21"><a href="#cb34-21"></a>                                               time,</span>
<span id="cb34-22"><a href="#cb34-22"></a>                                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb34-23"><a href="#cb34-23"></a>                                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb34-24"><a href="#cb34-24"></a>                                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb34-25"><a href="#cb34-25"></a>                                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb34-26"><a href="#cb34-26"></a>                                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb34-27"><a href="#cb34-27"></a>                                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb34-28"><a href="#cb34-28"></a>                                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb34-29"><a href="#cb34-29"></a>                                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb34-30"><a href="#cb34-30"></a>                                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb34-31"><a href="#cb34-31"></a>                                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb34-32"><a href="#cb34-32"></a>                                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb34-33"><a href="#cb34-33"></a>                                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb34-34"><a href="#cb34-34"></a>                                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb34-35"><a href="#cb34-35"></a>                                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb34-36"><a href="#cb34-36"></a>                                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb34-37"><a href="#cb34-37"></a>                                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb34-38"><a href="#cb34-38"></a>                                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb34-39"><a href="#cb34-39"></a>                                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb34-40"><a href="#cb34-40"></a>                                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb34-41"><a href="#cb34-41"></a>                                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb34-42"><a href="#cb34-42"></a>                                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb34-43"><a href="#cb34-43"></a>                                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb34-44"><a href="#cb34-44"></a>                                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb34-45"><a href="#cb34-45"></a>                                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb34-46"><a href="#cb34-46"></a>                                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb34-47"><a href="#cb34-47"></a>                                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb34-48"><a href="#cb34-48"></a>                                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb34-49"><a href="#cb34-49"></a>                                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb34-50"><a href="#cb34-50"></a>                                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb34-51"><a href="#cb34-51"></a>                                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb34-52"><a href="#cb34-52"></a>                                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb34-53"><a href="#cb34-53"></a>                                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb34-54"><a href="#cb34-54"></a>                                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb34-55"><a href="#cb34-55"></a>                                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb34-56"><a href="#cb34-56"></a>                                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb34-57"><a href="#cb34-57"></a>                                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb34-58"><a href="#cb34-58"></a>                                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb34-59"><a href="#cb34-59"></a>                                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb34-60"><a href="#cb34-60"></a>                                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb34-61"><a href="#cb34-61"></a>                                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb34-62"><a href="#cb34-62"></a>                                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb34-63"><a href="#cb34-63"></a>                                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb34-64"><a href="#cb34-64"></a>                                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb34-65"><a href="#cb34-65"></a>                                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb34-66"><a href="#cb34-66"></a>                                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb34-67"><a href="#cb34-67"></a>                                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb34-68"><a href="#cb34-68"></a>                                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb34-69"><a href="#cb34-69"></a>                                               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb34-70"><a href="#cb34-70"></a>                                        FROM   user_actions) t1</span>
<span id="cb34-71"><a href="#cb34-71"></a>                                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb34-72"><a href="#cb34-72"></a>                                   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb34-73"><a href="#cb34-73"></a>                                   <span class="kw">and</span> time::date <span class="op">&gt;=</span> <span class="st">'2022-09-01'</span></span>
<span id="cb34-74"><a href="#cb34-74"></a>                                   <span class="kw">and</span> time::date <span class="op">&lt;</span> <span class="st">'2022-09-08'</span>) t2</span>
<span id="cb34-75"><a href="#cb34-75"></a>                            LEFT JOIN (SELECT order_id,</span>
<span id="cb34-76"><a href="#cb34-76"></a>                                              unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb34-77"><a href="#cb34-77"></a>                                       FROM   orders) t3 using(order_id)</span>
<span id="cb34-78"><a href="#cb34-78"></a>                            LEFT JOIN products using(product_id)) t4</span>
<span id="cb34-79"><a href="#cb34-79"></a>                GROUP BY ads_campaign, user_id, order_id) t5</span>
<span id="cb34-80"><a href="#cb34-80"></a>        GROUP BY ads_campaign, user_id) t6</span>
<span id="cb34-81"><a href="#cb34-81"></a>GROUP BY ads_campaign</span>
<span id="cb34-82"><a href="#cb34-82"></a>ORDER BY avg_check desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ads_campaign</th>
<th data-quarto-table-cell-role="th">avg_check</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Company № 2</td>
<td>380.88</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Company № 1</td>
<td>371.73</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_10</code>:</p>
<div class="cell" data-execution_count="30">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a><span class="op">%%</span>sql</span>
<span id="cb35-2"><a href="#cb35-2"></a>results_10 <span class="op">&lt;&lt;</span> SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb35-3"><a href="#cb35-3"></a>       <span class="bu">round</span>(avg(user_avg_check), <span class="dv">2</span>) <span class="im">as</span> avg_check</span>
<span id="cb35-4"><a href="#cb35-4"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb35-5"><a href="#cb35-5"></a>               user_id,</span>
<span id="cb35-6"><a href="#cb35-6"></a>               <span class="bu">round</span>(avg(order_price), <span class="dv">2</span>) <span class="im">as</span> user_avg_check</span>
<span id="cb35-7"><a href="#cb35-7"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb35-8"><a href="#cb35-8"></a>                       user_id,</span>
<span id="cb35-9"><a href="#cb35-9"></a>                       order_id,</span>
<span id="cb35-10"><a href="#cb35-10"></a>                       <span class="bu">sum</span>(price) <span class="im">as</span> order_price</span>
<span id="cb35-11"><a href="#cb35-11"></a>                FROM   (SELECT ads_campaign,</span>
<span id="cb35-12"><a href="#cb35-12"></a>                               user_id,</span>
<span id="cb35-13"><a href="#cb35-13"></a>                               order_id,</span>
<span id="cb35-14"><a href="#cb35-14"></a>                               product_id,</span>
<span id="cb35-15"><a href="#cb35-15"></a>                               price</span>
<span id="cb35-16"><a href="#cb35-16"></a>                        FROM   (SELECT ads_campaign,</span>
<span id="cb35-17"><a href="#cb35-17"></a>                                       user_id,</span>
<span id="cb35-18"><a href="#cb35-18"></a>                                       order_id</span>
<span id="cb35-19"><a href="#cb35-19"></a>                                FROM   (SELECT user_id,</span>
<span id="cb35-20"><a href="#cb35-20"></a>                                               order_id,</span>
<span id="cb35-21"><a href="#cb35-21"></a>                                               time,</span>
<span id="cb35-22"><a href="#cb35-22"></a>                                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb35-23"><a href="#cb35-23"></a>                                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb35-24"><a href="#cb35-24"></a>                                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb35-25"><a href="#cb35-25"></a>                                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb35-26"><a href="#cb35-26"></a>                                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb35-27"><a href="#cb35-27"></a>                                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb35-28"><a href="#cb35-28"></a>                                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb35-29"><a href="#cb35-29"></a>                                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb35-30"><a href="#cb35-30"></a>                                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb35-31"><a href="#cb35-31"></a>                                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb35-32"><a href="#cb35-32"></a>                                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb35-33"><a href="#cb35-33"></a>                                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb35-34"><a href="#cb35-34"></a>                                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb35-35"><a href="#cb35-35"></a>                                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb35-36"><a href="#cb35-36"></a>                                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb35-37"><a href="#cb35-37"></a>                                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb35-38"><a href="#cb35-38"></a>                                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb35-39"><a href="#cb35-39"></a>                                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb35-40"><a href="#cb35-40"></a>                                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb35-41"><a href="#cb35-41"></a>                                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb35-42"><a href="#cb35-42"></a>                                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb35-43"><a href="#cb35-43"></a>                                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb35-44"><a href="#cb35-44"></a>                                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb35-45"><a href="#cb35-45"></a>                                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb35-46"><a href="#cb35-46"></a>                                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb35-47"><a href="#cb35-47"></a>                                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb35-48"><a href="#cb35-48"></a>                                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb35-49"><a href="#cb35-49"></a>                                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb35-50"><a href="#cb35-50"></a>                                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb35-51"><a href="#cb35-51"></a>                                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb35-52"><a href="#cb35-52"></a>                                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb35-53"><a href="#cb35-53"></a>                                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb35-54"><a href="#cb35-54"></a>                                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb35-55"><a href="#cb35-55"></a>                                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb35-56"><a href="#cb35-56"></a>                                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb35-57"><a href="#cb35-57"></a>                                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb35-58"><a href="#cb35-58"></a>                                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb35-59"><a href="#cb35-59"></a>                                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb35-60"><a href="#cb35-60"></a>                                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb35-61"><a href="#cb35-61"></a>                                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb35-62"><a href="#cb35-62"></a>                                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb35-63"><a href="#cb35-63"></a>                                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb35-64"><a href="#cb35-64"></a>                                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb35-65"><a href="#cb35-65"></a>                                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb35-66"><a href="#cb35-66"></a>                                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb35-67"><a href="#cb35-67"></a>                                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb35-68"><a href="#cb35-68"></a>                                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb35-69"><a href="#cb35-69"></a>                                               count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb35-70"><a href="#cb35-70"></a>                                        FROM   user_actions) t1</span>
<span id="cb35-71"><a href="#cb35-71"></a>                                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb35-72"><a href="#cb35-72"></a>                                   <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-73"><a href="#cb35-73"></a>                                   <span class="kw">and</span> time::date <span class="op">&gt;=</span> <span class="st">'2022-09-01'</span></span>
<span id="cb35-74"><a href="#cb35-74"></a>                                   <span class="kw">and</span> time::date <span class="op">&lt;</span> <span class="st">'2022-09-08'</span>) t2</span>
<span id="cb35-75"><a href="#cb35-75"></a>                            LEFT JOIN (SELECT order_id,</span>
<span id="cb35-76"><a href="#cb35-76"></a>                                              unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb35-77"><a href="#cb35-77"></a>                                       FROM   orders) t3 using(order_id)</span>
<span id="cb35-78"><a href="#cb35-78"></a>                            LEFT JOIN products using(product_id)) t4</span>
<span id="cb35-79"><a href="#cb35-79"></a>                GROUP BY ads_campaign, user_id, order_id) t5</span>
<span id="cb35-80"><a href="#cb35-80"></a>        GROUP BY ads_campaign, user_id) t6</span>
<span id="cb35-81"><a href="#cb35-81"></a>GROUP BY ads_campaign</span>
<span id="cb35-82"><a href="#cb35-82"></a>ORDER BY avg_check desc</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a>fig <span class="op">=</span> px.bar(results_10, x<span class="op">=</span><span class="st">"ads_campaign"</span>, y<span class="op">=</span><span class="st">"avg_check"</span>, text_auto<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-2"><a href="#cb36-2"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-10" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<div>                            <div id="70b1adcc-ebec-4036-9789-19c4f975897e" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("70b1adcc-ebec-4036-9789-19c4f975897e")) {                    Plotly.newPlot(                        "70b1adcc-ebec-4036-9789-19c4f975897e",                        [{"alignmentgroup":"True","hovertemplate":"ads_campaign=%{x}\u003cbr\u003eavg_check=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","offsetgroup":"","orientation":"v","showlegend":false,"textposition":"auto","texttemplate":"%{y}","x":["Company \u2116 2","Company \u2116 1"],"xaxis":"x","y":[380.88,371.73],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"ads_campaign"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"avg_check"}},"legend":{"tracegroupgap":0},"margin":{"t":60},"barmode":"relative"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('70b1adcc-ebec-4036-9789-19c4f975897e');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">Рисунок&nbsp;18.10: Середній чек за кампаніями</figcaption>
</figure>
</div>
</div>
</section>
<section id="retention-rate" class="level2 page-columns page-full" data-number="18.9">
<h2 data-number="18.9" class="anchored" data-anchor-id="retention-rate"><span class="header-section-number">18.9</span> Retention rate</h2>
<p>Середній чек ми порахували, але відповіді на запитання не отримали. У чому тоді може бути справа? Звернемо увагу на ще один важливий показник — <strong>Retention rate</strong>.</p>
<p><strong>Retention rate</strong> – коефіцієнт утримання клієнтів. Він показує частку користувачів, які повернулися до програми через N днів, тижнів або місяців після свого першого входу — метрику можна розраховувати за будь-якими цікавими періодами.</p>
<p>У разі нашого сервісу доставки <strong>високий Retention</strong> означає, що користувачі часто повертаються, щоб зробити повторне замовлення. <strong>Низький Retention</strong>, навпаки, говорить про те, що більшість користувачів йдуть у відтік після однієї чи кількох взаємодій. Можливо, їм незручно користуватися нашим додатком, або їх не влаштовують ціни, асортимент товарів, швидкість або вартість доставки — причини можуть бути різні, і щоб їх встановити, потрібні додаткові дослідження.</p>
<p>Таким чином, метрика <strong>Retention</strong> відображає цінність нашого продукту в очах користувачів: якщо вони повертаються до нас із певною періодичністю, то наш продукт допомагає їм вирішувати свої завдання.</p>
<p>Можливо, саме цей показник допоможе нам відповісти на запитання, чому одна із двох рекламних кампаній показує себе краще. Але перш ніж приступати до аналізу <strong>Retention</strong>, давайте розберемося докладніше з методикою його розрахунку.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-11" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.11 </strong></span><br> На основі даних у таблиці <code>user_actions</code> розрахуйте показник <strong>денного Retention</strong> для всіх користувачів, розбивши їх на когорти за датою першої взаємодії з нашим додатком.</p>
<p>У результат увімкніть чотири колонки: місяць першої взаємодії, дату першої взаємодії, кількість днів, що пройшли з дати першої взаємодії (порядковий номер дня починаючи з 0), і саме значення <strong>Retention</strong>.</p>
<p>Колонки зі значеннями назвіть відповідно <code>start_month</code>, <code>start_date</code>, <code>day_number</code>, <code>retention</code>.</p>
<p>Метрику необхідно виразити у вигляді частки, округливши отримані значення <strong>до двох знаків після коми</strong>.</p>
<p>Місяць першої взаємодії вкажіть у вигляді дати, заокругленої <strong>до першого числа місяця</strong>.</p>
<p>Результат має бути відсортований спочатку за зростанням дати першої взаємодії, потім за зростанням порядкового номера дня.</p>
<p>Поля в результуючій таблиці: <code>start_month</code>, <code>start_date</code>, <code>day_number</code>, <code>retention</code></p>
<p><strong>Пояснення:</strong></p>
<p>В цьому завданні враховуйте всіх унікальних користувачів у таблиці user_actions.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Алгоритм розрахунку Retention
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Спочатку для кожного користувача порахуйте дату найпершої дії в додатку (це можна зробити за допомогою віконної функції). Потім зробіть групування за двома полями: датою першої дії та кожною датою, представленою в даних. Далі за згрупованими даними кожного дня порахуйте кількість унікальних користувачів з певною датою першої дії. Після цього для кожної пари “дата першої взаємодії - дата” необхідно порахувати сам <strong>Retention</strong>, тобто частку унікальних користувачів у кількості користувачів у <strong>когорті</strong> (число користувачів у нульовий день). Потім залишиться лише витягти місяць із дат і обчислити різницю в днях між кожною датою та датою першої взаємодії.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="32">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a><span class="op">%%</span>sql</span>
<span id="cb37-2"><a href="#cb37-2"></a>SELECT date_trunc(<span class="st">'month'</span>, start_date)::date <span class="im">as</span> start_month,</span>
<span id="cb37-3"><a href="#cb37-3"></a>       start_date,</span>
<span id="cb37-4"><a href="#cb37-4"></a>       date <span class="op">-</span> start_date <span class="im">as</span> day_number,</span>
<span id="cb37-5"><a href="#cb37-5"></a>       <span class="bu">round</span>(users::decimal <span class="op">/</span> <span class="bu">max</span>(users) OVER (PARTITION BY start_date), <span class="dv">2</span>) <span class="im">as</span> retention</span>
<span id="cb37-6"><a href="#cb37-6"></a>FROM   (SELECT start_date,</span>
<span id="cb37-7"><a href="#cb37-7"></a>               date,</span>
<span id="cb37-8"><a href="#cb37-8"></a>               count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb37-9"><a href="#cb37-9"></a>        FROM   (SELECT user_id,</span>
<span id="cb37-10"><a href="#cb37-10"></a>                       time::date <span class="im">as</span> date,</span>
<span id="cb37-11"><a href="#cb37-11"></a>                       <span class="bu">min</span>(time::date) OVER (PARTITION BY user_id) <span class="im">as</span> start_date</span>
<span id="cb37-12"><a href="#cb37-12"></a>                FROM   user_actions) t1</span>
<span id="cb37-13"><a href="#cb37-13"></a>        GROUP BY start_date, date) t2</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">start_month</th>
<th data-quarto-table-cell-role="th">start_date</th>
<th data-quarto-table-cell-role="th">day_number</th>
<th data-quarto-table-cell-role="th">retention</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2022-08-01</td>
<td>2022-08-31</td>
<td>4</td>
<td>0.16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2022-08-01</td>
<td>2022-08-31</td>
<td>8</td>
<td>0.10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2022-08-01</td>
<td>2022-08-31</td>
<td>2</td>
<td>0.16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2022-08-01</td>
<td>2022-08-31</td>
<td>3</td>
<td>0.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2022-08-01</td>
<td>2022-08-31</td>
<td>6</td>
<td>0.10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">131</td>
<td>2022-09-01</td>
<td>2022-09-03</td>
<td>1</td>
<td>0.21</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">132</td>
<td>2022-09-01</td>
<td>2022-09-03</td>
<td>3</td>
<td>0.12</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">133</td>
<td>2022-09-01</td>
<td>2022-09-03</td>
<td>4</td>
<td>0.14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">134</td>
<td>2022-09-01</td>
<td>2022-09-03</td>
<td>2</td>
<td>0.18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">135</td>
<td>2022-09-01</td>
<td>2022-09-08</td>
<td>0</td>
<td>1.00</td>
</tr>
</tbody>
</table>

<p>136 rows × 4 columns</p>
</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_11</code>:</p>
<div class="cell" data-execution_count="33">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a><span class="op">%%</span>sql</span>
<span id="cb38-2"><a href="#cb38-2"></a>results_11 <span class="op">&lt;&lt;</span> SELECT date_trunc(<span class="st">'month'</span>, start_date)::date <span class="im">as</span> start_month,</span>
<span id="cb38-3"><a href="#cb38-3"></a>       start_date,</span>
<span id="cb38-4"><a href="#cb38-4"></a>       date <span class="op">-</span> start_date <span class="im">as</span> day_number,</span>
<span id="cb38-5"><a href="#cb38-5"></a>       <span class="bu">round</span>(users::decimal <span class="op">/</span> <span class="bu">max</span>(users) OVER (PARTITION BY start_date), <span class="dv">2</span>) <span class="im">as</span> retention</span>
<span id="cb38-6"><a href="#cb38-6"></a>FROM   (SELECT start_date,</span>
<span id="cb38-7"><a href="#cb38-7"></a>               date,</span>
<span id="cb38-8"><a href="#cb38-8"></a>               count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb38-9"><a href="#cb38-9"></a>        FROM   (SELECT user_id,</span>
<span id="cb38-10"><a href="#cb38-10"></a>                       time::date <span class="im">as</span> date,</span>
<span id="cb38-11"><a href="#cb38-11"></a>                       <span class="bu">min</span>(time::date) OVER (PARTITION BY user_id) <span class="im">as</span> start_date</span>
<span id="cb38-12"><a href="#cb38-12"></a>                FROM   user_actions) t1</span>
<span id="cb38-13"><a href="#cb38-13"></a>        GROUP BY start_date, date) t2</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Побудуємо зведену таблицю:</p>
<div class="cell page-columns page-full" data-execution_count="34">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>pd.pivot_table(</span>
<span id="cb39-2"><a href="#cb39-2"></a>    results_11,</span>
<span id="cb39-3"><a href="#cb39-3"></a>    index<span class="op">=</span>[<span class="st">"start_month"</span>, <span class="st">"start_date"</span>],</span>
<span id="cb39-4"><a href="#cb39-4"></a>    columns<span class="op">=</span><span class="st">"day_number"</span>,</span>
<span id="cb39-5"><a href="#cb39-5"></a>    values<span class="op">=</span><span class="st">"retention"</span>,</span>
<span id="cb39-6"><a href="#cb39-6"></a>).style.background_gradient(</span>
<span id="cb39-7"><a href="#cb39-7"></a>    cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb39-8"><a href="#cb39-8"></a>)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display column-page" data-execution_count="34">
<style type="text/css">
#T_da7b7_row0_col0, #T_da7b7_row0_col12, #T_da7b7_row0_col13, #T_da7b7_row0_col14, #T_da7b7_row0_col15, #T_da7b7_row1_col0, #T_da7b7_row1_col11, #T_da7b7_row1_col15, #T_da7b7_row2_col0, #T_da7b7_row2_col15, #T_da7b7_row3_col0, #T_da7b7_row3_col15, #T_da7b7_row4_col0, #T_da7b7_row4_col15, #T_da7b7_row5_col0, #T_da7b7_row5_col8, #T_da7b7_row5_col9, #T_da7b7_row5_col10, #T_da7b7_row5_col15, #T_da7b7_row6_col0, #T_da7b7_row6_col4, #T_da7b7_row6_col7, #T_da7b7_row6_col9, #T_da7b7_row6_col15, #T_da7b7_row7_col0, #T_da7b7_row7_col6, #T_da7b7_row7_col15, #T_da7b7_row8_col0, #T_da7b7_row8_col5, #T_da7b7_row8_col15, #T_da7b7_row9_col0, #T_da7b7_row9_col15, #T_da7b7_row10_col0, #T_da7b7_row10_col3, #T_da7b7_row10_col15, #T_da7b7_row11_col0, #T_da7b7_row11_col15, #T_da7b7_row12_col0, #T_da7b7_row12_col1, #T_da7b7_row12_col2, #T_da7b7_row12_col15, #T_da7b7_row13_col0, #T_da7b7_row13_col2, #T_da7b7_row13_col15, #T_da7b7_row14_col0, #T_da7b7_row14_col15, #T_da7b7_row15_col0, #T_da7b7_row15_col15 {
  background-color: #f7fbff;
  color: #000000;
}
#T_da7b7_row0_col1, #T_da7b7_row5_col7, #T_da7b7_row8_col7 {
  background-color: #bfd8ed;
  color: #000000;
}
#T_da7b7_row0_col2, #T_da7b7_row5_col2, #T_da7b7_row9_col3, #T_da7b7_row12_col3 {
  background-color: #b7d4ea;
  color: #000000;
}
#T_da7b7_row0_col3, #T_da7b7_row8_col2, #T_da7b7_row8_col3, #T_da7b7_row9_col2, #T_da7b7_row10_col2 {
  background-color: #4a98c9;
  color: #f1f1f1;
}
#T_da7b7_row0_col4, #T_da7b7_row0_col9, #T_da7b7_row0_col11, #T_da7b7_row1_col8, #T_da7b7_row1_col9, #T_da7b7_row1_col10, #T_da7b7_row1_col13, #T_da7b7_row1_col14, #T_da7b7_row2_col1, #T_da7b7_row2_col3, #T_da7b7_row2_col9, #T_da7b7_row2_col12, #T_da7b7_row3_col1, #T_da7b7_row3_col2, #T_da7b7_row3_col6, #T_da7b7_row3_col7, #T_da7b7_row4_col1, #T_da7b7_row4_col5, #T_da7b7_row4_col6 {
  background-color: #08306b;
  color: #f1f1f1;
}
#T_da7b7_row0_col5, #T_da7b7_row3_col5, #T_da7b7_row7_col1, #T_da7b7_row7_col7, #T_da7b7_row10_col5, #T_da7b7_row11_col1 {
  background-color: #7db8da;
  color: #000000;
}
#T_da7b7_row0_col6, #T_da7b7_row3_col11, #T_da7b7_row8_col4, #T_da7b7_row8_col6, #T_da7b7_row10_col4 {
  background-color: #bad6eb;
  color: #000000;
}
#T_da7b7_row0_col7, #T_da7b7_row9_col1 {
  background-color: #135fa7;
  color: #f1f1f1;
}
#T_da7b7_row0_col8, #T_da7b7_row7_col8 {
  background-color: #c6dbef;
  color: #000000;
}
#T_da7b7_row0_col10 {
  background-color: #6caed6;
  color: #f1f1f1;
}
#T_da7b7_row1_col1, #T_da7b7_row2_col7, #T_da7b7_row5_col1, #T_da7b7_row5_col5, #T_da7b7_row8_col1 {
  background-color: #3f8fc5;
  color: #f1f1f1;
}
#T_da7b7_row1_col2, #T_da7b7_row5_col3, #T_da7b7_row7_col2, #T_da7b7_row11_col3 {
  background-color: #94c4df;
  color: #000000;
}
#T_da7b7_row1_col3, #T_da7b7_row3_col3 {
  background-color: #2e7ebc;
  color: #f1f1f1;
}
#T_da7b7_row1_col4, #T_da7b7_row2_col4, #T_da7b7_row2_col6, #T_da7b7_row4_col4 {
  background-color: #2b7bba;
  color: #f1f1f1;
}
#T_da7b7_row1_col5, #T_da7b7_row1_col7, #T_da7b7_row4_col7, #T_da7b7_row10_col1 {
  background-color: #08488e;
  color: #f1f1f1;
}
#T_da7b7_row1_col6 {
  background-color: #0b559f;
  color: #f1f1f1;
}
#T_da7b7_row1_col12, #T_da7b7_row3_col9, #T_da7b7_row3_col12, #T_da7b7_row4_col10 {
  background-color: #3787c0;
  color: #f1f1f1;
}
#T_da7b7_row2_col2, #T_da7b7_row2_col13 {
  background-color: #1764ab;
  color: #f1f1f1;
}
#T_da7b7_row2_col5, #T_da7b7_row9_col5, #T_da7b7_row14_col1 {
  background-color: #5ca4d0;
  color: #f1f1f1;
}
#T_da7b7_row2_col8 {
  background-color: #2070b4;
  color: #f1f1f1;
}
#T_da7b7_row2_col10, #T_da7b7_row3_col10 {
  background-color: #d6e6f4;
  color: #000000;
}
#T_da7b7_row2_col11, #T_da7b7_row6_col6, #T_da7b7_row9_col4 {
  background-color: #dbe9f6;
  color: #000000;
}
#T_da7b7_row2_col14, #T_da7b7_row3_col13, #T_da7b7_row3_col14, #T_da7b7_row4_col12, #T_da7b7_row4_col13, #T_da7b7_row4_col14, #T_da7b7_row5_col11, #T_da7b7_row5_col12, #T_da7b7_row5_col13, #T_da7b7_row5_col14, #T_da7b7_row6_col10, #T_da7b7_row6_col11, #T_da7b7_row6_col12, #T_da7b7_row6_col13, #T_da7b7_row6_col14, #T_da7b7_row7_col9, #T_da7b7_row7_col10, #T_da7b7_row7_col11, #T_da7b7_row7_col12, #T_da7b7_row7_col13, #T_da7b7_row7_col14, #T_da7b7_row8_col8, #T_da7b7_row8_col9, #T_da7b7_row8_col10, #T_da7b7_row8_col11, #T_da7b7_row8_col12, #T_da7b7_row8_col13, #T_da7b7_row8_col14, #T_da7b7_row9_col7, #T_da7b7_row9_col8, #T_da7b7_row9_col9, #T_da7b7_row9_col10, #T_da7b7_row9_col11, #T_da7b7_row9_col12, #T_da7b7_row9_col13, #T_da7b7_row9_col14, #T_da7b7_row10_col6, #T_da7b7_row10_col7, #T_da7b7_row10_col8, #T_da7b7_row10_col9, #T_da7b7_row10_col10, #T_da7b7_row10_col11, #T_da7b7_row10_col12, #T_da7b7_row10_col13, #T_da7b7_row10_col14, #T_da7b7_row11_col5, #T_da7b7_row11_col6, #T_da7b7_row11_col7, #T_da7b7_row11_col8, #T_da7b7_row11_col9, #T_da7b7_row11_col10, #T_da7b7_row11_col11, #T_da7b7_row11_col12, #T_da7b7_row11_col13, #T_da7b7_row11_col14, #T_da7b7_row12_col4, #T_da7b7_row12_col5, #T_da7b7_row12_col6, #T_da7b7_row12_col7, #T_da7b7_row12_col8, #T_da7b7_row12_col9, #T_da7b7_row12_col10, #T_da7b7_row12_col11, #T_da7b7_row12_col12, #T_da7b7_row12_col13, #T_da7b7_row12_col14, #T_da7b7_row13_col3, #T_da7b7_row13_col4, #T_da7b7_row13_col5, #T_da7b7_row13_col6, #T_da7b7_row13_col7, #T_da7b7_row13_col8, #T_da7b7_row13_col9, #T_da7b7_row13_col10, #T_da7b7_row13_col11, #T_da7b7_row13_col12, #T_da7b7_row13_col13, #T_da7b7_row13_col14, #T_da7b7_row14_col2, #T_da7b7_row14_col3, #T_da7b7_row14_col4, #T_da7b7_row14_col5, #T_da7b7_row14_col6, #T_da7b7_row14_col7, #T_da7b7_row14_col8, #T_da7b7_row14_col9, #T_da7b7_row14_col10, #T_da7b7_row14_col11, #T_da7b7_row14_col12, #T_da7b7_row14_col13, #T_da7b7_row14_col14, #T_da7b7_row15_col1, #T_da7b7_row15_col2, #T_da7b7_row15_col3, #T_da7b7_row15_col4, #T_da7b7_row15_col5, #T_da7b7_row15_col6, #T_da7b7_row15_col7, #T_da7b7_row15_col8, #T_da7b7_row15_col9, #T_da7b7_row15_col10, #T_da7b7_row15_col11, #T_da7b7_row15_col12, #T_da7b7_row15_col13, #T_da7b7_row15_col14 {
  background-color: #000000;
  color: #f1f1f1;
}
#T_da7b7_row3_col4, #T_da7b7_row5_col6, #T_da7b7_row7_col4, #T_da7b7_row11_col4 {
  background-color: #539ecd;
  color: #f1f1f1;
}
#T_da7b7_row3_col8, #T_da7b7_row4_col8 {
  background-color: #4191c6;
  color: #f1f1f1;
}
#T_da7b7_row4_col2 {
  background-color: #084a91;
  color: #f1f1f1;
}
#T_da7b7_row4_col3, #T_da7b7_row7_col3 {
  background-color: #6aaed6;
  color: #f1f1f1;
}
#T_da7b7_row4_col9 {
  background-color: #abd0e6;
  color: #000000;
}
#T_da7b7_row4_col11, #T_da7b7_row5_col4, #T_da7b7_row9_col6 {
  background-color: #89bedc;
  color: #000000;
}
#T_da7b7_row6_col1, #T_da7b7_row6_col5 {
  background-color: #a1cbe2;
  color: #000000;
}
#T_da7b7_row6_col2, #T_da7b7_row11_col2 {
  background-color: #e3eef9;
  color: #000000;
}
#T_da7b7_row6_col3 {
  background-color: #d0e1f2;
  color: #000000;
}
#T_da7b7_row6_col8 {
  background-color: #dfebf7;
  color: #000000;
}
#T_da7b7_row7_col5 {
  background-color: #d3e4f3;
  color: #000000;
}
#T_da7b7_row13_col1 {
  background-color: #e5eff9;
  color: #000000;
}
</style>

<table id="T_da7b7" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="index_name level0" data-quarto-table-cell-role="th">day_number</th>
<th id="T_da7b7_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">0</th>
<th id="T_da7b7_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">1</th>
<th id="T_da7b7_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">2</th>
<th id="T_da7b7_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">3</th>
<th id="T_da7b7_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">4</th>
<th id="T_da7b7_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">5</th>
<th id="T_da7b7_level0_col6" class="col_heading level0 col6" data-quarto-table-cell-role="th">6</th>
<th id="T_da7b7_level0_col7" class="col_heading level0 col7" data-quarto-table-cell-role="th">7</th>
<th id="T_da7b7_level0_col8" class="col_heading level0 col8" data-quarto-table-cell-role="th">8</th>
<th id="T_da7b7_level0_col9" class="col_heading level0 col9" data-quarto-table-cell-role="th">9</th>
<th id="T_da7b7_level0_col10" class="col_heading level0 col10" data-quarto-table-cell-role="th">10</th>
<th id="T_da7b7_level0_col11" class="col_heading level0 col11" data-quarto-table-cell-role="th">11</th>
<th id="T_da7b7_level0_col12" class="col_heading level0 col12" data-quarto-table-cell-role="th">12</th>
<th id="T_da7b7_level0_col13" class="col_heading level0 col13" data-quarto-table-cell-role="th">13</th>
<th id="T_da7b7_level0_col14" class="col_heading level0 col14" data-quarto-table-cell-role="th">14</th>
<th id="T_da7b7_level0_col15" class="col_heading level0 col15" data-quarto-table-cell-role="th">15</th>
</tr>
<tr class="odd">
<th class="index_name level0" data-quarto-table-cell-role="th">start_month</th>
<th class="index_name level1" data-quarto-table-cell-role="th">start_date</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col3" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col4" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col5" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col6" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col7" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col8" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col9" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col10" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col11" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col12" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col13" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col14" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col15" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="8" id="T_da7b7_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">2022-08-01</td>
<td id="T_da7b7_level1_row0" class="row_heading level1 row0" data-quarto-table-cell-role="th">2022-08-24</td>
<td id="T_da7b7_row0_col0" class="data row0 col0">1.000000</td>
<td id="T_da7b7_row0_col1" class="data row0 col1">0.140000</td>
<td id="T_da7b7_row0_col2" class="data row0 col2">0.150000</td>
<td id="T_da7b7_row0_col3" class="data row0 col3">0.180000</td>
<td id="T_da7b7_row0_col4" class="data row0 col4">0.190000</td>
<td id="T_da7b7_row0_col5" class="data row0 col5">0.140000</td>
<td id="T_da7b7_row0_col6" class="data row0 col6">0.120000</td>
<td id="T_da7b7_row0_col7" class="data row0 col7">0.160000</td>
<td id="T_da7b7_row0_col8" class="data row0 col8">0.100000</td>
<td id="T_da7b7_row0_col9" class="data row0 col9">0.150000</td>
<td id="T_da7b7_row0_col10" class="data row0 col10">0.110000</td>
<td id="T_da7b7_row0_col11" class="data row0 col11">0.150000</td>
<td id="T_da7b7_row0_col12" class="data row0 col12">0.070000</td>
<td id="T_da7b7_row0_col13" class="data row0 col13">0.050000</td>
<td id="T_da7b7_row0_col14" class="data row0 col14">0.050000</td>
<td id="T_da7b7_row0_col15" class="data row0 col15">0.070000</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row1" class="row_heading level1 row1" data-quarto-table-cell-role="th">2022-08-25</td>
<td id="T_da7b7_row1_col0" class="data row1 col0">1.000000</td>
<td id="T_da7b7_row1_col1" class="data row1 col1">0.180000</td>
<td id="T_da7b7_row1_col2" class="data row1 col2">0.160000</td>
<td id="T_da7b7_row1_col3" class="data row1 col3">0.190000</td>
<td id="T_da7b7_row1_col4" class="data row1 col4">0.170000</td>
<td id="T_da7b7_row1_col5" class="data row1 col5">0.190000</td>
<td id="T_da7b7_row1_col6" class="data row1 col6">0.160000</td>
<td id="T_da7b7_row1_col7" class="data row1 col7">0.170000</td>
<td id="T_da7b7_row1_col8" class="data row1 col8">0.160000</td>
<td id="T_da7b7_row1_col9" class="data row1 col9">0.150000</td>
<td id="T_da7b7_row1_col10" class="data row1 col10">0.140000</td>
<td id="T_da7b7_row1_col11" class="data row1 col11">0.080000</td>
<td id="T_da7b7_row1_col12" class="data row1 col12">0.090000</td>
<td id="T_da7b7_row1_col13" class="data row1 col13">0.100000</td>
<td id="T_da7b7_row1_col14" class="data row1 col14">0.090000</td>
<td id="T_da7b7_row1_col15" class="data row1 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row2" class="row_heading level1 row2" data-quarto-table-cell-role="th">2022-08-26</td>
<td id="T_da7b7_row2_col0" class="data row2 col0">1.000000</td>
<td id="T_da7b7_row2_col1" class="data row2 col1">0.220000</td>
<td id="T_da7b7_row2_col2" class="data row2 col2">0.200000</td>
<td id="T_da7b7_row2_col3" class="data row2 col3">0.220000</td>
<td id="T_da7b7_row2_col4" class="data row2 col4">0.170000</td>
<td id="T_da7b7_row2_col5" class="data row2 col5">0.150000</td>
<td id="T_da7b7_row2_col6" class="data row2 col6">0.150000</td>
<td id="T_da7b7_row2_col7" class="data row2 col7">0.140000</td>
<td id="T_da7b7_row2_col8" class="data row2 col8">0.140000</td>
<td id="T_da7b7_row2_col9" class="data row2 col9">0.150000</td>
<td id="T_da7b7_row2_col10" class="data row2 col10">0.090000</td>
<td id="T_da7b7_row2_col11" class="data row2 col11">0.090000</td>
<td id="T_da7b7_row2_col12" class="data row2 col12">0.100000</td>
<td id="T_da7b7_row2_col13" class="data row2 col13">0.090000</td>
<td id="T_da7b7_row2_col14" class="data row2 col14">nan</td>
<td id="T_da7b7_row2_col15" class="data row2 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row3" class="row_heading level1 row3" data-quarto-table-cell-role="th">2022-08-27</td>
<td id="T_da7b7_row3_col0" class="data row3 col0">1.000000</td>
<td id="T_da7b7_row3_col1" class="data row3 col1">0.220000</td>
<td id="T_da7b7_row3_col2" class="data row3 col2">0.220000</td>
<td id="T_da7b7_row3_col3" class="data row3 col3">0.190000</td>
<td id="T_da7b7_row3_col4" class="data row3 col4">0.160000</td>
<td id="T_da7b7_row3_col5" class="data row3 col5">0.140000</td>
<td id="T_da7b7_row3_col6" class="data row3 col6">0.170000</td>
<td id="T_da7b7_row3_col7" class="data row3 col7">0.180000</td>
<td id="T_da7b7_row3_col8" class="data row3 col8">0.130000</td>
<td id="T_da7b7_row3_col9" class="data row3 col9">0.130000</td>
<td id="T_da7b7_row3_col10" class="data row3 col10">0.090000</td>
<td id="T_da7b7_row3_col11" class="data row3 col11">0.100000</td>
<td id="T_da7b7_row3_col12" class="data row3 col12">0.090000</td>
<td id="T_da7b7_row3_col13" class="data row3 col13">nan</td>
<td id="T_da7b7_row3_col14" class="data row3 col14">nan</td>
<td id="T_da7b7_row3_col15" class="data row3 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row4" class="row_heading level1 row4" data-quarto-table-cell-role="th">2022-08-28</td>
<td id="T_da7b7_row4_col0" class="data row4 col0">1.000000</td>
<td id="T_da7b7_row4_col1" class="data row4 col1">0.220000</td>
<td id="T_da7b7_row4_col2" class="data row4 col2">0.210000</td>
<td id="T_da7b7_row4_col3" class="data row4 col3">0.170000</td>
<td id="T_da7b7_row4_col4" class="data row4 col4">0.170000</td>
<td id="T_da7b7_row4_col5" class="data row4 col5">0.200000</td>
<td id="T_da7b7_row4_col6" class="data row4 col6">0.170000</td>
<td id="T_da7b7_row4_col7" class="data row4 col7">0.170000</td>
<td id="T_da7b7_row4_col8" class="data row4 col8">0.130000</td>
<td id="T_da7b7_row4_col9" class="data row4 col9">0.110000</td>
<td id="T_da7b7_row4_col10" class="data row4 col10">0.120000</td>
<td id="T_da7b7_row4_col11" class="data row4 col11">0.110000</td>
<td id="T_da7b7_row4_col12" class="data row4 col12">nan</td>
<td id="T_da7b7_row4_col13" class="data row4 col13">nan</td>
<td id="T_da7b7_row4_col14" class="data row4 col14">nan</td>
<td id="T_da7b7_row4_col15" class="data row4 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row5" class="row_heading level1 row5" data-quarto-table-cell-role="th">2022-08-29</td>
<td id="T_da7b7_row5_col0" class="data row5 col0">1.000000</td>
<td id="T_da7b7_row5_col1" class="data row5 col1">0.180000</td>
<td id="T_da7b7_row5_col2" class="data row5 col2">0.150000</td>
<td id="T_da7b7_row5_col3" class="data row5 col3">0.160000</td>
<td id="T_da7b7_row5_col4" class="data row5 col4">0.150000</td>
<td id="T_da7b7_row5_col5" class="data row5 col5">0.160000</td>
<td id="T_da7b7_row5_col6" class="data row5 col6">0.140000</td>
<td id="T_da7b7_row5_col7" class="data row5 col7">0.100000</td>
<td id="T_da7b7_row5_col8" class="data row5 col8">0.080000</td>
<td id="T_da7b7_row5_col9" class="data row5 col9">0.090000</td>
<td id="T_da7b7_row5_col10" class="data row5 col10">0.080000</td>
<td id="T_da7b7_row5_col11" class="data row5 col11">nan</td>
<td id="T_da7b7_row5_col12" class="data row5 col12">nan</td>
<td id="T_da7b7_row5_col13" class="data row5 col13">nan</td>
<td id="T_da7b7_row5_col14" class="data row5 col14">nan</td>
<td id="T_da7b7_row5_col15" class="data row5 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row6" class="row_heading level1 row6" data-quarto-table-cell-role="th">2022-08-30</td>
<td id="T_da7b7_row6_col0" class="data row6 col0">1.000000</td>
<td id="T_da7b7_row6_col1" class="data row6 col1">0.150000</td>
<td id="T_da7b7_row6_col2" class="data row6 col2">0.130000</td>
<td id="T_da7b7_row6_col3" class="data row6 col3">0.140000</td>
<td id="T_da7b7_row6_col4" class="data row6 col4">0.120000</td>
<td id="T_da7b7_row6_col5" class="data row6 col5">0.130000</td>
<td id="T_da7b7_row6_col6" class="data row6 col6">0.110000</td>
<td id="T_da7b7_row6_col7" class="data row6 col7">0.070000</td>
<td id="T_da7b7_row6_col8" class="data row6 col8">0.090000</td>
<td id="T_da7b7_row6_col9" class="data row6 col9">0.090000</td>
<td id="T_da7b7_row6_col10" class="data row6 col10">nan</td>
<td id="T_da7b7_row6_col11" class="data row6 col11">nan</td>
<td id="T_da7b7_row6_col12" class="data row6 col12">nan</td>
<td id="T_da7b7_row6_col13" class="data row6 col13">nan</td>
<td id="T_da7b7_row6_col14" class="data row6 col14">nan</td>
<td id="T_da7b7_row6_col15" class="data row6 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row7" class="row_heading level1 row7" data-quarto-table-cell-role="th">2022-08-31</td>
<td id="T_da7b7_row7_col0" class="data row7 col0">1.000000</td>
<td id="T_da7b7_row7_col1" class="data row7 col1">0.160000</td>
<td id="T_da7b7_row7_col2" class="data row7 col2">0.160000</td>
<td id="T_da7b7_row7_col3" class="data row7 col3">0.170000</td>
<td id="T_da7b7_row7_col4" class="data row7 col4">0.160000</td>
<td id="T_da7b7_row7_col5" class="data row7 col5">0.110000</td>
<td id="T_da7b7_row7_col6" class="data row7 col6">0.100000</td>
<td id="T_da7b7_row7_col7" class="data row7 col7">0.120000</td>
<td id="T_da7b7_row7_col8" class="data row7 col8">0.100000</td>
<td id="T_da7b7_row7_col9" class="data row7 col9">nan</td>
<td id="T_da7b7_row7_col10" class="data row7 col10">nan</td>
<td id="T_da7b7_row7_col11" class="data row7 col11">nan</td>
<td id="T_da7b7_row7_col12" class="data row7 col12">nan</td>
<td id="T_da7b7_row7_col13" class="data row7 col13">nan</td>
<td id="T_da7b7_row7_col14" class="data row7 col14">nan</td>
<td id="T_da7b7_row7_col15" class="data row7 col15">nan</td>
</tr>
<tr class="odd">
<td rowspan="8" id="T_da7b7_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">2022-09-01</td>
<td id="T_da7b7_level1_row8" class="row_heading level1 row8" data-quarto-table-cell-role="th">2022-09-01</td>
<td id="T_da7b7_row8_col0" class="data row8 col0">1.000000</td>
<td id="T_da7b7_row8_col1" class="data row8 col1">0.180000</td>
<td id="T_da7b7_row8_col2" class="data row8 col2">0.180000</td>
<td id="T_da7b7_row8_col3" class="data row8 col3">0.180000</td>
<td id="T_da7b7_row8_col4" class="data row8 col4">0.140000</td>
<td id="T_da7b7_row8_col5" class="data row8 col5">0.090000</td>
<td id="T_da7b7_row8_col6" class="data row8 col6">0.120000</td>
<td id="T_da7b7_row8_col7" class="data row8 col7">0.100000</td>
<td id="T_da7b7_row8_col8" class="data row8 col8">nan</td>
<td id="T_da7b7_row8_col9" class="data row8 col9">nan</td>
<td id="T_da7b7_row8_col10" class="data row8 col10">nan</td>
<td id="T_da7b7_row8_col11" class="data row8 col11">nan</td>
<td id="T_da7b7_row8_col12" class="data row8 col12">nan</td>
<td id="T_da7b7_row8_col13" class="data row8 col13">nan</td>
<td id="T_da7b7_row8_col14" class="data row8 col14">nan</td>
<td id="T_da7b7_row8_col15" class="data row8 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row9" class="row_heading level1 row9" data-quarto-table-cell-role="th">2022-09-02</td>
<td id="T_da7b7_row9_col0" class="data row9 col0">1.000000</td>
<td id="T_da7b7_row9_col1" class="data row9 col1">0.200000</td>
<td id="T_da7b7_row9_col2" class="data row9 col2">0.180000</td>
<td id="T_da7b7_row9_col3" class="data row9 col3">0.150000</td>
<td id="T_da7b7_row9_col4" class="data row9 col4">0.130000</td>
<td id="T_da7b7_row9_col5" class="data row9 col5">0.150000</td>
<td id="T_da7b7_row9_col6" class="data row9 col6">0.130000</td>
<td id="T_da7b7_row9_col7" class="data row9 col7">nan</td>
<td id="T_da7b7_row9_col8" class="data row9 col8">nan</td>
<td id="T_da7b7_row9_col9" class="data row9 col9">nan</td>
<td id="T_da7b7_row9_col10" class="data row9 col10">nan</td>
<td id="T_da7b7_row9_col11" class="data row9 col11">nan</td>
<td id="T_da7b7_row9_col12" class="data row9 col12">nan</td>
<td id="T_da7b7_row9_col13" class="data row9 col13">nan</td>
<td id="T_da7b7_row9_col14" class="data row9 col14">nan</td>
<td id="T_da7b7_row9_col15" class="data row9 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row10" class="row_heading level1 row10" data-quarto-table-cell-role="th">2022-09-03</td>
<td id="T_da7b7_row10_col0" class="data row10 col0">1.000000</td>
<td id="T_da7b7_row10_col1" class="data row10 col1">0.210000</td>
<td id="T_da7b7_row10_col2" class="data row10 col2">0.180000</td>
<td id="T_da7b7_row10_col3" class="data row10 col3">0.120000</td>
<td id="T_da7b7_row10_col4" class="data row10 col4">0.140000</td>
<td id="T_da7b7_row10_col5" class="data row10 col5">0.140000</td>
<td id="T_da7b7_row10_col6" class="data row10 col6">nan</td>
<td id="T_da7b7_row10_col7" class="data row10 col7">nan</td>
<td id="T_da7b7_row10_col8" class="data row10 col8">nan</td>
<td id="T_da7b7_row10_col9" class="data row10 col9">nan</td>
<td id="T_da7b7_row10_col10" class="data row10 col10">nan</td>
<td id="T_da7b7_row10_col11" class="data row10 col11">nan</td>
<td id="T_da7b7_row10_col12" class="data row10 col12">nan</td>
<td id="T_da7b7_row10_col13" class="data row10 col13">nan</td>
<td id="T_da7b7_row10_col14" class="data row10 col14">nan</td>
<td id="T_da7b7_row10_col15" class="data row10 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row11" class="row_heading level1 row11" data-quarto-table-cell-role="th">2022-09-04</td>
<td id="T_da7b7_row11_col0" class="data row11 col0">1.000000</td>
<td id="T_da7b7_row11_col1" class="data row11 col1">0.160000</td>
<td id="T_da7b7_row11_col2" class="data row11 col2">0.130000</td>
<td id="T_da7b7_row11_col3" class="data row11 col3">0.160000</td>
<td id="T_da7b7_row11_col4" class="data row11 col4">0.160000</td>
<td id="T_da7b7_row11_col5" class="data row11 col5">nan</td>
<td id="T_da7b7_row11_col6" class="data row11 col6">nan</td>
<td id="T_da7b7_row11_col7" class="data row11 col7">nan</td>
<td id="T_da7b7_row11_col8" class="data row11 col8">nan</td>
<td id="T_da7b7_row11_col9" class="data row11 col9">nan</td>
<td id="T_da7b7_row11_col10" class="data row11 col10">nan</td>
<td id="T_da7b7_row11_col11" class="data row11 col11">nan</td>
<td id="T_da7b7_row11_col12" class="data row11 col12">nan</td>
<td id="T_da7b7_row11_col13" class="data row11 col13">nan</td>
<td id="T_da7b7_row11_col14" class="data row11 col14">nan</td>
<td id="T_da7b7_row11_col15" class="data row11 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row12" class="row_heading level1 row12" data-quarto-table-cell-role="th">2022-09-05</td>
<td id="T_da7b7_row12_col0" class="data row12 col0">1.000000</td>
<td id="T_da7b7_row12_col1" class="data row12 col1">0.110000</td>
<td id="T_da7b7_row12_col2" class="data row12 col2">0.120000</td>
<td id="T_da7b7_row12_col3" class="data row12 col3">0.150000</td>
<td id="T_da7b7_row12_col4" class="data row12 col4">nan</td>
<td id="T_da7b7_row12_col5" class="data row12 col5">nan</td>
<td id="T_da7b7_row12_col6" class="data row12 col6">nan</td>
<td id="T_da7b7_row12_col7" class="data row12 col7">nan</td>
<td id="T_da7b7_row12_col8" class="data row12 col8">nan</td>
<td id="T_da7b7_row12_col9" class="data row12 col9">nan</td>
<td id="T_da7b7_row12_col10" class="data row12 col10">nan</td>
<td id="T_da7b7_row12_col11" class="data row12 col11">nan</td>
<td id="T_da7b7_row12_col12" class="data row12 col12">nan</td>
<td id="T_da7b7_row12_col13" class="data row12 col13">nan</td>
<td id="T_da7b7_row12_col14" class="data row12 col14">nan</td>
<td id="T_da7b7_row12_col15" class="data row12 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row13" class="row_heading level1 row13" data-quarto-table-cell-role="th">2022-09-06</td>
<td id="T_da7b7_row13_col0" class="data row13 col0">1.000000</td>
<td id="T_da7b7_row13_col1" class="data row13 col1">0.120000</td>
<td id="T_da7b7_row13_col2" class="data row13 col2">0.120000</td>
<td id="T_da7b7_row13_col3" class="data row13 col3">nan</td>
<td id="T_da7b7_row13_col4" class="data row13 col4">nan</td>
<td id="T_da7b7_row13_col5" class="data row13 col5">nan</td>
<td id="T_da7b7_row13_col6" class="data row13 col6">nan</td>
<td id="T_da7b7_row13_col7" class="data row13 col7">nan</td>
<td id="T_da7b7_row13_col8" class="data row13 col8">nan</td>
<td id="T_da7b7_row13_col9" class="data row13 col9">nan</td>
<td id="T_da7b7_row13_col10" class="data row13 col10">nan</td>
<td id="T_da7b7_row13_col11" class="data row13 col11">nan</td>
<td id="T_da7b7_row13_col12" class="data row13 col12">nan</td>
<td id="T_da7b7_row13_col13" class="data row13 col13">nan</td>
<td id="T_da7b7_row13_col14" class="data row13 col14">nan</td>
<td id="T_da7b7_row13_col15" class="data row13 col15">nan</td>
</tr>
<tr class="odd">
<td id="T_da7b7_level1_row14" class="row_heading level1 row14" data-quarto-table-cell-role="th">2022-09-07</td>
<td id="T_da7b7_row14_col0" class="data row14 col0">1.000000</td>
<td id="T_da7b7_row14_col1" class="data row14 col1">0.170000</td>
<td id="T_da7b7_row14_col2" class="data row14 col2">nan</td>
<td id="T_da7b7_row14_col3" class="data row14 col3">nan</td>
<td id="T_da7b7_row14_col4" class="data row14 col4">nan</td>
<td id="T_da7b7_row14_col5" class="data row14 col5">nan</td>
<td id="T_da7b7_row14_col6" class="data row14 col6">nan</td>
<td id="T_da7b7_row14_col7" class="data row14 col7">nan</td>
<td id="T_da7b7_row14_col8" class="data row14 col8">nan</td>
<td id="T_da7b7_row14_col9" class="data row14 col9">nan</td>
<td id="T_da7b7_row14_col10" class="data row14 col10">nan</td>
<td id="T_da7b7_row14_col11" class="data row14 col11">nan</td>
<td id="T_da7b7_row14_col12" class="data row14 col12">nan</td>
<td id="T_da7b7_row14_col13" class="data row14 col13">nan</td>
<td id="T_da7b7_row14_col14" class="data row14 col14">nan</td>
<td id="T_da7b7_row14_col15" class="data row14 col15">nan</td>
</tr>
<tr class="even">
<td id="T_da7b7_level1_row15" class="row_heading level1 row15" data-quarto-table-cell-role="th">2022-09-08</td>
<td id="T_da7b7_row15_col0" class="data row15 col0">1.000000</td>
<td id="T_da7b7_row15_col1" class="data row15 col1">nan</td>
<td id="T_da7b7_row15_col2" class="data row15 col2">nan</td>
<td id="T_da7b7_row15_col3" class="data row15 col3">nan</td>
<td id="T_da7b7_row15_col4" class="data row15 col4">nan</td>
<td id="T_da7b7_row15_col5" class="data row15 col5">nan</td>
<td id="T_da7b7_row15_col6" class="data row15 col6">nan</td>
<td id="T_da7b7_row15_col7" class="data row15 col7">nan</td>
<td id="T_da7b7_row15_col8" class="data row15 col8">nan</td>
<td id="T_da7b7_row15_col9" class="data row15 col9">nan</td>
<td id="T_da7b7_row15_col10" class="data row15 col10">nan</td>
<td id="T_da7b7_row15_col11" class="data row15 col11">nan</td>
<td id="T_da7b7_row15_col12" class="data row15 col12">nan</td>
<td id="T_da7b7_row15_col13" class="data row15 col13">nan</td>
<td id="T_da7b7_row15_col14" class="data row15 col14">nan</td>
<td id="T_da7b7_row15_col15" class="data row15 col15">nan</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>А тепер повернемося до аналізу рекламних кампаній та порахуємо <strong>Retention</strong> для двох груп користувачів. Можливо, справа саме в тому, що один із каналів привів більш активних та зацікавлених користувачів. Давайте це з’ясуємо!</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-12" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.12 </strong></span><br> Для кожної рекламної кампанії порахуйте <strong>Retention 1-го та 7-го дня</strong> у залучених користувачів.</p>
<p>У результаті включіть чотири колонки: колонку з найменуваннями кампаній, дату першої взаємодії з додатком, кількість днів, що минули з дати першої взаємодії (порядковий номер), і саме значення Retention.</p>
<p>Колонки зі значеннями назвіть відповідно <code>ads_campaign</code>, <code>start_date</code>, <code>day_number</code>, <code>retention</code>.</p>
<p>Назви кампаній виведіть у такому вигляді:</p>
<pre><code>Company № 1
Company № 2</code></pre>
<p>Метрику необхідно виразити у вигляді частки, округливши отримані значення <strong>до двох знаків після коми</strong>.</p>
<p>Результат має бути відсортований спочатку за найменуванням кампанії (за зростанням), потім за зростанням порядкового номера дня.</p>
<p>У результат мають потрапити наступні дні: <strong>нульовий, перший та сьомий.</strong></p>
<p>Поля в результуючій таблиці: <code>ads_campaign</code>, <code>start_date</code>, <code>day_number</code>, <code>retention</code></p>
<p><strong>Пояснення:</strong></p>
<p>Списки користувачів, що зареєструвалися, ті ж, що і на попередніх кроках.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Алгоритм розрахунку <strong>Retention</strong> той самий, що і в попередньому завданні, тільки тепер необхідно додати рекламну кампанію в групування і потім відфільтрувати необхідні дні.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="35">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a><span class="op">%%</span>sql</span>
<span id="cb41-2"><a href="#cb41-2"></a>SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb41-3"><a href="#cb41-3"></a>       start_date,</span>
<span id="cb41-4"><a href="#cb41-4"></a>       day_number,</span>
<span id="cb41-5"><a href="#cb41-5"></a>       <span class="bu">round</span>(users::decimal <span class="op">/</span> <span class="bu">max</span>(users) OVER (PARTITION BY ads_campaign,</span>
<span id="cb41-6"><a href="#cb41-6"></a>                                                            start_date), <span class="dv">2</span>) <span class="im">as</span> retention</span>
<span id="cb41-7"><a href="#cb41-7"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb41-8"><a href="#cb41-8"></a>               start_date,</span>
<span id="cb41-9"><a href="#cb41-9"></a>               date <span class="op">-</span> start_date <span class="im">as</span> day_number,</span>
<span id="cb41-10"><a href="#cb41-10"></a>               count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb41-11"><a href="#cb41-11"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb41-12"><a href="#cb41-12"></a>                       user_id,</span>
<span id="cb41-13"><a href="#cb41-13"></a>                       date,</span>
<span id="cb41-14"><a href="#cb41-14"></a>                       <span class="bu">min</span>(date) OVER (PARTITION BY ads_campaign,</span>
<span id="cb41-15"><a href="#cb41-15"></a>                                                    user_id) <span class="im">as</span> start_date</span>
<span id="cb41-16"><a href="#cb41-16"></a>                FROM   (SELECT user_id,</span>
<span id="cb41-17"><a href="#cb41-17"></a>                               time::date <span class="im">as</span> date,</span>
<span id="cb41-18"><a href="#cb41-18"></a>                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb41-19"><a href="#cb41-19"></a>                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb41-20"><a href="#cb41-20"></a>                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb41-21"><a href="#cb41-21"></a>                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb41-22"><a href="#cb41-22"></a>                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb41-23"><a href="#cb41-23"></a>                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb41-24"><a href="#cb41-24"></a>                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb41-25"><a href="#cb41-25"></a>                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb41-26"><a href="#cb41-26"></a>                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb41-27"><a href="#cb41-27"></a>                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb41-28"><a href="#cb41-28"></a>                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb41-29"><a href="#cb41-29"></a>                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb41-30"><a href="#cb41-30"></a>                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb41-31"><a href="#cb41-31"></a>                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb41-32"><a href="#cb41-32"></a>                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb41-33"><a href="#cb41-33"></a>                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb41-34"><a href="#cb41-34"></a>                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb41-35"><a href="#cb41-35"></a>                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb41-36"><a href="#cb41-36"></a>                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb41-37"><a href="#cb41-37"></a>                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb41-38"><a href="#cb41-38"></a>                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb41-39"><a href="#cb41-39"></a>                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb41-40"><a href="#cb41-40"></a>                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb41-41"><a href="#cb41-41"></a>                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb41-42"><a href="#cb41-42"></a>                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb41-43"><a href="#cb41-43"></a>                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb41-44"><a href="#cb41-44"></a>                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb41-45"><a href="#cb41-45"></a>                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb41-46"><a href="#cb41-46"></a>                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb41-47"><a href="#cb41-47"></a>                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb41-48"><a href="#cb41-48"></a>                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb41-49"><a href="#cb41-49"></a>                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb41-50"><a href="#cb41-50"></a>                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb41-51"><a href="#cb41-51"></a>                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb41-52"><a href="#cb41-52"></a>                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb41-53"><a href="#cb41-53"></a>                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb41-54"><a href="#cb41-54"></a>                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb41-55"><a href="#cb41-55"></a>                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb41-56"><a href="#cb41-56"></a>                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb41-57"><a href="#cb41-57"></a>                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb41-58"><a href="#cb41-58"></a>                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb41-59"><a href="#cb41-59"></a>                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb41-60"><a href="#cb41-60"></a>                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb41-61"><a href="#cb41-61"></a>                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb41-62"><a href="#cb41-62"></a>                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb41-63"><a href="#cb41-63"></a>                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb41-64"><a href="#cb41-64"></a>                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign</span>
<span id="cb41-65"><a href="#cb41-65"></a>                        FROM   user_actions) t1</span>
<span id="cb41-66"><a href="#cb41-66"></a>                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)) t2</span>
<span id="cb41-67"><a href="#cb41-67"></a>        GROUP BY ads_campaign, start_date, date) t3</span>
<span id="cb41-68"><a href="#cb41-68"></a>WHERE  day_number <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">7</span>)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ads_campaign</th>
<th data-quarto-table-cell-role="th">start_date</th>
<th data-quarto-table-cell-role="th">day_number</th>
<th data-quarto-table-cell-role="th">retention</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Company № 2</td>
<td>2022-09-01</td>
<td>0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Company № 2</td>
<td>2022-09-01</td>
<td>1</td>
<td>0.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Company № 2</td>
<td>2022-09-01</td>
<td>7</td>
<td>0.09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Company № 1</td>
<td>2022-09-01</td>
<td>0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Company № 1</td>
<td>2022-09-01</td>
<td>1</td>
<td>0.42</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Company № 1</td>
<td>2022-09-01</td>
<td>7</td>
<td>0.22</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_12</code>:</p>
<div class="cell" data-execution_count="36">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a><span class="op">%%</span>sql</span>
<span id="cb42-2"><a href="#cb42-2"></a>results_12 <span class="op">&lt;&lt;</span> SELECT concat(<span class="st">'Company № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb42-3"><a href="#cb42-3"></a>       start_date,</span>
<span id="cb42-4"><a href="#cb42-4"></a>       day_number,</span>
<span id="cb42-5"><a href="#cb42-5"></a>       <span class="bu">round</span>(users::decimal <span class="op">/</span> <span class="bu">max</span>(users) OVER (PARTITION BY ads_campaign,</span>
<span id="cb42-6"><a href="#cb42-6"></a>                                                            start_date), <span class="dv">2</span>) <span class="im">as</span> retention</span>
<span id="cb42-7"><a href="#cb42-7"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb42-8"><a href="#cb42-8"></a>               start_date,</span>
<span id="cb42-9"><a href="#cb42-9"></a>               date <span class="op">-</span> start_date <span class="im">as</span> day_number,</span>
<span id="cb42-10"><a href="#cb42-10"></a>               count(distinct user_id) <span class="im">as</span> users</span>
<span id="cb42-11"><a href="#cb42-11"></a>        FROM   (SELECT ads_campaign,</span>
<span id="cb42-12"><a href="#cb42-12"></a>                       user_id,</span>
<span id="cb42-13"><a href="#cb42-13"></a>                       date,</span>
<span id="cb42-14"><a href="#cb42-14"></a>                       <span class="bu">min</span>(date) OVER (PARTITION BY ads_campaign,</span>
<span id="cb42-15"><a href="#cb42-15"></a>                                                    user_id) <span class="im">as</span> start_date</span>
<span id="cb42-16"><a href="#cb42-16"></a>                FROM   (SELECT user_id,</span>
<span id="cb42-17"><a href="#cb42-17"></a>                               time::date <span class="im">as</span> date,</span>
<span id="cb42-18"><a href="#cb42-18"></a>                               <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb42-19"><a href="#cb42-19"></a>                                                     <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb42-20"><a href="#cb42-20"></a>                                                     <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb42-21"><a href="#cb42-21"></a>                                                     <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb42-22"><a href="#cb42-22"></a>                                                     <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb42-23"><a href="#cb42-23"></a>                                                     <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb42-24"><a href="#cb42-24"></a>                                                     <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb42-25"><a href="#cb42-25"></a>                                                     <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb42-26"><a href="#cb42-26"></a>                                                     <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb42-27"><a href="#cb42-27"></a>                                                     <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb42-28"><a href="#cb42-28"></a>                                                     <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb42-29"><a href="#cb42-29"></a>                                                     <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb42-30"><a href="#cb42-30"></a>                                                     <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb42-31"><a href="#cb42-31"></a>                                                     <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb42-32"><a href="#cb42-32"></a>                                                     <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb42-33"><a href="#cb42-33"></a>                                                     <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb42-34"><a href="#cb42-34"></a>                                                     <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb42-35"><a href="#cb42-35"></a>                                                     <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb42-36"><a href="#cb42-36"></a>                                                     <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb42-37"><a href="#cb42-37"></a>                                    when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb42-38"><a href="#cb42-38"></a>                                                     <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb42-39"><a href="#cb42-39"></a>                                                     <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb42-40"><a href="#cb42-40"></a>                                                     <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb42-41"><a href="#cb42-41"></a>                                                     <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb42-42"><a href="#cb42-42"></a>                                                     <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb42-43"><a href="#cb42-43"></a>                                                     <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb42-44"><a href="#cb42-44"></a>                                                     <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb42-45"><a href="#cb42-45"></a>                                                     <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb42-46"><a href="#cb42-46"></a>                                                     <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb42-47"><a href="#cb42-47"></a>                                                     <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb42-48"><a href="#cb42-48"></a>                                                     <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb42-49"><a href="#cb42-49"></a>                                                     <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb42-50"><a href="#cb42-50"></a>                                                     <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb42-51"><a href="#cb42-51"></a>                                                     <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb42-52"><a href="#cb42-52"></a>                                                     <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb42-53"><a href="#cb42-53"></a>                                                     <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb42-54"><a href="#cb42-54"></a>                                                     <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb42-55"><a href="#cb42-55"></a>                                                     <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb42-56"><a href="#cb42-56"></a>                                                     <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb42-57"><a href="#cb42-57"></a>                                                     <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb42-58"><a href="#cb42-58"></a>                                                     <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb42-59"><a href="#cb42-59"></a>                                                     <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb42-60"><a href="#cb42-60"></a>                                                     <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb42-61"><a href="#cb42-61"></a>                                                     <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb42-62"><a href="#cb42-62"></a>                                                     <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb42-63"><a href="#cb42-63"></a>                                                     <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb42-64"><a href="#cb42-64"></a>                                    <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign</span>
<span id="cb42-65"><a href="#cb42-65"></a>                        FROM   user_actions) t1</span>
<span id="cb42-66"><a href="#cb42-66"></a>                WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)) t2</span>
<span id="cb42-67"><a href="#cb42-67"></a>        GROUP BY ads_campaign, start_date, date) t3</span>
<span id="cb42-68"><a href="#cb42-68"></a>WHERE  day_number <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">7</span>)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Побудуємо зведену таблицю:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>pd.pivot_table(</span>
<span id="cb43-2"><a href="#cb43-2"></a>    results_12,</span>
<span id="cb43-3"><a href="#cb43-3"></a>    index<span class="op">=</span><span class="st">"ads_campaign"</span>,</span>
<span id="cb43-4"><a href="#cb43-4"></a>    columns<span class="op">=</span><span class="st">"day_number"</span>,</span>
<span id="cb43-5"><a href="#cb43-5"></a>    values<span class="op">=</span><span class="st">"retention"</span>,</span>
<span id="cb43-6"><a href="#cb43-6"></a>).style.background_gradient(</span>
<span id="cb43-7"><a href="#cb43-7"></a>    cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb43-8"><a href="#cb43-8"></a>)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<style type="text/css">
#T_45b16_row0_col0, #T_45b16_row1_col0, #T_45b16_row1_col1, #T_45b16_row1_col2 {
  background-color: #f7fbff;
  color: #000000;
}
#T_45b16_row0_col1, #T_45b16_row0_col2 {
  background-color: #08306b;
  color: #f1f1f1;
}
</style>

<table id="T_45b16" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="index_name level0" data-quarto-table-cell-role="th">day_number</th>
<th id="T_45b16_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">0</th>
<th id="T_45b16_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">1</th>
<th id="T_45b16_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">7</th>
</tr>
<tr class="odd">
<th class="index_name level0" data-quarto-table-cell-role="th">ads_campaign</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_45b16_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">Company № 1</td>
<td id="T_45b16_row0_col0" class="data row0 col0">1.000000</td>
<td id="T_45b16_row0_col1" class="data row0 col1">0.420000</td>
<td id="T_45b16_row0_col2" class="data row0 col2">0.220000</td>
</tr>
<tr class="even">
<td id="T_45b16_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">Company № 2</td>
<td id="T_45b16_row1_col0" class="data row1 col0">1.000000</td>
<td id="T_45b16_row1_col1" class="data row1 col1">0.170000</td>
<td id="T_45b16_row1_col2" class="data row1 col2">0.090000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>То чому дві рекламні кампанії відрізняються за значенням метрики <strong>ROI</strong>? Який висновок можна зробити?</p>
<p><strong>Висновок:</strong> користувачі з обох рекламних каналів практично не відрізняються за середнім чеком, але <strong>Retention</strong> майже вдвічі вищий у першої групи. Це призводить до того, що користувачі з першої групи приносять нам більше грошей.</p>
</section>
<section id="накопичувальний-arppu" class="level2 page-columns page-full" data-number="18.10">
<h2 data-number="18.10" class="anchored" data-anchor-id="накопичувальний-arppu"><span class="header-section-number">18.10</span> Накопичувальний ARPPU</h2>
<p>І насамкінець давайте з’ясуємо, на який день дохід від замовлень покупців, що прийшли після першої рекламної кампанії, перевищив витрати на їхнє залучення. Для цього розрахуємо н<strong>акопичувальний ARPPU</strong> та порівняємо його з уже порахованою раніше метрикою <strong>CAC</strong>. Зробимо це для двох кампаній, щоб переконатися, що у випадку другої рекламної кампанії витрати ми поки не окупили.</p>
<p>Суть розрахунку <strong>накопичувального ARPPU</strong> полягає в тому, що для кожного дня кількість покупців у когорті залишатиметься незмінною, а отриманий від їх замовлень дохід — зростатиме. В результаті накопичувальний ARPPU поступово збільшуватиметься і в якийсь момент перевищить суму початкових витрат на залучення одного покупця.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">

</div>
</div>
<div class="callout-body-container callout-body">
<div id="exr-sql-metrics-13" class="theorem exercise">
<p><span class="theorem-title"><strong>Завдання 18.13 </strong></span><br> Для кожної рекламної кампанії кожного дня порахуйте дві метрики:</p>
<ol type="1">
<li>Накопичувальний ARPPU.</li>
<li>Витрати залучення одного покупця (CAC).</li>
</ol>
<p>Колонку з найменуваннями кампаній назвіть <code>ads_campaign</code>, колонку з днями – <code>day</code>, а колонки зі значеннями метрик – <code>cumulative_arppu</code> та <code>cac</code>.</p>
<p>Значення метрики <strong>CAC</strong> вкажіть однаковим для всіх днів (це необхідно для візуалізації).</p>
<p>Назви кампаній виведіть у такому вигляді:</p>
<pre><code>Company № 1
Company № 2</code></pre>
<p>Дні пронумеруйте починаючи з 0 та відобразіть у наступному форматі:</p>
<pre><code>Day 0
Day 1
Day 2
...</code></pre>
<p>Отримані значення метрика необхідно округлити <strong>до двох знаків після коми</strong>.</p>
<p>Результат повинен бути відсортований спочатку за найменуванням кампанії (за зростанням), потім за найменуванням дня (також за зростанням).</p>
<p>Поля в результуючій таблиці: <code>ads_campaign</code>, <code>day</code>, <code>cumulative_arppu</code>, <code>cac</code></p>
<p><strong>Пояснення:</strong></p>
<p>Списки користувачів, що зареєструвалися, ті ж, що і на попередніх кроках.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Підказка на випадок, якщо зовсім не виходить
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Щоб отримати необхідну таблицю, потрібно для кожної рекламної кампанії для кожного дня порахувати сумарну вартість замовлень користувачів, що прийшли відповідним каналом, і розділити її на кількість користувачів, що прийшли в нульовий день. У колонці зі значенням метрики CAC необхідно проставити те саме значення для кожного дня. Метрику CAC ми рахували раніше.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="38">
<details>
<summary>Рішення</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a><span class="op">%%</span>sql</span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="cf">with</span> main_table <span class="im">as</span> (SELECT ads_campaign,</span>
<span id="cb46-3"><a href="#cb46-3"></a>                           user_id,</span>
<span id="cb46-4"><a href="#cb46-4"></a>                           order_id,</span>
<span id="cb46-5"><a href="#cb46-5"></a>                           time,</span>
<span id="cb46-6"><a href="#cb46-6"></a>                           product_id,</span>
<span id="cb46-7"><a href="#cb46-7"></a>                           price</span>
<span id="cb46-8"><a href="#cb46-8"></a>                    FROM   (SELECT ads_campaign,</span>
<span id="cb46-9"><a href="#cb46-9"></a>                                   user_id,</span>
<span id="cb46-10"><a href="#cb46-10"></a>                                   order_id,</span>
<span id="cb46-11"><a href="#cb46-11"></a>                                   time</span>
<span id="cb46-12"><a href="#cb46-12"></a>                            FROM   (SELECT user_id,</span>
<span id="cb46-13"><a href="#cb46-13"></a>                                           order_id,</span>
<span id="cb46-14"><a href="#cb46-14"></a>                                           time,</span>
<span id="cb46-15"><a href="#cb46-15"></a>                                           <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb46-16"><a href="#cb46-16"></a>                                                                 <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb46-17"><a href="#cb46-17"></a>                                                                 <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb46-18"><a href="#cb46-18"></a>                                                                 <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb46-19"><a href="#cb46-19"></a>                                                                 <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb46-20"><a href="#cb46-20"></a>                                                                 <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb46-21"><a href="#cb46-21"></a>                                                                 <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb46-22"><a href="#cb46-22"></a>                                                                 <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb46-23"><a href="#cb46-23"></a>                                                                 <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb46-24"><a href="#cb46-24"></a>                                                                 <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb46-25"><a href="#cb46-25"></a>                                                                 <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb46-26"><a href="#cb46-26"></a>                                                                 <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb46-27"><a href="#cb46-27"></a>                                                                 <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb46-28"><a href="#cb46-28"></a>                                                                 <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb46-29"><a href="#cb46-29"></a>                                                                 <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb46-30"><a href="#cb46-30"></a>                                                                 <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb46-31"><a href="#cb46-31"></a>                                                                 <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb46-32"><a href="#cb46-32"></a>                                                                 <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb46-33"><a href="#cb46-33"></a>                                                                 <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb46-34"><a href="#cb46-34"></a>                                                when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb46-35"><a href="#cb46-35"></a>                                                                 <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb46-36"><a href="#cb46-36"></a>                                                                 <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb46-37"><a href="#cb46-37"></a>                                                                 <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb46-38"><a href="#cb46-38"></a>                                                                 <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb46-39"><a href="#cb46-39"></a>                                                                 <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb46-40"><a href="#cb46-40"></a>                                                                 <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb46-41"><a href="#cb46-41"></a>                                                                 <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb46-42"><a href="#cb46-42"></a>                                                                 <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb46-43"><a href="#cb46-43"></a>                                                                 <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb46-44"><a href="#cb46-44"></a>                                                                 <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb46-45"><a href="#cb46-45"></a>                                                                 <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb46-46"><a href="#cb46-46"></a>                                                                 <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb46-47"><a href="#cb46-47"></a>                                                                 <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb46-48"><a href="#cb46-48"></a>                                                                 <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb46-49"><a href="#cb46-49"></a>                                                                 <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb46-50"><a href="#cb46-50"></a>                                                                 <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb46-51"><a href="#cb46-51"></a>                                                                 <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb46-52"><a href="#cb46-52"></a>                                                                 <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb46-53"><a href="#cb46-53"></a>                                                                 <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb46-54"><a href="#cb46-54"></a>                                                                 <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb46-55"><a href="#cb46-55"></a>                                                                 <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb46-56"><a href="#cb46-56"></a>                                                                 <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb46-57"><a href="#cb46-57"></a>                                                                 <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb46-58"><a href="#cb46-58"></a>                                                                 <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb46-59"><a href="#cb46-59"></a>                                                                 <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb46-60"><a href="#cb46-60"></a>                                                                 <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb46-61"><a href="#cb46-61"></a>                                                <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb46-62"><a href="#cb46-62"></a>                                           count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb46-63"><a href="#cb46-63"></a>                                    FROM   user_actions) t1</span>
<span id="cb46-64"><a href="#cb46-64"></a>                            WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb46-65"><a href="#cb46-65"></a>                               <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span>) t2</span>
<span id="cb46-66"><a href="#cb46-66"></a>                        LEFT JOIN (SELECT order_id,</span>
<span id="cb46-67"><a href="#cb46-67"></a>                                          unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb46-68"><a href="#cb46-68"></a>                                   FROM   orders) t3 using(order_id)</span>
<span id="cb46-69"><a href="#cb46-69"></a>                        LEFT JOIN products using(product_id))</span>
<span id="cb46-70"><a href="#cb46-70"></a>SELECT concat(<span class="st">'Кампания № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb46-71"><a href="#cb46-71"></a>       concat(<span class="st">'Day '</span>, row_number() OVER (PARTITION BY ads_campaign</span>
<span id="cb46-72"><a href="#cb46-72"></a>                                         ORDER BY date) <span class="op">-</span> <span class="dv">1</span>) <span class="im">as</span> day,</span>
<span id="cb46-73"><a href="#cb46-73"></a>       <span class="bu">round</span>(<span class="bu">sum</span>(revenue) OVER (PARTITION BY ads_campaign</span>
<span id="cb46-74"><a href="#cb46-74"></a>                                ORDER BY date) <span class="op">/</span> paying_users::decimal, <span class="dv">2</span>) <span class="im">as</span> cumulative_arppu,</span>
<span id="cb46-75"><a href="#cb46-75"></a>       cac</span>
<span id="cb46-76"><a href="#cb46-76"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb46-77"><a href="#cb46-77"></a>               time::date <span class="im">as</span> date,</span>
<span id="cb46-78"><a href="#cb46-78"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb46-79"><a href="#cb46-79"></a>        FROM   main_table</span>
<span id="cb46-80"><a href="#cb46-80"></a>        GROUP BY ads_campaign, time::date) t1</span>
<span id="cb46-81"><a href="#cb46-81"></a>    LEFT JOIN (SELECT ads_campaign,</span>
<span id="cb46-82"><a href="#cb46-82"></a>                      count(distinct user_id) <span class="im">as</span> paying_users,</span>
<span id="cb46-83"><a href="#cb46-83"></a>                      <span class="bu">round</span>(<span class="fl">250000.0</span> <span class="op">/</span> count(distinct user_id), <span class="dv">2</span>) <span class="im">as</span> cac</span>
<span id="cb46-84"><a href="#cb46-84"></a>               FROM   main_table</span>
<span id="cb46-85"><a href="#cb46-85"></a>               GROUP BY ads_campaign) t2 using (ads_campaign)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ads_campaign</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">cumulative_arppu</th>
<th data-quarto-table-cell-role="th">cac</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Кампания № 2</td>
<td>Day 0</td>
<td>548.42</td>
<td>1068.38</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Кампания № 2</td>
<td>Day 1</td>
<td>656.20</td>
<td>1068.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Кампания № 2</td>
<td>Day 2</td>
<td>765.34</td>
<td>1068.38</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Кампания № 2</td>
<td>Day 3</td>
<td>829.88</td>
<td>1068.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Кампания № 2</td>
<td>Day 4</td>
<td>888.80</td>
<td>1068.38</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Кампания № 2</td>
<td>Day 5</td>
<td>938.66</td>
<td>1068.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Кампания № 2</td>
<td>Day 6</td>
<td>999.46</td>
<td>1068.38</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Кампания № 2</td>
<td>Day 7</td>
<td>1051.21</td>
<td>1068.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Кампания № 1</td>
<td>Day 0</td>
<td>521.36</td>
<td>1461.99</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Кампания № 1</td>
<td>Day 1</td>
<td>784.64</td>
<td>1461.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Кампания № 1</td>
<td>Day 2</td>
<td>1010.70</td>
<td>1461.99</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Кампания № 1</td>
<td>Day 3</td>
<td>1227.84</td>
<td>1461.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Кампания № 1</td>
<td>Day 4</td>
<td>1375.46</td>
<td>1461.99</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Кампания № 1</td>
<td>Day 5</td>
<td>1464.25</td>
<td>1461.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Кампания № 1</td>
<td>Day 6</td>
<td>1575.26</td>
<td>1461.99</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Кампания № 1</td>
<td>Day 7</td>
<td>1674.02</td>
<td>1461.99</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Збережемо результат запиту у змінну <code>results_13</code>:</p>
<div class="cell" data-execution_count="39">
<details>
<summary>Код</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1"></a><span class="op">%%</span>sql</span>
<span id="cb47-2"><a href="#cb47-2"></a>results_13 <span class="op">&lt;&lt;</span> <span class="cf">with</span> main_table <span class="im">as</span> (SELECT ads_campaign,</span>
<span id="cb47-3"><a href="#cb47-3"></a>                           user_id,</span>
<span id="cb47-4"><a href="#cb47-4"></a>                           order_id,</span>
<span id="cb47-5"><a href="#cb47-5"></a>                           time,</span>
<span id="cb47-6"><a href="#cb47-6"></a>                           product_id,</span>
<span id="cb47-7"><a href="#cb47-7"></a>                           price</span>
<span id="cb47-8"><a href="#cb47-8"></a>                    FROM   (SELECT ads_campaign,</span>
<span id="cb47-9"><a href="#cb47-9"></a>                                   user_id,</span>
<span id="cb47-10"><a href="#cb47-10"></a>                                   order_id,</span>
<span id="cb47-11"><a href="#cb47-11"></a>                                   time</span>
<span id="cb47-12"><a href="#cb47-12"></a>                            FROM   (SELECT user_id,</span>
<span id="cb47-13"><a href="#cb47-13"></a>                                           order_id,</span>
<span id="cb47-14"><a href="#cb47-14"></a>                                           time,</span>
<span id="cb47-15"><a href="#cb47-15"></a>                                           <span class="cf">case</span> when user_id <span class="kw">in</span> (<span class="dv">8631</span>, <span class="dv">8632</span>, <span class="dv">8638</span>, <span class="dv">8643</span>, <span class="dv">8657</span>, <span class="dv">8673</span>, <span class="dv">8706</span>, <span class="dv">8707</span>, <span class="dv">8715</span>, <span class="dv">8723</span>, <span class="dv">8732</span>,</span>
<span id="cb47-16"><a href="#cb47-16"></a>                                                                 <span class="dv">8739</span>, <span class="dv">8741</span>, <span class="dv">8750</span>, <span class="dv">8751</span>, <span class="dv">8752</span>, <span class="dv">8770</span>, <span class="dv">8774</span>, <span class="dv">8788</span>, <span class="dv">8791</span>,</span>
<span id="cb47-17"><a href="#cb47-17"></a>                                                                 <span class="dv">8804</span>, <span class="dv">8810</span>, <span class="dv">8815</span>, <span class="dv">8828</span>, <span class="dv">8830</span>, <span class="dv">8845</span>, <span class="dv">8853</span>, <span class="dv">8859</span>, <span class="dv">8867</span>,</span>
<span id="cb47-18"><a href="#cb47-18"></a>                                                                 <span class="dv">8869</span>, <span class="dv">8876</span>, <span class="dv">8879</span>, <span class="dv">8883</span>, <span class="dv">8896</span>, <span class="dv">8909</span>, <span class="dv">8911</span>, <span class="dv">8933</span>, <span class="dv">8940</span>,</span>
<span id="cb47-19"><a href="#cb47-19"></a>                                                                 <span class="dv">8972</span>, <span class="dv">8976</span>, <span class="dv">8988</span>, <span class="dv">8990</span>, <span class="dv">9002</span>, <span class="dv">9004</span>, <span class="dv">9009</span>, <span class="dv">9019</span>, <span class="dv">9020</span>,</span>
<span id="cb47-20"><a href="#cb47-20"></a>                                                                 <span class="dv">9035</span>, <span class="dv">9036</span>, <span class="dv">9061</span>, <span class="dv">9069</span>, <span class="dv">9071</span>, <span class="dv">9075</span>, <span class="dv">9081</span>, <span class="dv">9085</span>, <span class="dv">9089</span>,</span>
<span id="cb47-21"><a href="#cb47-21"></a>                                                                 <span class="dv">9108</span>, <span class="dv">9113</span>, <span class="dv">9144</span>, <span class="dv">9145</span>, <span class="dv">9146</span>, <span class="dv">9162</span>, <span class="dv">9165</span>, <span class="dv">9167</span>, <span class="dv">9175</span>,</span>
<span id="cb47-22"><a href="#cb47-22"></a>                                                                 <span class="dv">9180</span>, <span class="dv">9182</span>, <span class="dv">9197</span>, <span class="dv">9198</span>, <span class="dv">9210</span>, <span class="dv">9223</span>, <span class="dv">9251</span>, <span class="dv">9257</span>, <span class="dv">9278</span>,</span>
<span id="cb47-23"><a href="#cb47-23"></a>                                                                 <span class="dv">9287</span>, <span class="dv">9291</span>, <span class="dv">9313</span>, <span class="dv">9317</span>, <span class="dv">9321</span>, <span class="dv">9334</span>, <span class="dv">9351</span>, <span class="dv">9391</span>, <span class="dv">9398</span>,</span>
<span id="cb47-24"><a href="#cb47-24"></a>                                                                 <span class="dv">9414</span>, <span class="dv">9420</span>, <span class="dv">9422</span>, <span class="dv">9431</span>, <span class="dv">9450</span>, <span class="dv">9451</span>, <span class="dv">9454</span>, <span class="dv">9472</span>, <span class="dv">9476</span>,</span>
<span id="cb47-25"><a href="#cb47-25"></a>                                                                 <span class="dv">9478</span>, <span class="dv">9491</span>, <span class="dv">9494</span>, <span class="dv">9505</span>, <span class="dv">9512</span>, <span class="dv">9518</span>, <span class="dv">9524</span>, <span class="dv">9526</span>, <span class="dv">9528</span>,</span>
<span id="cb47-26"><a href="#cb47-26"></a>                                                                 <span class="dv">9531</span>, <span class="dv">9535</span>, <span class="dv">9550</span>, <span class="dv">9559</span>, <span class="dv">9561</span>, <span class="dv">9562</span>, <span class="dv">9599</span>, <span class="dv">9603</span>, <span class="dv">9605</span>,</span>
<span id="cb47-27"><a href="#cb47-27"></a>                                                                 <span class="dv">9611</span>, <span class="dv">9612</span>, <span class="dv">9615</span>, <span class="dv">9625</span>, <span class="dv">9633</span>, <span class="dv">9652</span>, <span class="dv">9654</span>, <span class="dv">9655</span>, <span class="dv">9660</span>,</span>
<span id="cb47-28"><a href="#cb47-28"></a>                                                                 <span class="dv">9662</span>, <span class="dv">9667</span>, <span class="dv">9677</span>, <span class="dv">9679</span>, <span class="dv">9689</span>, <span class="dv">9695</span>, <span class="dv">9720</span>, <span class="dv">9726</span>, <span class="dv">9739</span>,</span>
<span id="cb47-29"><a href="#cb47-29"></a>                                                                 <span class="dv">9740</span>, <span class="dv">9762</span>, <span class="dv">9778</span>, <span class="dv">9786</span>, <span class="dv">9794</span>, <span class="dv">9804</span>, <span class="dv">9810</span>, <span class="dv">9813</span>, <span class="dv">9818</span>,</span>
<span id="cb47-30"><a href="#cb47-30"></a>                                                                 <span class="dv">9828</span>, <span class="dv">9831</span>, <span class="dv">9836</span>, <span class="dv">9838</span>, <span class="dv">9845</span>, <span class="dv">9871</span>, <span class="dv">9887</span>, <span class="dv">9891</span>, <span class="dv">9896</span>,</span>
<span id="cb47-31"><a href="#cb47-31"></a>                                                                 <span class="dv">9897</span>, <span class="dv">9916</span>, <span class="dv">9945</span>, <span class="dv">9960</span>, <span class="dv">9963</span>, <span class="dv">9965</span>, <span class="dv">9968</span>, <span class="dv">9971</span>, <span class="dv">9993</span>,</span>
<span id="cb47-32"><a href="#cb47-32"></a>                                                                 <span class="dv">9998</span>, <span class="dv">9999</span>, <span class="dv">10001</span>, <span class="dv">10013</span>, <span class="dv">10016</span>, <span class="dv">10023</span>, <span class="dv">10030</span>, <span class="dv">10051</span>,</span>
<span id="cb47-33"><a href="#cb47-33"></a>                                                                 <span class="dv">10057</span>, <span class="dv">10064</span>, <span class="dv">10082</span>, <span class="dv">10103</span>, <span class="dv">10105</span>, <span class="dv">10122</span>, <span class="dv">10134</span>, <span class="dv">10135</span>) then <span class="dv">1</span></span>
<span id="cb47-34"><a href="#cb47-34"></a>                                                when user_id <span class="kw">in</span> (<span class="dv">8629</span>, <span class="dv">8630</span>, <span class="dv">8644</span>, <span class="dv">8646</span>, <span class="dv">8650</span>, <span class="dv">8655</span>, <span class="dv">8659</span>, <span class="dv">8660</span>, <span class="dv">8663</span>, <span class="dv">8665</span>, <span class="dv">8670</span>,</span>
<span id="cb47-35"><a href="#cb47-35"></a>                                                                 <span class="dv">8675</span>, <span class="dv">8680</span>, <span class="dv">8681</span>, <span class="dv">8682</span>, <span class="dv">8683</span>, <span class="dv">8694</span>, <span class="dv">8697</span>, <span class="dv">8700</span>, <span class="dv">8704</span>,</span>
<span id="cb47-36"><a href="#cb47-36"></a>                                                                 <span class="dv">8712</span>, <span class="dv">8713</span>, <span class="dv">8719</span>, <span class="dv">8729</span>, <span class="dv">8733</span>, <span class="dv">8742</span>, <span class="dv">8748</span>, <span class="dv">8754</span>, <span class="dv">8771</span>,</span>
<span id="cb47-37"><a href="#cb47-37"></a>                                                                 <span class="dv">8794</span>, <span class="dv">8795</span>, <span class="dv">8798</span>, <span class="dv">8803</span>, <span class="dv">8805</span>, <span class="dv">8806</span>, <span class="dv">8812</span>, <span class="dv">8814</span>, <span class="dv">8825</span>,</span>
<span id="cb47-38"><a href="#cb47-38"></a>                                                                 <span class="dv">8827</span>, <span class="dv">8838</span>, <span class="dv">8849</span>, <span class="dv">8851</span>, <span class="dv">8854</span>, <span class="dv">8855</span>, <span class="dv">8870</span>, <span class="dv">8878</span>, <span class="dv">8882</span>,</span>
<span id="cb47-39"><a href="#cb47-39"></a>                                                                 <span class="dv">8886</span>, <span class="dv">8890</span>, <span class="dv">8893</span>, <span class="dv">8900</span>, <span class="dv">8902</span>, <span class="dv">8913</span>, <span class="dv">8916</span>, <span class="dv">8923</span>, <span class="dv">8929</span>,</span>
<span id="cb47-40"><a href="#cb47-40"></a>                                                                 <span class="dv">8935</span>, <span class="dv">8942</span>, <span class="dv">8943</span>, <span class="dv">8949</span>, <span class="dv">8953</span>, <span class="dv">8955</span>, <span class="dv">8966</span>, <span class="dv">8968</span>, <span class="dv">8971</span>,</span>
<span id="cb47-41"><a href="#cb47-41"></a>                                                                 <span class="dv">8973</span>, <span class="dv">8980</span>, <span class="dv">8995</span>, <span class="dv">8999</span>, <span class="dv">9000</span>, <span class="dv">9007</span>, <span class="dv">9013</span>, <span class="dv">9041</span>, <span class="dv">9042</span>,</span>
<span id="cb47-42"><a href="#cb47-42"></a>                                                                 <span class="dv">9047</span>, <span class="dv">9064</span>, <span class="dv">9068</span>, <span class="dv">9077</span>, <span class="dv">9082</span>, <span class="dv">9083</span>, <span class="dv">9095</span>, <span class="dv">9103</span>, <span class="dv">9109</span>,</span>
<span id="cb47-43"><a href="#cb47-43"></a>                                                                 <span class="dv">9117</span>, <span class="dv">9123</span>, <span class="dv">9127</span>, <span class="dv">9131</span>, <span class="dv">9137</span>, <span class="dv">9140</span>, <span class="dv">9149</span>, <span class="dv">9161</span>, <span class="dv">9179</span>,</span>
<span id="cb47-44"><a href="#cb47-44"></a>                                                                 <span class="dv">9181</span>, <span class="dv">9183</span>, <span class="dv">9185</span>, <span class="dv">9190</span>, <span class="dv">9196</span>, <span class="dv">9203</span>, <span class="dv">9207</span>, <span class="dv">9226</span>, <span class="dv">9227</span>,</span>
<span id="cb47-45"><a href="#cb47-45"></a>                                                                 <span class="dv">9229</span>, <span class="dv">9230</span>, <span class="dv">9231</span>, <span class="dv">9250</span>, <span class="dv">9255</span>, <span class="dv">9259</span>, <span class="dv">9267</span>, <span class="dv">9273</span>, <span class="dv">9281</span>,</span>
<span id="cb47-46"><a href="#cb47-46"></a>                                                                 <span class="dv">9282</span>, <span class="dv">9289</span>, <span class="dv">9292</span>, <span class="dv">9303</span>, <span class="dv">9310</span>, <span class="dv">9312</span>, <span class="dv">9315</span>, <span class="dv">9327</span>, <span class="dv">9333</span>,</span>
<span id="cb47-47"><a href="#cb47-47"></a>                                                                 <span class="dv">9335</span>, <span class="dv">9337</span>, <span class="dv">9343</span>, <span class="dv">9356</span>, <span class="dv">9368</span>, <span class="dv">9370</span>, <span class="dv">9383</span>, <span class="dv">9392</span>, <span class="dv">9404</span>,</span>
<span id="cb47-48"><a href="#cb47-48"></a>                                                                 <span class="dv">9410</span>, <span class="dv">9421</span>, <span class="dv">9428</span>, <span class="dv">9432</span>, <span class="dv">9437</span>, <span class="dv">9468</span>, <span class="dv">9479</span>, <span class="dv">9483</span>, <span class="dv">9485</span>,</span>
<span id="cb47-49"><a href="#cb47-49"></a>                                                                 <span class="dv">9492</span>, <span class="dv">9495</span>, <span class="dv">9497</span>, <span class="dv">9498</span>, <span class="dv">9500</span>, <span class="dv">9510</span>, <span class="dv">9527</span>, <span class="dv">9529</span>, <span class="dv">9530</span>,</span>
<span id="cb47-50"><a href="#cb47-50"></a>                                                                 <span class="dv">9538</span>, <span class="dv">9539</span>, <span class="dv">9545</span>, <span class="dv">9557</span>, <span class="dv">9558</span>, <span class="dv">9560</span>, <span class="dv">9564</span>, <span class="dv">9567</span>, <span class="dv">9570</span>,</span>
<span id="cb47-51"><a href="#cb47-51"></a>                                                                 <span class="dv">9591</span>, <span class="dv">9596</span>, <span class="dv">9598</span>, <span class="dv">9616</span>, <span class="dv">9631</span>, <span class="dv">9634</span>, <span class="dv">9635</span>, <span class="dv">9636</span>, <span class="dv">9658</span>,</span>
<span id="cb47-52"><a href="#cb47-52"></a>                                                                 <span class="dv">9666</span>, <span class="dv">9672</span>, <span class="dv">9684</span>, <span class="dv">9692</span>, <span class="dv">9700</span>, <span class="dv">9704</span>, <span class="dv">9706</span>, <span class="dv">9711</span>, <span class="dv">9719</span>,</span>
<span id="cb47-53"><a href="#cb47-53"></a>                                                                 <span class="dv">9727</span>, <span class="dv">9735</span>, <span class="dv">9741</span>, <span class="dv">9744</span>, <span class="dv">9749</span>, <span class="dv">9752</span>, <span class="dv">9753</span>, <span class="dv">9755</span>, <span class="dv">9757</span>,</span>
<span id="cb47-54"><a href="#cb47-54"></a>                                                                 <span class="dv">9764</span>, <span class="dv">9783</span>, <span class="dv">9784</span>, <span class="dv">9788</span>, <span class="dv">9790</span>, <span class="dv">9808</span>, <span class="dv">9820</span>, <span class="dv">9839</span>, <span class="dv">9841</span>,</span>
<span id="cb47-55"><a href="#cb47-55"></a>                                                                 <span class="dv">9843</span>, <span class="dv">9853</span>, <span class="dv">9855</span>, <span class="dv">9859</span>, <span class="dv">9863</span>, <span class="dv">9877</span>, <span class="dv">9879</span>, <span class="dv">9880</span>, <span class="dv">9882</span>,</span>
<span id="cb47-56"><a href="#cb47-56"></a>                                                                 <span class="dv">9883</span>, <span class="dv">9885</span>, <span class="dv">9901</span>, <span class="dv">9904</span>, <span class="dv">9908</span>, <span class="dv">9910</span>, <span class="dv">9912</span>, <span class="dv">9920</span>, <span class="dv">9929</span>,</span>
<span id="cb47-57"><a href="#cb47-57"></a>                                                                 <span class="dv">9930</span>, <span class="dv">9935</span>, <span class="dv">9939</span>, <span class="dv">9958</span>, <span class="dv">9959</span>, <span class="dv">9961</span>, <span class="dv">9983</span>, <span class="dv">10027</span>, <span class="dv">10033</span>,</span>
<span id="cb47-58"><a href="#cb47-58"></a>                                                                 <span class="dv">10038</span>, <span class="dv">10045</span>, <span class="dv">10047</span>, <span class="dv">10048</span>, <span class="dv">10058</span>, <span class="dv">10059</span>, <span class="dv">10067</span>, <span class="dv">10069</span>,</span>
<span id="cb47-59"><a href="#cb47-59"></a>                                                                 <span class="dv">10073</span>, <span class="dv">10075</span>, <span class="dv">10078</span>, <span class="dv">10079</span>, <span class="dv">10081</span>, <span class="dv">10092</span>, <span class="dv">10106</span>, <span class="dv">10110</span>,</span>
<span id="cb47-60"><a href="#cb47-60"></a>                                                                 <span class="dv">10113</span>, <span class="dv">10131</span>) then <span class="dv">2</span></span>
<span id="cb47-61"><a href="#cb47-61"></a>                                                <span class="cf">else</span> <span class="dv">0</span> end <span class="im">as</span> ads_campaign,</span>
<span id="cb47-62"><a href="#cb47-62"></a>                                           count(action) <span class="bu">filter</span> (WHERE action <span class="op">=</span> <span class="st">'cancel_order'</span>) OVER (PARTITION BY order_id) <span class="im">as</span> is_canceled</span>
<span id="cb47-63"><a href="#cb47-63"></a>                                    FROM   user_actions) t1</span>
<span id="cb47-64"><a href="#cb47-64"></a>                            WHERE  ads_campaign <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb47-65"><a href="#cb47-65"></a>                               <span class="kw">and</span> is_canceled <span class="op">=</span> <span class="dv">0</span>) t2</span>
<span id="cb47-66"><a href="#cb47-66"></a>                        LEFT JOIN (SELECT order_id,</span>
<span id="cb47-67"><a href="#cb47-67"></a>                                          unnest(product_ids) <span class="im">as</span> product_id</span>
<span id="cb47-68"><a href="#cb47-68"></a>                                   FROM   orders) t3 using(order_id)</span>
<span id="cb47-69"><a href="#cb47-69"></a>                        LEFT JOIN products using(product_id))</span>
<span id="cb47-70"><a href="#cb47-70"></a>SELECT concat(<span class="st">'Кампания № '</span>, ads_campaign) <span class="im">as</span> ads_campaign,</span>
<span id="cb47-71"><a href="#cb47-71"></a>       concat(<span class="st">'Day '</span>, row_number() OVER (PARTITION BY ads_campaign</span>
<span id="cb47-72"><a href="#cb47-72"></a>                                         ORDER BY date) <span class="op">-</span> <span class="dv">1</span>) <span class="im">as</span> day,</span>
<span id="cb47-73"><a href="#cb47-73"></a>       <span class="bu">round</span>(<span class="bu">sum</span>(revenue) OVER (PARTITION BY ads_campaign</span>
<span id="cb47-74"><a href="#cb47-74"></a>                                ORDER BY date) <span class="op">/</span> paying_users::decimal, <span class="dv">2</span>) <span class="im">as</span> cumulative_arppu,</span>
<span id="cb47-75"><a href="#cb47-75"></a>       cac</span>
<span id="cb47-76"><a href="#cb47-76"></a>FROM   (SELECT ads_campaign,</span>
<span id="cb47-77"><a href="#cb47-77"></a>               time::date <span class="im">as</span> date,</span>
<span id="cb47-78"><a href="#cb47-78"></a>               <span class="bu">sum</span>(price) <span class="im">as</span> revenue</span>
<span id="cb47-79"><a href="#cb47-79"></a>        FROM   main_table</span>
<span id="cb47-80"><a href="#cb47-80"></a>        GROUP BY ads_campaign, time::date) t1</span>
<span id="cb47-81"><a href="#cb47-81"></a>    LEFT JOIN (SELECT ads_campaign,</span>
<span id="cb47-82"><a href="#cb47-82"></a>                      count(distinct user_id) <span class="im">as</span> paying_users,</span>
<span id="cb47-83"><a href="#cb47-83"></a>                      <span class="bu">round</span>(<span class="fl">250000.0</span> <span class="op">/</span> count(distinct user_id), <span class="dv">2</span>) <span class="im">as</span> cac</span>
<span id="cb47-84"><a href="#cb47-84"></a>               FROM   main_table</span>
<span id="cb47-85"><a href="#cb47-85"></a>               GROUP BY ads_campaign) t2 using (ads_campaign)</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Візуалізуємо отримані дані:</p>
<div class="page-columns page-full">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a>comp_1 <span class="op">=</span> results_13[results_13[<span class="st">"ads_campaign"</span>] <span class="op">==</span> <span class="st">"Кампания № 1"</span>]</span>
<span id="cb48-4"><a href="#cb48-4"></a>comp_2 <span class="op">=</span> results_13[results_13[<span class="st">"ads_campaign"</span>] <span class="op">==</span> <span class="st">"Кампания № 2"</span>]</span>
<span id="cb48-5"><a href="#cb48-5"></a></span>
<span id="cb48-6"><a href="#cb48-6"></a>fig <span class="op">=</span> px.area(comp_1, x<span class="op">=</span><span class="st">"day"</span>, y<span class="op">=</span><span class="st">"cumulative_arppu"</span>)</span>
<span id="cb48-7"><a href="#cb48-7"></a>fig.add_hline(y<span class="op">=</span><span class="fl">1461.99</span>, line_color<span class="op">=</span><span class="st">"red"</span>, annotation_text<span class="op">=</span><span class="st">"CAC = 1461.99"</span>)</span>
<span id="cb48-8"><a href="#cb48-8"></a>fig.show()</span>
<span id="cb48-9"><a href="#cb48-9"></a></span>
<span id="cb48-10"><a href="#cb48-10"></a>fig <span class="op">=</span> px.area(comp_2, x<span class="op">=</span><span class="st">"day"</span>, y<span class="op">=</span><span class="st">"cumulative_arppu"</span>)</span>
<span id="cb48-11"><a href="#cb48-11"></a>fig.add_hline(y<span class="op">=</span><span class="fl">1068.38</span>, line_color<span class="op">=</span><span class="st">"red"</span>, annotation_text<span class="op">=</span><span class="st">"CAC = 1068.38"</span>)</span>
<span id="cb48-12"><a href="#cb48-12"></a>fig.show()</span></code><button title="Копіювати" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-sql-metrics-13" class="cell column-screen-inset-shaded quarto-layout-panel" data-execution_count="40">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="fig-sql-metrics-13-1" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="33220d46-c842-4da0-9561-27eebfcc0fe1" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("33220d46-c842-4da0-9561-27eebfcc0fe1")) {                    Plotly.newPlot(                        "33220d46-c842-4da0-9561-27eebfcc0fe1",                        [{"fillpattern":{"shape":""},"hovertemplate":"day=%{x}\u003cbr\u003ecumulative_arppu=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","line":{"color":"#636efa"},"marker":{"symbol":"circle"},"mode":"lines","name":"","orientation":"v","showlegend":false,"stackgroup":"1","x":["Day 0","Day 1","Day 2","Day 3","Day 4","Day 5","Day 6","Day 7"],"xaxis":"x","y":[521.36,784.64,1010.7,1227.84,1375.46,1464.25,1575.26,1674.02],"yaxis":"y","type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"day"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"cumulative_arppu"}},"legend":{"tracegroupgap":0},"margin":{"t":60},"shapes":[{"line":{"color":"red"},"type":"line","x0":0,"x1":1,"xref":"x domain","y0":1461.99,"y1":1461.99,"yref":"y"}],"annotations":[{"showarrow":false,"text":"CAC = 1461.99","x":1,"xanchor":"right","xref":"x domain","y":1461.99,"yanchor":"bottom","yref":"y"}]},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('33220d46-c842-4da0-9561-27eebfcc0fe1');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(a) Графік для першої рекламної кампанії</figcaption>
</figure>
</div>
<div id="fig-sql-metrics-13-2" class="quarto-figure quarto-figure-center anchored" style="flex-basis: 50.0%;justify-content: center;">
<figure class="figure">

<div>                            <div id="57c40b04-12e2-46ab-ad73-e68d017798dc" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("57c40b04-12e2-46ab-ad73-e68d017798dc")) {                    Plotly.newPlot(                        "57c40b04-12e2-46ab-ad73-e68d017798dc",                        [{"fillpattern":{"shape":""},"hovertemplate":"day=%{x}\u003cbr\u003ecumulative_arppu=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","line":{"color":"#636efa"},"marker":{"symbol":"circle"},"mode":"lines","name":"","orientation":"v","showlegend":false,"stackgroup":"1","x":["Day 0","Day 1","Day 2","Day 3","Day 4","Day 5","Day 6","Day 7"],"xaxis":"x","y":[548.42,656.2,765.34,829.88,888.8,938.66,999.46,1051.21],"yaxis":"y","type":"scatter"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"day"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"cumulative_arppu"}},"legend":{"tracegroupgap":0},"margin":{"t":60},"shapes":[{"line":{"color":"red"},"type":"line","x0":0,"x1":1,"xref":"x domain","y0":1068.38,"y1":1068.38,"yref":"y"}],"annotations":[{"showarrow":false,"text":"CAC = 1068.38","x":1,"xanchor":"right","xref":"x domain","y":1068.38,"yanchor":"bottom","yref":"y"}]},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('57c40b04-12e2-46ab-ad73-e68d017798dc');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
<figcaption class="figure-caption">(b) Графік для першої рекламної кампанії</figcaption>
</figure>
</div>
</div>
<p></p><figcaption class="figure-caption">Рисунок&nbsp;18.11: Графік за результатами SQL-запиту</figcaption><p></p>
</figure>
</div>
</div>
<p>Який висновок можна зробити на основі побудованих графіків?</p>
<p><strong>Висновок:</strong> для першої рекламної кампанії накопичувальний ARPPU перевищив витрати на залучення одного покупця (CAC) вже на 5 день, тоді як для другої кампанії навіть на 7 день значення CAC все ще перевищувало значення ARPPU.</p>


</section>

<p><a href="https://t.me/araprof"><img src="https://img.shields.io/badge/Telegram-2CA5E0?style=for-the-badge&amp;logo=telegram&amp;logoColor=white.png" class="img-fluid" alt="Data Miorsh"></a> <a href="https://www.linkedin.com/in/ihormiroshnychenko/"><img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white.png" class="img-fluid" alt="Ihor Miroshnychenko"></a> <a href="https://www.youtube.com/@datamirosh"><img src="https://img.shields.io/badge/YouTube-FF0000?style=for-the-badge&amp;logo=youtube&amp;logoColor=white.png" class="img-fluid" alt="Youtube"></a> <a href="https://send.monobank.ua/jar/3rgj2uzZTs"><img src="https://img.shields.io/badge/sponsor-30363D?style=for-the-badge&amp;logo=GitHub-Sponsors&amp;logoColor=#white.png" class="img-fluid" alt="Monobank"></a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопійовано!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопійовано!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="aranaur/py4ds" data-repo-id="R_kgDOIR_TDw" data-category="General" data-category-id="DIC_kwDOIR_TD84CYOoA" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./sql_analytic.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Практичні задачі</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>