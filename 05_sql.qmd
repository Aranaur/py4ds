# SQL {#sec-sql}

SQL (анг. *Structured query language*) - мова запитів на якому ми спілкуємось з базами даних.

База даних - це сховище даних, де зберігаються наші "таблиці".
```{python}
#| file: _common.py
#| include: false
```

```{r}
#| include: false
source('_common.r')
```

## Схема бази даних

У цьому розділі ми будемо використовувати набори даних, які представляють сервіс з доставки продуктів. Тут зберігається документація, котра допоможе розібратися з ними. У таблиці продемонстровані зв'язки між таблицями, а також опис даних.


```{mermaid}
erDiagram
    orders }|..|{ products : product_ids-product_id
    orders }|..|{ courier_actions : order_id
    users }|..|{ user_actions : user_id
    user_actions }|..|{ orders : order_id
    user_actions }|..|{ courier_actions : time
    courier_actions }|..|{ courier : product
    
    users {
        DATE birth_date
        VARCHAR sex
        INT user_id
    }
    user_actions {
        INT user_id
        VARCHAR actions
        INT order_id
        TIMESTAMP time
    }
    orders {
        INT order_id
        ARRAY product_ids
        TIMESTAMP creation_time
    }
    products {
        INT product_id
        NUMERIC price
        VARCHAR name
    }
    courier_actions {
        INT courier_id
        VARCHAR action
        INT order_id
        TIMESTAMP time
    }
    courier {
        INT courier_id
        VARCHAR sex
        DATE birth_date
    }
```

## Типи даних
В таблицях можуть зберігатися різні типи даних: цілі і дробові числа, текст, дати, масиви чисел. У цих даних ви зустрінетесь з наступними типами:

```{python}
#| label: sql-df
#| echo: false

sql_data_types = pd.DataFrame({'Типи даних': ['INT', 'NUMERIC / DECIMAL', 'VARCHAR', 'DATE', 'TIMESTAMP', '[]'],
                                'Опис': ['Ціле число', 'Дійсне число', 'Текст', 'Дата з точністю до дня', 'Дата з точністю до секунди', 'Масив'],
                                'Приклад': ['id користувача: 123', 'Вартість товару: 120.55 ', 'Дія із замовленням: «create_order»', 'Дата народження користувача: 25/03/91', 'Час реєстрації у додатку: 24/08/22 01:52:24', 'Список id товаров у замовленні: [1, 13, 22]']})

user_actions = pd.DataFrame({'Стовпчик': ['user_id', 'order_id', 'action', 'time'],
                                 'Тип даних': ['INT', 'INT', 'VARCHAR(50)', 'TIMESTAMP'],
                                 'Опис': ['id користувача', 'id замовлення', 'дія користувача із замовленням; "create_order" - створення замовлення, "cancel_order" - скасування замовлення', 'час дії']})

courier_actions = pd.DataFrame({'Стовпчик': ['courier_id', 'order_id', 'action', 'time'],
                                 'Тип даних': ['INT', 'INT', 'VARCHAR(50)', 'TIMESTAMP'],
                                 'Опис': ["id кур'єра", 'id замовлення', "дія кур'єра із замовленням; 'accept order' - прийняття замовлення, 'deliver order' - доставка замовлення", 'час дії']})

orders = pd.DataFrame({'Стовпчик': ['order_id', 'creation_time', 'product_ids'],
                                 'Тип даних': ['INT', 'TIMESTAMP', 'integer[]'],
                                 'Опис': ["id замовлення", 'час створення замовлення', "список id товарів у замовленні"]})

users = pd.DataFrame({'Стовпчик': ['user_id', 'birth_date', 'sex'],
                                 'Тип даних': ['INT', 'DATE', 'VARCHAR(50)'],
                                 'Опис': ["id користувача", 'дата народження', "стать"]})

couriers = pd.DataFrame({'Стовпчик': ['courier_id', 'birth_date', 'sex'],
                                 'Тип даних': ['INT', 'DATE', 'VARCHAR(50)'],
                                 'Опис': ["id кур'єра", 'дата народження', "стать"]})

products = pd.DataFrame({'Стовпчик': ['product_id', 'name', 'price'],
                                 'Тип даних': ['INT', 'VARCHAR(50)', '	FLOAT(4)'],
                                 'Опис': ["id продукту", 'назва товару', "ціна товару"]})
```


```{r}
#| label: sql-data-types
#| echo: false
py$sql_data_types
```

Більш детально почитати про типи даних можна за [посиланням](https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-data-types/)

## Структура та наповнення таблиць

`user_actions` – дії користувачів із замовленнями.
```{r}
#| label: sql-user-actions
#| echo: false
py$user_actions
```

`courier_actions` – дії кур'єрів із замовленнями.
```{r}
#| label: sql-courier-actions
#| echo: false
py$courier_actions
```

`orders` - інформація про замовлення.
```{r}
#| label: sql-orders
#| echo: false
py$orders
```

`users` - інформація про користувачів.
```{r}
#| label: sql-users
#| echo: false
py$users
```

`couriers` - інформація про кур'єрів.
```{r}
#| label: sql-couriers
#| echo: false
py$couriers
```

`products` - інформація про товари, які доставляє сервіс.
```{r}
#| label: sql-products
#| echo: false
py$products
```

::: {.callout-note}
У дужках типу `VARCHAR` вказано максимально допустиму кількість символів у тексті. У типу даних `NUMERIC` у дужках вказано загальну кількість символів.
:::